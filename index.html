<!DOCTYPE html>
<html lang="es" class="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catastro Extintores Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* ===== CATASTRO EXTINTORES - ESTILOS COMPLETOS ===== */

        /* Variables CSS para temas */
        :root {
            /* Colores Principales */
            --color-primary: #2563eb;
            --color-primary-light: #3b82f6;
            --color-primary-dark: #1d4ed8;
            --color-secondary: #6366f1;

            /* Colores de Estado */
            --color-success: #10b981;
            --color-success-light: #d1fae5;
            --color-success-dark: #059669;

            --color-warning: #f59e0b;
            --color-warning-light: #fef3c7;
            --color-warning-dark: #d97706;

            --color-danger: #ef4444;
            --color-danger-light: #fee2e2;
            --color-danger-dark: #dc2626;

            --color-info: #0ea5e9;
            --color-info-light: #e0f2fe;
            --color-info-dark: #0284c7;

            /* Colores de Tema */
            --color-background: #f8fafc;
            --color-surface: #ffffff;
            --color-card: #ffffff;
            --color-border: #e2e8f0;
            --color-text: #1e293b;
            --color-text-secondary: #64748b;
            --color-text-muted: #94a3b8;

            /* Efectos */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            --border-radius-sm: 0.125rem;
            --border-radius: 0.25rem;
            --border-radius-md: 0.375rem;
            --border-radius-lg: 0.5rem;
            --border-radius-xl: 0.75rem;
            --border-radius-2xl: 1rem;
            --border-radius-3xl: 1.5rem;
            --border-radius-full: 9999px;

            --transition-fast: 150ms;
            --transition-normal: 300ms;
            --transition-slow: 500ms;
        }

        /* Tema Oscuro */
        html.dark {
            --color-primary: #3b82f6;
            --color-primary-light: #60a5fa;
            --color-primary-dark: #2563eb;
            --color-secondary: #818cf8;

            --color-success: #34d399;
            --color-success-light: #064e3b;
            --color-success-dark: #10b981;

            --color-warning: #fbbf24;
            --color-warning-light: #78350f;
            --color-warning-dark: #f59e0b;

            --color-danger: #f87171;
            --color-danger-light: #7f1d1d;
            --color-danger-dark: #ef4444;

            --color-info: #38bdf8;
            --color-info-light: #0c4a6e;
            --color-info-dark: #0ea5e9;

            --color-background: #0f172a;
            --color-surface: #1e293b;
            --color-card: #1e293b;
            --color-border: #334155;
            --color-text: #f1f5f9;
            --color-text-secondary: #cbd5e1;
            --color-text-muted: #94a3b8;

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }

        /* Estilos Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Layout Principal */
        .flex {
            display: flex;
        }

        .h-screen {
            height: 100vh;
        }

        .overflow-hidden {
            overflow: hidden;
        }

        /* Sidebar */
        #sidebar {
            background-color: #1e293b;
            color: #f8fafc;
            width: 16rem;
            height: 100%;
            position: fixed;
            z-index: 40;
            left: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease-in-out;
        }

        #sidebar.open {
            transform: translateX(0);
        }

        .dark #sidebar {
            background-color: #0f172a;
        }

        @media (max-width: 1023px) {
            #sidebar {
                transform: translateX(-100%);
            }
        }

        /* Logo y encabezado del sidebar */
        #sidebar .p-5 {
            padding: 1.25rem;
        }

        #sidebar .border-b {
            border-bottom-width: 1px;
            border-bottom-style: solid;
            border-bottom-color: #334155;
        }

        .dark #sidebar .border-b {
            border-bottom-color: #1e293b;
        }

        #sidebar .flex.items-center.justify-between {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #sidebar .flex.items-center.space-x-3 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        #sidebar .text-xl.font-bold {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }

        #sidebar .text-blue-400 {
            color: #60a5fa;
        }

        /* Navegación en sidebar */
        #sidebar nav {
            padding: 1rem 1rem;
            flex-grow: 1;
            overflow-y: auto;
        }

        #sidebar nav ul.space-y-1 {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        #sidebar .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius-lg);
            color: white;
            text-decoration: none;
            transition: background-color 0.2s ease;
        }

        #sidebar .nav-link:hover {
            background-color: #2563eb;
        }

        #sidebar .nav-link.bg-blue-700 {
            background-color: #1d4ed8;
        }

        #sidebar .nav-link svg {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.75rem;
            color: #93c5fd;
        }

        #sidebar .nav-link:hover svg {
            color: white;
        }

        /* Separador en navegación */
        #sidebar .border-t {
            border-top-width: 1px;
            border-top-style: solid;
            border-top-color: #334155;
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .dark #sidebar .border-t {
            border-top-color: #1e293b;
        }

        /* Badge de alertas */
        #sidebar #alertas-badge {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background-color: #ef4444;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            animation: pulse 2s infinite;
        }

        /* Overlay para sidebar en móvil */
        #sidebar-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
        }

        /* Header Principal */
        header {
            background-color: white;
            box-shadow: var(--shadow-sm);
            z-index: 20;
            position: relative;
        }

        .dark header {
            background-color: #1e293b;
            border-bottom: 1px solid #334155;
        }

        header .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        header .py-4 {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        header .flex.items-center.justify-between {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Botón de menú para móvil */
        #menu-button {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            display: none;
        }

        .dark #menu-button {
            color: #94a3b8;
        }

        #menu-button:hover {
            color: #475569;
        }

        .dark #menu-button:hover {
            color: #cbd5e1;
        }

        @media (max-width: 1023px) {
            #menu-button {
                display: inline-flex;
                margin-right: 0.5rem;
            }
        }

        /* Título de la vista */
        #view-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .dark #view-title {
            color: #f8fafc;
        }

        /* Notificaciones y acciones rápidas */
        .relative {
            position: relative;
        }

        #notifications-menu-button,
        #quick-actions-button {
            background: none;
            border: none;
            cursor: pointer;
            color: #64748b;
            display: flex;
            align-items: center;
        }

        .dark #notifications-menu-button,
        .dark #quick-actions-button {
            color: #94a3b8;
        }

        #notification-badge {
            position: absolute;
            top: -0.25rem;
            right: -0.25rem;
            height: 1.25rem;
            width: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ef4444;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 9999px;
            animation: pulse 2s infinite;
        }

        /* Dropdowns */
        #notifications-dropdown,
        #quick-actions-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            width: 20rem;
            background-color: white;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-border);
            z-index: 50;
        }

        .dark #notifications-dropdown,
        .dark #quick-actions-dropdown {
            background-color: #1e293b;
            border-color: #334155;
        }

        /* Contenido principal */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--color-background);
        }

        main .overflow-y-auto {
            overflow-y: auto;
        }

        main .p-4 {
            padding: 1rem;
        }

        @media (min-width: 768px) {
            main .md\:p-6 {
                padding: 1.5rem;
            }
        }

        /* Vista Dashboard */
        #dashboard-view .space-y-6 {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Encabezado de Dashboard */
        #dashboard-view .flex.flex-col.sm\:flex-row.justify-between.items-center.gap-4 {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        @media (min-width: 640px) {
            #dashboard-view .flex.flex-col.sm\:flex-row.justify-between.items-center.gap-4 {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        #dashboard-view h1.text-2xl.font-bold {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-text);
        }

        #dashboard-view p.text-sm.text-gray-500 {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }

        /* Filtros de Dashboard */
        #dashboard-view .flex.flex-wrap.items-center.gap-3 {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.75rem;
        }

        #dashboard-view .flex.items-center.space-x-2 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #dashboard-view label.text-sm.font-medium {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text);
        }

        .dark #dashboard-view label.text-sm.font-medium {
            color: var(--color-text-secondary);
        }

        /* KPI Cards */
        .grid.grid-cols-1.sm\:grid-cols-2.lg\:grid-cols-4.gap-4 {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr));
            gap: 1rem;
        }

        @media (min-width: 640px) {
            .grid.grid-cols-1.sm\:grid-cols-2.lg\:grid-cols-4.gap-4 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (min-width: 1024px) {
            .grid.grid-cols-1.sm\:grid-cols-2.lg\:grid-cols-4.gap-4 {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }

        @media (min-width: 768px) {
            .grid.grid-cols-1.sm\:grid-cols-2.lg\:grid-cols-4.gap-4.md\:gap-6 {
                gap: 1.5rem;
            }
        }

        .kpi-card {
            position: relative;
            border-radius: var(--border-radius-xl);
            overflow: hidden;
            background-color: var(--color-card);
            box-shadow: var(--shadow-lg);
            padding: 1.25rem;
            border: 1px solid var(--color-border);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .kpi-card:hover {
            transform: translateY(-0.125rem);
            box-shadow: var(--shadow-xl);
        }

        .kpi-card.border-l-4 {
            border-left-width: 4px;
        }

        .kpi-card.border-l-blue-500 {
            border-left-color: var(--color-primary);
        }

        .kpi-card.border-l-amber-500 {
            border-left-color: var(--color-warning);
        }

        .kpi-card.border-l-red-500 {
            border-left-color: var(--color-danger);
        }

        .kpi-card.border-l-green-500 {
            border-left-color: var(--color-success);
        }

        .kpi-card .kpi-icon {
            position: absolute;
            top: 1.25rem;
            right: 1.25rem;
            opacity: 0.2;
        }

        .kpi-card .kpi-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text-secondary);
        }

        .kpi-card .kpi-value {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--color-text);
            margin-bottom: 0.25rem;
        }

        .kpi-card .kpi-value.text-amber-600 {
            color: var(--color-warning);
        }

        .dark .kpi-card .kpi-value.text-amber-400 {
            color: var(--color-warning-dark);
        }

        .kpi-card .kpi-value.text-red-600 {
            color: var(--color-danger);
        }

        .dark .kpi-card .kpi-value.text-red-400 {
            color: var(--color-danger-dark);
        }

        .kpi-card .kpi-value.text-green-600 {
            color: var(--color-success);
        }

        .dark .kpi-card .kpi-value.text-green-400 {
            color: var(--color-success-dark);
        }

        .kpi-card .kpi-trend {
            margin-top: 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .kpi-card .kpi-trend.kpi-trend-up {
            color: var(--color-success);
        }

        .kpi-card .kpi-trend.kpi-trend-down {
            color: var(--color-danger);
        }

        /* Secciones de Cards */
        .card {
            background-color: var(--color-card);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-lg);
            padding: 1.25rem;
            border: 1px solid var(--color-border);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-0.125rem);
            box-shadow: var(--shadow-xl);
        }

        /* Encabezados de sección */
        .card h3.text-lg.font-semibold {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 1rem;
        }

        .dark .card h3.text-lg.font-semibold {
            color: var(--color-text);
        }

        /* Layout de secciones gráfico/contenido */
        .grid.grid-cols-1.lg\:grid-cols-5.gap-6 {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr));
            gap: 1.5rem;
        }

        @media (min-width: 1024px) {
            .grid.grid-cols-1.lg\:grid-cols-5.gap-6 {
                grid-template-columns: repeat(5, minmax(0, 1fr));
            }

            .lg\:col-span-3 {
                grid-column: span 3 / span 3;
            }

            .lg\:col-span-2 {
                grid-column: span 2 / span 2;
            }
        }

        /* Contenedor de gráfico */
        .h-72 {
            height: 18rem;
        }

        /* Gráficos */
        canvas#extintorEstadoChart,
        canvas#terminalDistribucionChart,
        canvas#inspeccionTendenciaChart,
        canvas#necesidadesTipoChart,
        canvas#vencimientosProyectadosChart {
            width: 100%;
            height: 100%;
        }

        /* Tabla de actividad reciente */
        .overflow-x-auto {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        table th {
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background-color: #f8fafc;
            border-bottom: 1px solid var(--color-border);
        }

        .dark table th {
            background-color: #0f172a;
            color: var(--color-text-secondary);
            border-bottom-color: var(--color-border);
        }

        table td {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: var(--color-text);
            border-bottom: 1px solid var(--color-border);
        }

        .dark table td {
            color: var(--color-text-secondary);
            border-bottom-color: var(--color-border);
        }

        /* Estilos estado OK/Sin Extintor */
        .bg-green-100 {
            background-color: var(--color-success-light);
        }

        .text-green-800 {
            color: var(--color-success-dark);
        }

        .dark .bg-green-900\/50 {
            background-color: rgba(6, 78, 59, 0.5);
        }

        .dark .text-green-300 {
            color: var(--color-success);
        }

        .bg-red-100 {
            background-color: var(--color-danger-light);
        }

        .text-red-800 {
            color: var(--color-danger-dark);
        }

        .dark .bg-red-900\/50 {
            background-color: rgba(127, 29, 29, 0.5);
        }

        .dark .text-red-300 {
            color: var(--color-danger);
        }

        /* Badges y estados */
        .px-2.py-1.text-xs.rounded-full {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Sección de próximos vencimientos */
        #proximos-vencimientos-container .space-y-3 {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .border.bg-red-100 {
            background-color: var(--color-danger-light);
            border: 1px solid #fca5a5;
        }

        .dark .border.bg-red-900\/30 {
            background-color: rgba(127, 29, 29, 0.3);
            border: 1px solid #b91c1c;
        }

        .border.bg-amber-100 {
            background-color: var(--color-warning-light);
            border: 1px solid #fcd34d;
        }

        .dark .border.bg-amber-900\/30 {
            background-color: rgba(120, 53, 15, 0.3);
            border: 1px solid #b45309;
        }

        .border.bg-blue-100 {
            background-color: var(--color-info-light);
            border: 1px solid #93c5fd;
        }

        .dark .border.bg-blue-900\/30 {
            background-color: rgba(12, 74, 110, 0.3);
            border: 1px solid #0369a1;
        }

        .border.bg-gray-100 {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
        }

        .dark .border.bg-gray-800 {
            background-color: #1f2937;
            border: 1px solid #4b5563;
        }

        /* Cards de necesidades críticas */
        .report-card {
            position: relative;
            padding: 1rem;
            background-color: var(--color-card);
            border-radius: var(--border-radius-xl);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-md);
        }

        .report-card.bg-red-50 {
            background-color: var(--color-danger-light);
            border-left: 4px solid var(--color-danger);
        }

        .dark .report-card.bg-red-900\/10 {
            background-color: rgba(127, 29, 29, 0.1);
            border-left: 4px solid var(--color-danger);
        }

        .report-card.bg-amber-50 {
            background-color: var(--color-warning-light);
            border-left: 4px solid var(--color-warning);
        }

        .dark .report-card.bg-amber-900\/10 {
            background-color: rgba(120, 53, 15, 0.1);
            border-left: 4px solid var(--color-warning);
        }

        /* Animaciones y efectos */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(1.25rem);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }

        .animate-slideIn {
            animation: slideIn 0.5s ease-out;
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Loading spinner */
        .loading-spinner {
            width: 1.25rem;
            height: 1.25rem;
            border: 0.1875rem solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: rgba(59, 130, 246, 1);
            animation: spinner 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spinner {
            to {
                transform: rotate(360deg);
            }
        }

        /* Vue de Estado Flota */
        #flota-view .space-y-6 {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Formulario Registro */
        #registro-form .space-y-8 {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        #registro-form .grid.grid-cols-1.md\:grid-cols-2.gap-6 {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr));
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            #registro-form .grid.grid-cols-1.md\:grid-cols-2.gap-6 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        #registro-form .space-y-6 {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        #registro-form .space-y-4 {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        #registro-form fieldset {
            border: none;
        }

        #registro-form legend {
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--color-text);
            margin-bottom: 1rem;
        }

        .dark #registro-form legend {
            color: white;
        }

        /* Entradas de formulario */
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text);
            margin-bottom: 0.25rem;
        }

        .dark .form-label {
            color: var(--color-text-secondary);
        }

        .form-control,
        .form-select {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--color-border);
            background-color: var(--color-card);
            color: var(--color-text);
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .dark .form-control,
        .dark .form-select {
            background-color: var(--color-surface);
            border-color: var(--color-border);
            color: var(--color-text);
        }

        .form-control:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
        }

        .dark .form-control:focus,
        .dark .form-select:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
        }

        .form-control:disabled,
        .form-select:disabled {
            background-color: #f3f4f6;
            opacity: 0.65;
            cursor: not-allowed;
        }

        .dark .form-control:disabled,
        .dark .form-select:disabled {
            background-color: #1f2937;
        }

        /* Botones */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            user-select: none;
            border: 1px solid transparent;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            line-height: 1.5;
            border-radius: var(--border-radius);
            transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            cursor: pointer;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: var(--border-radius-sm);
        }

        .btn-primary {
            color: white;
            background-color: var(--color-primary);
            border-color: var(--color-primary-dark);
        }

        .btn-primary:hover {
            background-color: var(--color-primary-dark);
            border-color: var(--color-primary-dark);
        }

        .btn-secondary {
            color: white;
            background-color: var(--color-secondary);
            border-color: var(--color-secondary);
        }

        .btn-secondary:hover {
            background-color: #4f46e5;
            border-color: #4338ca;
        }

        .btn-light {
            color: #1e293b;
            background-color: #f8fafc;
            border-color: #e2e8f0;
        }

        .btn-light:hover {
            background-color: #e2e8f0;
            border-color: #cbd5e1;
        }

        .dark .btn-light {
            color: #f1f5f9;
            background-color: #334155;
            border-color: #475569;
        }

        .dark .btn-light:hover {
            background-color: #475569;
            border-color: #64748b;
        }

        .btn:disabled,
        .btn.disabled {
            opacity: 0.65;
            pointer-events: none;
        }

        /* Radio y checkbox */
        input[type="radio"],
        input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            color: var(--color-primary);
            border: 1px solid var(--color-border);
            border-radius: 0.25rem;
            background-color: var(--color-card);
        }

        input[type="radio"] {
            border-radius: 50%;
        }

        .dark input[type="radio"],
        .dark input[type="checkbox"] {
            background-color: var(--color-surface);
            border-color: var(--color-border);
        }

        input[type="radio"]:checked,
        input[type="checkbox"]:checked {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
        }

        /* Dropdown específico */
        #notifications-dropdown,
        #quick-actions-dropdown {
            display: none;
        }

        #notifications-dropdown.block,
        #quick-actions-dropdown.block {
            display: block;
        }

        /* Animación para notificaciones */
        @keyframes alertBlink {

            0%,
            50%,
            100% {
                opacity: 1;
            }

            25%,
            75% {
                opacity: 0.7;
            }
        }

        .alert-new {
            animation: alertBlink 2s ease-in-out 2;
        }

        /* Vista de reportes */
        #reportes-view .space-y-6 {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Vista de configuración */
        #configuracion-view .space-y-6 {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Vista de alertas */
        #alertas-view .space-y-6 {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background-color: var(--color-card);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 28rem;
            margin: 0 auto;
            padding: 1.25rem;
            transform: translateY(1.25rem);
            transition: transform 0.3s ease-out;
        }

        .dark .modal-content {
            background-color: var(--color-surface);
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        /* Notificación toast */
        #bus-already-inspected-toast {
            position: fixed;
            bottom: 1.25rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
        }

        /* Contenedor de notificaciones */
        #notification-container {
            position: fixed;
            bottom: 1.25rem;
            right: 1.25rem;
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Botón flotante móvil */
        .floating-action-btn {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 3.5rem;
            height: 3.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            background-color: var(--color-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.5);
            z-index: 30;
            transition: all 0.3s;
        }

        .floating-action-btn:hover {
            transform: translateY(-0.125rem);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.6);
            background-color: var(--color-primary-dark);
        }

        .dark .floating-action-btn {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .dark .floating-action-btn:hover {
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        @media (min-width: 768px) {
            .md\:hidden {
                display: none;
            }
        }

        /* Tooltip personalizado */
        .info-tooltip {
            position: relative;
            display: inline-flex;
            vertical-align: middle;
        }

        .info-tooltip .info-content {
            visibility: hidden;
            width: 15rem;
            background-color: #1e293b;
            color: #f8fafc;
            text-align: left;
            border-radius: var(--border-radius);
            padding: 0.625rem 0.875rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -7.5rem;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: var(--shadow-lg);
            font-size: 0.75rem;
            line-height: 1.2;
            pointer-events: none;
        }

        .info-tooltip .info-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -0.3125rem;
            border-width: 0.3125rem;
            border-style: solid;
            border-color: #1e293b transparent transparent transparent;
        }

        .info-tooltip:hover .info-content {
            visibility: visible;
            opacity: 1;
            pointer-events: auto;
        }

        .dark .info-tooltip .info-content {
            background-color: #334155;
        }

        .dark .info-tooltip .info-content::after {
            border-color: #334155 transparent transparent transparent;
        }

        /* Estilos para la sección de próximos vencimientos */
        .rounded-lg {
            border-radius: var(--border-radius-lg);
        }

        .p-3 {
            padding: 0.75rem;
        }

        .p-4 {
            padding: 1rem;
        }

        .flex.items-start {
            display: flex;
            align-items: flex-start;
        }

        .flex-shrink-0 {
            flex-shrink: 0;
        }

        .ml-3 {
            margin-left: 0.75rem;
        }

        .flex-1 {
            flex: 1 1 0%;
        }

        .inline-flex.items-center {
            display: inline-flex;
            align-items: center;
        }

        .font-medium {
            font-weight: 500;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-xs {
            font-size: 0.75rem;
        }

        /* Botones de Ver Detalles */
        .text-blue-600 {
            color: var(--color-primary);
        }

        .dark .text-blue-400 {
            color: var(--color-primary-light);
        }

        .hover\:text-blue-900:hover {
            color: var(--color-primary-dark);
        }

        .dark .hover\:text-blue-300:hover {
            color: #93c5fd;
        }

        /* Columna vencimientos */
        .text-red-600 {
            color: var(--color-danger);
        }

        .dark .text-red-400 {
            color: var(--color-danger-dark);
        }

        /* Estilo para campos "Sin Extintor" */
        .sin-extintor {
            font-weight: 500;
            color: var(--color-danger);
        }

        .dark .sin-extintor {
            color: var(--color-danger-dark);
        }

        /* Botones de Exportar y Acciones */
        .btn.flex.items-center svg {
            margin-right: 0.25rem;
            width: 1rem;
            height: 1rem;
        }

        /* Estado específico para dispositivos móviles */
        @media (max-width: 640px) {
            .card {
                padding: 1rem;
                border-radius: var(--border-radius-lg);
                box-shadow: var(--shadow-md);
            }

            .kpi-card {
                padding: 0.75rem 1rem;
            }

            .kpi-card .kpi-value {
                font-size: 1.5rem;
            }

            .floating-action-btn {
                width: 3rem;
                height: 3rem;
                bottom: 1rem;
                right: 1rem;
            }

            .btn {
                padding: 0.625rem 1rem;
                font-size: 0.875rem;
            }
        }

        /* Estados para tablas y listas */
        .whitespace-nowrap {
            white-space: nowrap;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .font-bold {
            font-weight: 700;
        }

        .capitalize {
            text-transform: capitalize;
        }

        .w-full {
            width: 100%;
        }

        /* Visibilidad */
        .hidden {
            display: none;
        }

        .block {
            display: block;
        }

        /* Interactividad */
        .cursor-pointer {
            cursor: pointer;
        }

        /* Espaciado adicional */
        .mb-1 {
            margin-bottom: 0.25rem;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-3 {
            margin-bottom: 0.75rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mt-1 {
            margin-top: 0.25rem;
        }

        .mt-2 {
            margin-top: 0.5rem;
        }

        .mt-3 {
            margin-top: 0.75rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .ml-1 {
            margin-left: 0.25rem;
        }

        .ml-2 {
            margin-left: 0.5rem;
        }

        .mr-1 {
            margin-right: 0.25rem;
        }

        .mr-2 {
            margin-right: 0.5rem;
        }

        /* Tipografía */
        .text-gray-400 {
            color: #9ca3af;
        }

        .text-gray-500 {
            color: #6b7280;
        }

        .text-gray-600 {
            color: #4b5563;
        }

        .text-gray-700 {
            color: #374151;
        }

        .text-gray-800 {
            color: #1f2937;
        }

        .text-gray-900 {
            color: #111827;
        }

        .dark .text-gray-300 {
            color: #d1d5db;
        }

        .dark .text-gray-400 {
            color: #9ca3af;
        }

        .dark .text-gray-500 {
            color: #6b7280;
        }

        .dark .text-gray-600 {
            color: #4b5563;
        }

        /* Bordes y Separadores */
        .border-t {
            border-top-width: 1px;
            border-top-style: solid;
            border-top-color: var(--color-border);
        }

        .border-b {
            border-bottom-width: 1px;
            border-bottom-style: solid;
            border-bottom-color: var(--color-border);
        }

        .border-l {
            border-left-width: 1px;
            border-left-style: solid;
            border-left-color: var(--color-border);
        }

        .border-r {
            border-right-width: 1px;
            border-right-style: solid;
            border-right-color: var(--color-border);
        }

        .pt-4 {
            padding-top: 1rem;
        }

        .pt-6 {
            padding-top: 1.5rem;
        }

        .pb-1 {
            padding-bottom: 0.25rem;
        }

        .pb-2 {
            padding-bottom: 0.5rem;
        }

        .pb-3 {
            padding-bottom: 0.75rem;
        }

        .pb-4 {
            padding-bottom: 1rem;
        }

        /* Media query para impresión */
        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background-color: white;
                color: black;
            }

            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }

            .container {
                max-width: 100%;
                width: 100%;
            }

            header,
            #sidebar,
            #sidebar-overlay,
            #mobile-quick-add {
                display: none !important;
            }

            main {
                margin: 0;
                padding: 0;
            }
        }

        /* Selects personalizados */
        select.form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        .dark select.form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }

        /* Botones de exportar */
        button[id$="export-button"] {
            display: inline-flex;
            align-items: center;
        }

        button[id$="export-button"] svg {
            margin-right: 0.25rem;
            width: 1rem;
            height: 1rem;
        }

        /* Estilos específicos para necesidades críticas */
        .necesidades-card {
            display: flex;
            align-items: flex-start;
            padding: 1rem;
            border-radius: var(--border-radius-lg);
            background-color: var(--color-card);
            box-shadow: var(--shadow-md);
            margin-bottom: 1rem;
            border-left: 4px solid;
        }

        .necesidades-card.compra {
            border-left-color: var(--color-danger);
            background-color: var(--color-danger-light);
        }

        .dark .necesidades-card.compra {
            background-color: rgba(127, 29, 29, 0.1);
        }

        .necesidades-card.mantencion {
            border-left-color: var(--color-warning);
            background-color: var(--color-warning-light);
        }

        .dark .necesidades-card.mantencion {
            background-color: rgba(120, 53, 15, 0.1);
        }

        /* Estilos para fechas de vencimiento */
        .vencido {
            color: var(--color-danger);
            font-weight: 500;
        }

        .dark .vencido {
            color: var(--color-danger-dark);
        }

        /* Responsive para gráficos */
        @media (max-width: 767px) {
            .h-72 {
                height: 14rem;
            }
        }

        /* Ajustes generales de tema */
        .text-white {
            color: white;
        }

        .bg-white {
            background-color: white;
        }

        .dark .bg-gray-800 {
            background-color: #1f2937;
        }

        .dark .text-white {
            color: white;
        }

        /* Utilidades de Tailwind comunes */
        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-end {
            justify-content: flex-end;
        }

        .space-x-2>*+* {
            margin-left: 0.5rem;
        }

        .space-x-3>*+* {
            margin-left: 0.75rem;
        }

        .space-x-4>*+* {
            margin-left: 1rem;
        }

        .space-y-2>*+* {
            margin-top: 0.5rem;
        }

        .space-y-3>*+* {
            margin-top: 0.75rem;
        }

        .space-y-4>*+* {
            margin-top: 1rem;
        }

        .rounded {
            border-radius: var(--border-radius);
        }

        .rounded-md {
            border-radius: var(--border-radius-md);
        }

        .rounded-full {
            border-radius: 9999px;
        }

        .shadow {
            box-shadow: var(--shadow);
        }

        .shadow-md {
            box-shadow: var(--shadow-md);
        }

        .shadow-lg {
            box-shadow: var(--shadow-lg);
        }

        .shadow-xl {
            box-shadow: var(--shadow-xl);
        }

        .overflow-hidden {
            overflow: hidden;
        }

        .uppercase {
            text-transform: uppercase;
        }

        .capitalize {
            text-transform: capitalize;
        }

        .tracking-wider {
            letter-spacing: 0.05em;
        }

        .transition {
            transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        /* Ajustes específicos para la imagen de ejemplo de dashboard */
        .terminal {
            text-transform: uppercase;
            font-weight: 500;
        }

        .fecha {
            white-space: nowrap;
        }

        .hora {
            color: var(--color-text-secondary);
            font-size: 0.75rem;
        }

        .ver-detalles {
            color: var(--color-primary);
            font-size: 0.75rem;
            font-weight: 500;
            text-decoration: none;
        }

        .ver-detalles:hover {
            color: var(--color-primary-dark);
            text-decoration: underline;
        }

        .dark .ver-detalles {
            color: var(--color-primary-light);
        }

        .dark .ver-detalles:hover {
            color: #93c5fd;
        }
    </style>
</head>

<body class="min-h-screen">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="bg-gray-900 dark:bg-gray-950 text-white transition-all duration-300 ease-in-out z-40">
            <div class="flex flex-col h-full">
                <div class="p-5 border-b border-gray-800 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z"
                                    clip-rule="evenodd" />
                            </svg>
                            <h1 class="text-xl font-bold text-white">Catastro<span class="text-blue-400">Pro</span></h1>
                        </div>
                        <button id="sidebar-close"
                            class="lg:hidden rounded-md p-2 hover:bg-gray-800 focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="py-4 flex-grow overflow-y-auto">
                    <nav class="px-4 space-y-1">
                        <a href="#" data-view="dashboard"
                            class="nav-link flex items-center px-4 py-3 text-white rounded-lg transition-colors hover:bg-blue-700 group">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5 mr-3 text-blue-300 group-hover:text-white" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path
                                    d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM14 11a1 1 0 011 1v1h1a1 1 0 110 2h-1v1a1 1 0 11-2 0v-1h-1a1 1 0 110-2h1v-1a1 1 0 011-1z" />
                            </svg>
                            <span>Dashboard</span>
                        </a>
                        <a href="#" data-view="registrar"
                            class="nav-link flex items-center px-4 py-3 text-white rounded-lg transition-colors hover:bg-blue-700 group">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5 mr-3 text-blue-300 group-hover:text-white" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path
                                    d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                            <span>Registrar Inspección</span>
                        </a>
                        <a href="#" data-view="lista"
                            class="nav-link flex items-center px-4 py-3 text-white rounded-lg transition-colors hover:bg-blue-700 group">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5 mr-3 text-blue-300 group-hover:text-white" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                                <path fill-rule="evenodd"
                                    d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>Historial Inspecciones</span>
                        </a>
                        <a href="#" data-view="flota"
                            class="nav-link flex items-center px-4 py-3 text-white rounded-lg transition-colors hover:bg-blue-700 group">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5 mr-3 text-blue-300 group-hover:text-white" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path
                                    d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
                                <path
                                    d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1v-1h4.05a2.5 2.5 0 014.9 0H20a1 1 0 001-1V5a1 1 0 00-1-1H3z" />
                            </svg>
                            <span>Estado Flota</span>
                        </a>
                        <a href="#" data-view="analisis"
                            class="nav-link flex items-center px-4 py-3 text-white rounded-lg transition-colors hover:bg-blue-700 group">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5 mr-3 text-blue-300 group-hover:text-white" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11 4a1 1 0 10-2 0v4a1 1 0 102 0V7zm-3 1a1 1 0 10-2 0v3a1 1 0 102 0V8zM8 9a1 1 0 00-2 0v2a1 1 0 102 0V9z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>Análisis Avanzado</span>
                        </a>
                        <a href="#" data-view="reportes"
                            class="nav-link flex items-center px-4 py-3 text-white rounded-lg transition-colors hover:bg-blue-700 group">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5 mr-3 text-blue-300 group-hover:text-white" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm2 10a1 1 0 10-2 0v3a1 1 0 102 0v-3zm2-3a1 1 0 011 1v5a1 1 0 11-2 0v-5a1 1 0 011-1zm4-1a1 1 0 10-2 0v7a1 1 0 102 0V8z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>Reportes</span>
                        </a>

                        <!-- Separador -->
                        <div class="border-t border-gray-800 dark:border-gray-700 my-3"></div>

                        <a href="#" data-view="alertas"
                            class="nav-link relative flex items-center px-4 py-3 text-white rounded-lg transition-colors hover:bg-blue-700 group">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5 mr-3 text-blue-300 group-hover:text-white" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>Centro de Alertas</span>
                            <span id="alertas-badge"
                                class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse">0</span>
                        </a>
                        <a href="#" data-view="configuracion"
                            class="nav-link flex items-center px-4 py-3 text-white rounded-lg transition-colors hover:bg-blue-700 group">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5 mr-3 text-blue-300 group-hover:text-white" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>Configuración</span>
                        </a>
                    </nav>
                </div>

                <div class="px-4 py-4 border-t border-gray-800 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div
                                class="bg-blue-500 rounded-full h-8 w-8 flex items-center justify-center text-white font-semibold">
                                AD
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-white">Admin</p>
                                <p class="text-xs text-gray-400">Inspección</p>
                            </div>
                        </div>
                    </div>

                    <button id="theme-toggle"
                        class="w-full flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-gray-800 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-gray-700">
                        <svg id="theme-toggle-dark-icon" class="w-5 h-5 mr-2 hidden" fill="currentColor"
                            viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                        </svg>
                        <svg id="theme-toggle-light-icon" class="w-5 h-5 mr-2 hidden" fill="currentColor"
                            viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                                fill-rule="evenodd" clip-rule="evenodd"></path>
                        </svg>
                        <span id="theme-toggle-text">Cambiar Tema</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Overlay que oscurece el fondo cuando se abre el sidebar en móvil -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>

        <!-- Contenido principal -->
        <div class="relative flex-1 flex flex-col overflow-hidden bg-gray-100 dark:bg-gray-900 lg:ml-64">

            <!-- Header superior -->
            <header class="bg-white dark:bg-gray-800 shadow-sm z-20">
                <div class="px-4 sm:px-6 py-4 flex items-center justify-between">
                    <div class="flex items-center">
                        <button id="menu-button"
                            class="text-gray-500 dark:text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 lg:hidden mr-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </button>
                        <h2 id="view-title" class="text-xl font-semibold text-gray-800 dark:text-white">Dashboard</h2>
                    </div>

                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <button id="notifications-menu-button"
                                class="text-gray-500 hover:text-gray-600 dark:text-gray-400 dark:hover:text-gray-300 focus:outline-none">
                                <span class="sr-only">Notificaciones</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                                </svg>
                                <div id="notification-badge" class="notification-badge hidden">0</div>
                            </button>
                            <!-- Dropdown de notificaciones (oculto por defecto) -->
                            <div id="notifications-dropdown"
                                class="origin-top-right absolute right-0 mt-2 w-80 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none z-50 hidden">
                                <div class="py-2 px-3 border-b border-gray-200 dark:border-gray-700">
                                    <h3 class="text-sm font-semibold text-gray-800 dark:text-white">Notificaciones</h3>
                                </div>
                                <div id="notifications-container" class="max-h-80 overflow-y-auto py-1">
                                    <!-- Aquí se cargarán dinámicamente las notificaciones -->
                                    <div class="text-center py-8 text-gray-500 dark:text-gray-400 text-sm">
                                        No hay notificaciones nuevas
                                    </div>
                                </div>
                                <div class="py-2 px-3 border-t border-gray-200 dark:border-gray-700 text-center">
                                    <a href="#"
                                        class="text-xs font-medium text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300">Ver
                                        todas</a>
                                </div>
                            </div>
                        </div>

                        <span class="h-6 w-px bg-gray-300 dark:bg-gray-700"></span>

                        <div id="quick-actions" class="relative hidden md:block">
                            <button id="quick-actions-button"
                                class="flex items-center space-x-1 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white focus:outline-none">
                                <span>Acciones rápidas</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                            <!-- Dropdown de acciones rápidas (oculto por defecto) -->
                            <div id="quick-actions-dropdown"
                                class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none z-50 hidden">
                                <div class="py-1">
                                    <a href="#"
                                        class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                                        data-action="nueva-inspeccion">Nueva inspección</a>
                                    <a href="#"
                                        class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                                        data-action="generar-reporte">Generar reporte</a>
                                    <a href="#"
                                        class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                                        data-action="ver-alertas">Ver alertas</a>
                                    <a href="#"
                                        class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                                        data-action="exportar-excel">Exportar a Excel</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Contenido principal con scroll -->
            <main class="flex-1 overflow-y-auto bg-gray-100 dark:bg-gray-900 p-4 md:p-6">

                <!-- Vista Dashboard -->
                <div id="dashboard-view" class="view-container space-y-6 animate-fadeIn">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Dashboard Operacional</h1>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Monitoreo en tiempo real del estado
                                de extintores</p>
                        </div>
                        <div class="flex flex-wrap items-center gap-3">
                            <div class="flex items-center space-x-2">
                                <label for="dashboard-filter-periodo"
                                    class="text-sm font-medium text-gray-700 dark:text-gray-300">Período:</label>
                                <select id="dashboard-filter-periodo" class="form-select text-sm py-1.5">
                                    <option value="todo">Todo</option>
                                    <option value="hoy">Hoy</option>
                                    <option value="semana">Esta semana</option>
                                    <option value="mes">Este mes</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="dashboard-filter-terminal"
                                    class="text-sm font-medium text-gray-700 dark:text-gray-300">Terminal:</label>
                                <select id="dashboard-filter-terminal" class="form-select text-sm py-1.5">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <button id="dashboard-refresh" class="btn btn-sm btn-light flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Actualizar
                            </button>
                        </div>
                    </div>

                    <!-- Cards de resumen -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                        <div class="kpi-card border-l-4 border-blue-500">
                            <div class="kpi-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                </svg>
                            </div>
                            <p class="kpi-label">Total Buses OK</p>
                            <h3 id="kpi-ok" class="kpi-value">--</h3>
                            <div id="kpi-ok-trend" class="kpi-trend kpi-trend-up">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 10l7-7m0 0l7 7m-7-7v18" />
                                </svg>
                                <span>2% desde ayer</span>
                            </div>
                        </div>

                        <div class="kpi-card border-l-4 border-amber-500">
                            <div class="kpi-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                            <p class="kpi-label">Requieren Mantención</p>
                            <h3 id="kpi-mantencion" class="kpi-value text-amber-600 dark:text-amber-400">--</h3>
                            <div id="kpi-mantencion-trend" class="kpi-trend kpi-trend-down">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                                </svg>
                                <span>3% desde ayer</span>
                            </div>
                        </div>

                        <div class="kpi-card border-l-4 border-red-500">
                            <div class="kpi-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <p class="kpi-label">Requieren Compra</p>
                            <h3 id="kpi-compra" class="kpi-value text-red-600 dark:text-red-400">--</h3>
                            <div id="kpi-compra-trend" class="kpi-trend">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M20 12H4" />
                                </svg>
                                <span>Sin cambios</span>
                            </div>
                        </div>

                        <div class="kpi-card border-l-4 border-green-500">
                            <div class="kpi-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                </svg>
                                </svg>
                            </div>
                            <p class="kpi-label">Inspecciones Hoy</p>
                            <h3 id="kpi-hoy" class="kpi-value text-green-600 dark:text-green-400">--</h3>
                            <div id="kpi-hoy-trend" class="kpi-trend kpi-trend-up">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 10l7-7m0 0l7 7m-7-7v18" />
                                </svg>
                                <span>5% desde ayer</span>
                            </div>
                        </div>
                    </div>

                    <!-- Estado de Extintores y Próximos Vencimientos -->
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <div class="lg:col-span-3">
                            <div class="card">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Estado General
                                        Extintores</h3>
                                    <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                                        <span id="chart-total-count" class="mr-2">Total: 0</span>
                                        <div class="info-tooltip">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                class="h-5 w-5 text-gray-400 hover:text-gray-600 cursor-help"
                                                viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd"
                                                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z"
                                                    clip-rule="evenodd" />
                                            </svg>
                                            <div class="info-content">
                                                <h4 class="font-semibold mb-1">Estado General Extintores</h4>
                                                <p>Muestra la distribución actual del estado de todos los extintores
                                                    registrados en el sistema.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <div class="max-w-md mx-auto" id="estado-chart-container">

                                        <canvas id="extintorEstadoChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-2">
                            <div class="card">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Próximos
                                        Vencimientos</h3>
                                    <button id="refresh-vencimientos"
                                        class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                        </svg>
                                        Actualizar
                                    </button>
                                </div>
                                <div class="overflow-y-auto max-h-72" id="proximos-vencimientos-container">
                                    <div class="flex items-center justify-center h-72 text-gray-500 dark:text-gray-400">
                                        <div class="text-center">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                class="h-12 w-12 mx-auto mb-2 text-gray-400" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            <p>Cargando próximos vencimientos...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Distribución por Terminal y Actividad Reciente -->
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <div class="lg:col-span-2">
                            <div class="card">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Distribución por
                                    Terminal</h3>
                                <div class="h-72" id="terminal-chart-container">
                                    <canvas id="terminalDistribucionChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-3">
                            <div class="card">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Actividad Reciente
                                    </h3>
                                    <a href="#" data-view="lista"
                                        class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm">Ver
                                        historial completo</a>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-800">
                                            <tr>
                                                <th
                                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                                    Bus</th>
                                                <th
                                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                                    Terminal</th>
                                                <th
                                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                                    Fecha</th>
                                                <th
                                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                                    Estado</th>
                                                <th
                                                    class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                                    Detalles</th>
                                            </tr>
                                        </thead>
                                        <tbody id="actividad-reciente-body"
                                            class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            <tr class="animate-pulse">
                                                <td colspan="5"
                                                    class="px-3 py-10 text-center text-gray-500 dark:text-gray-400">
                                                    Cargando actividad reciente...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen Necesidades de Flota -->
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Necesidades Críticas</h3>
                            <a href="#" data-view="alertas"
                                class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm">Ver
                                todas las alertas</a>
                        </div>
                        <div id="necesidades-container"
                            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                            <div class="animate-pulse flex space-x-4">
                                <div class="flex-1 space-y-4 py-1">
                                    <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
                                    <div class="space-y-2">
                                        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded"></div>
                                        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-5/6"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="animate-pulse flex space-x-4">
                                <div class="flex-1 space-y-4 py-1">
                                    <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
                                    <div class="space-y-2">
                                        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded"></div>
                                        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-5/6"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="animate-pulse flex space-x-4">
                                <div class="flex-1 space-y-4 py-1">
                                    <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
                                    <div class="space-y-2">
                                        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded"></div>
                                        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-5/6"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista Registrar Inspección -->
                <div id="registrar-view" class="view-container hidden space-y-6 animate-fadeIn">
                    <div class="flex justify-between items-center">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Registrar Inspección</h1>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Ingrese los datos de la inspección
                                del extintor</p>
                        </div>
                        <button id="historial-bus-btn" class="btn btn-light" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                                    clip-rule="evenodd" />
                            </svg>
                            Ver historial del bus
                        </button><br>
                    </div>

                    <div class="card">
                        <form id="registro-form" class="space-y-8">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Identificación del Bus -->
                                <div class="space-y-6">
                                    <fieldset class="space-y-4">
                                        <legend class="text-lg font-medium text-gray-900 dark:text-white">Identificación
                                            del Bus</legend>

                                        <div>
                                            <label for="terminal" class="form-label">
                                                Terminal <span class="text-red-500">*</span>
                                            </label>
                                            <select id="terminal" name="terminal" required class="form-select">
                                                <option value="">Seleccione Terminal...</option>
                                            </select>
                                            <div id="terminal-error-container"
                                                class="mt-1 text-xs text-red-600 dark:text-red-400 h-4"></div>
                                        </div>

                                        <div class="relative">
                                            <label for="numero_interno_input" class="form-label">N° Interno</label>
                                            <div class="relative">
                                                <input type="number" id="numero_interno_input"
                                                    name="numero_interno_input" class="form-control pr-10"
                                                    placeholder="Buscar por N° Interno..." autocomplete="off">
                                                <div
                                                    class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                        class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24"
                                                        stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="relative">
                                            <label for="ppu_input" class="form-label">PPU</label>
                                            <div class="relative">
                                                <input type="text" id="ppu_input" name="ppu_input"
                                                    class="form-control uppercase pr-10" placeholder="Buscar por PPU..."
                                                    autocomplete="off">
                                                <div
                                                    class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                        class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24"
                                                        stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                                    </svg>
                                                </div>
                                            </div>
                                            <input type="hidden" id="ppu_hidden" name="ppu" required>
                                            <div id="bus-validation-msg" class="mt-1 text-xs h-4"></div>
                                            <div id="ppu-error-container"
                                                class="mt-1 text-xs text-red-600 dark:text-red-400 h-4"></div>
                                        </div>

                                        <!-- Alerta de bus ya revisado -->
                                        <div id="bus-already-checked"
                                            class="hidden rounded-md bg-blue-50 dark:bg-blue-900/30 p-4 border border-blue-200 dark:border-blue-800 mt-4">
                                            <div class="flex items-start">
                                                <div class="flex-shrink-0">
                                                    <svg class="h-5 w-5 text-blue-600 dark:text-blue-400"
                                                        xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                                        fill="currentColor" aria-hidden="true">
                                                        <path fill-rule="evenodd"
                                                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                                            clip-rule="evenodd" />
                                                    </svg>
                                                </div>
                                                <div class="ml-3 flex-1">
                                                    <h3 class="text-sm font-medium text-blue-800 dark:text-blue-300">Bus
                                                        ya inspeccionado recientemente</h3>
                                                    <div class="mt-2 text-sm text-blue-700 dark:text-blue-200">
                                                        <p>Este bus ya fue inspeccionado el <span
                                                                id="last-inspection-date"
                                                                class="font-semibold">DD/MM/AAAA</span>.</p>
                                                    </div>
                                                    <div class="mt-3 flex space-x-4">
                                                        <button type="button" id="use-previous-data"
                                                            class="btn btn-sm btn-light">
                                                            Usar datos anteriores
                                                        </button>
                                                        <button type="button" id="create-new-inspection"
                                                            class="btn btn-sm btn-primary">
                                                            Crear nueva inspección
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </fieldset>
                                </div>

                                <!-- Fecha y Estado Extintor -->
                                <div class="space-y-6">
                                    <div class="space-y-4">
                                        <div>
                                            <label for="fecha_inspeccion" class="form-label">Fecha de Inspección</label>
                                            <input type="date" id="fecha_inspeccion" name="fecha_inspeccion"
                                                class="form-control" value="" max="">
                                        </div>

                                        <fieldset class="space-y-3">
                                            <legend class="form-label">Extintor Presente <span
                                                    class="text-red-500">*</span></legend>
                                            <div class="flex space-x-4">
                                                <label class="inline-flex items-center">
                                                    <input type="radio" name="extintor_estado" value="Tiene" required
                                                        class="w-4 h-4 text-blue-600 dark:text-blue-500 border-gray-300 dark:border-gray-600 focus:ring-blue-500 dark:focus:ring-blue-400 rounded-full">
                                                    <span
                                                        class="ml-2 text-sm text-gray-700 dark:text-gray-300">Tiene</span>
                                                </label>
                                                <label class="inline-flex items-center">
                                                    <input type="radio" name="extintor_estado" value="No Tiene" required
                                                        class="w-4 h-4 text-blue-600 dark:text-blue-500 border-gray-300 dark:border-gray-600 focus:ring-blue-500 dark:focus:ring-blue-400 rounded-full">
                                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">No
                                                        Tiene</span>
                                                </label>
                                            </div>
                                        </fieldset>
                                    </div>

                                    <div id="foto-extintor-container" class="hidden space-y-2">
                                        <label class="form-label flex items-center justify-between">
                                            <span>Fotografía (Opcional)</span>
                                            <span class="text-xs text-gray-500 dark:text-gray-400">Para mejor
                                                documentación</span>
                                        </label>
                                        <div class="flex items-center justify-center w-full">
                                            <label for="foto_extintor"
                                                class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:bg-gray-700 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600">
                                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                                    <svg class="w-8 h-8 mb-2 text-gray-500 dark:text-gray-400"
                                                        aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                                                        fill="none" viewBox="0 0 20 16">
                                                        <path stroke="currentColor" stroke-linecap="round"
                                                            stroke-linejoin="round" stroke-width="2"
                                                            d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2" />
                                                    </svg>
                                                    <p class="mb-1 text-sm text-gray-500 dark:text-gray-400">Haga clic o
                                                        arrastre para subir</p>
                                                    <p class="text-xs text-gray-500 dark:text-gray-400">PNG, JPG o JPEG
                                                        (MAX. 5MB)</p>
                                                </div>
                                                <input id="foto_extintor" type="file" accept="image/*" class="hidden" />
                                            </label>
                                        </div>
                                        <div id="preview-container" class="hidden mt-2">
                                            <div class="relative">
                                                <img id="preview-image" src="#" alt="Vista previa de la imagen"
                                                    class="h-32 w-full object-cover rounded-lg" />
                                                <button type="button" id="remove-image"
                                                    class="absolute top-2 right-2 bg-red-600 text-white rounded-full p-1 shadow-md hover:bg-red-700 focus:outline-none">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                                        viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Datos del Extintor (Sección visible solo si tiene extintor) -->
                            <div id="extintor-details-container"
                                class="border-t border-gray-200 dark:border-gray-700 pt-6 hidden">
                                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Detalles del Extintor
                                </h3>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4">
                                    <div class="space-y-2">
                                        <label class="form-label">Fecha de Vencimiento</label>
                                        <div class="grid grid-cols-2 gap-2">
                                            <select id="vencimiento_mes" name="vencimiento_mes" class="form-select">
                                                <option value="">Mes</option>
                                            </select>
                                            <select id="vencimiento_ano" name="vencimiento_ano" class="form-select">
                                                <option value="">Año</option>
                                            </select>
                                        </div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Requerido si "Tiene"
                                            extintor</p>
                                    </div>

                                    <div class="space-y-2">
                                        <label for="certificacion_estado" class="form-label flex items-center">
                                            <span>Certificación</span>
                                            <div class="info-tooltip ml-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400"
                                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <div class="info-content">
                                                    <p>Verifica el tipo o estado del sello. 'NO TIENE' si no hay sello.
                                                    </p>
                                                </div>
                                            </div>
                                        </label>
                                        <select id="certificacion_estado" name="certificacion_estado"
                                            class="form-select">
                                            <option value="">Seleccione...</option>
                                            <option value="CESMEC">CESMEC</option>
                                            <option value="INCEN">INCEN</option>
                                            <option value="DAÑADO">DAÑADO</option>
                                            <option value="NO TIENE">NO TIENE</option>
                                        </select>
                                    </div>

                                    <div class="space-y-2">
                                        <label for="sonda_estado" class="form-label flex items-center">
                                            <span>Sonda (Manguera/Boquilla)</span>
                                            <div class="info-tooltip ml-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400"
                                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <div class="info-content">
                                                    <p>Verifica presencia y estado de manguera/boquilla.</p>
                                                </div>
                                            </div>
                                        </label>
                                        <select id="sonda_estado" name="sonda_estado" class="form-select">
                                            <option value="">Seleccione...</option>
                                            <option value="Tiene">Tiene</option>
                                            <option value="No Tiene">No Tiene</option>
                                            <option value="Dañado">Dañado</option>
                                        </select>
                                    </div>

                                    <div class="space-y-2">
                                        <label for="manometro_estado" class="form-label flex items-center">
                                            <span>Manómetro</span>
                                            <div class="info-tooltip ml-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400"
                                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <div class="info-content">
                                                    <p>Verifica indicador de presión. 'Tiene' indica presente y OK (zona
                                                        verde).</p>
                                                </div>
                                            </div>
                                        </label>
                                        <select id="manometro_estado" name="manometro_estado" class="form-select">
                                            <option value="">Seleccione...</option>
                                            <option value="Tiene">Tiene (OK)</option>
                                            <option value="No Tiene">No Tiene</option>
                                            <option value="Dañado">Dañado</option>
                                            <option value="Sobrecargado">Sobrecargado</option>
                                            <option value="Bajacarga">Bajacarga</option>
                                        </select>
                                    </div>

                                    <div class="space-y-2">
                                        <label for="portaextintor_estado" class="form-label flex items-center">
                                            <span>Porta Extintor</span>
                                            <div class="info-tooltip ml-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400"
                                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <div class="info-content">
                                                    <p>Verifica presencia y estado del soporte.</p>
                                                </div>
                                            </div>
                                        </label>
                                        <select id="portaextintor_estado" name="portaextintor_estado"
                                            class="form-select">
                                            <option value="">Seleccione...</option>
                                            <option value="Tiene">Tiene</option>
                                            <option value="No Tiene">No Tiene</option>
                                            <option value="Dañado">Dañado</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Observaciones -->
                            <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                                <div class="space-y-2">
                                    <label for="observaciones" class="form-label">Observaciones Adicionales</label>
                                    <textarea id="observaciones" name="observaciones" rows="3" class="form-control"
                                        placeholder="Añadir comentarios sobre el estado del extintor o detalles adicionales..."></textarea>
                                </div>
                            </div>

                            <!-- Botones de Formulario -->
                            <div
                                class="flex flex-col sm:flex-row justify-end items-center gap-3 border-t border-gray-200 dark:border-gray-700 pt-6">
                                <p id="form-message" class="text-sm font-medium order-2 sm:order-1 flex-grow"></p>
                                <button type="reset"
                                    class="btn btn-light w-full sm:w-auto order-1 sm:order-2">Limpiar</button>
                                <button type="submit" id="submit-button"
                                    class="btn btn-primary w-full sm:w-auto order-1 sm:order-3">
                                    Guardar Inspección
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Vista Lista Historial -->
                <div id="lista-view" class="view-container hidden space-y-6 animate-fadeIn">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Historial de Inspecciones</h1>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Registro completo de todas las
                                inspecciones realizadas</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button id="advanced-filters-toggle" class="btn btn-light">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                                </svg>
                                Filtros
                            </button>
                            <button id="export-lista-button" class="btn btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Exportar
                            </button>
                        </div>
                    </div>

                    <!-- Filtros Avanzados (colapsable) -->
                    <div id="advanced-filters-container" class="card hidden">
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end mb-4">
                            <div>
                                <label for="search-ppu-lista" class="form-label">PPU/N° Interno</label>
                                <input type="text" id="search-ppu-lista" placeholder="Ingrese PPU o N° Interno"
                                    class="form-control">
                            </div>
                            <div>
                                <label for="filter-terminal-lista" class="form-label">Terminal</label>
                                <select id="filter-terminal-lista" class="form-select">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-estado-extintor" class="form-label">Estado Extintor</label>
                                <select id="filter-estado-extintor" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="Tiene">Tiene</option>
                                    <option value="No Tiene">No Tiene</option>
                                    <option value="REQUIERE_MANTENCION">Requiere Mantención</option>
                                    <option value="VENCIDO">Vencido</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-fecha-inicio-lista" class="form-label">Fecha Desde</label>
                                <input type="date" id="filter-fecha-inicio-lista" title="Fecha inicio"
                                    class="form-control">
                            </div>
                            <div>
                                <label for="filter-fecha-fin-lista" class="form-label">Fecha Hasta</label>
                                <input type="date" id="filter-fecha-fin-lista" title="Fecha fin" class="form-control">
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button id="apply-filters-lista-button" class="btn btn-primary">Aplicar Filtros</button>
                        </div>
                    </div>

                    <!-- Tabla de Resultados -->
                    <div class="card p-0 overflow-hidden">
                        <div class="overflow-x-auto relative">
                            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead
                                    class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-800 dark:text-gray-300">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">PPU</th>
                                        <th scope="col" class="px-6 py-3">N° Int</th>
                                        <th scope="col" class="px-6 py-3">Terminal</th>
                                        <th scope="col" class="px-6 py-3">Fecha Insp.</th>
                                        <th scope="col" class="px-6 py-3">Extintor</th>
                                        <th scope="col" class="px-6 py-3">Vence</th>
                                        <th scope="col" class="px-6 py-3">Estado</th>
                                        <th scope="col" class="px-6 py-3 text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="inspecciones-tbody" class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Los datos se cargarán dinámicamente -->
                                    <tr class="animate-pulse">
                                        <td colspan="8" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                                            Cargando historial de inspecciones...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Mensaje de error -->
                        <div id="lista-error-container" class="p-4 text-center text-red-600 dark:text-red-400 hidden">
                        </div>

                        <!-- Paginación -->
                        <div id="pagination-controls"
                            class="px-6 py-3 border-t border-gray-200 dark:border-gray-700 flex flex-col sm:flex-row justify-between items-center text-sm text-gray-600 dark:text-gray-400">
                            <div id="pagination-info" class="mb-3 sm:mb-0">Mostrando 0 a 0 de 0 registros</div>
                            <div class="flex items-center space-x-1">
                                <button id="pagination-prev"
                                    class="btn btn-sm btn-light px-3 disabled:opacity-50 disabled:cursor-not-allowed">&laquo;
                                    Anterior</button>
                                <div id="pagination-numbers" class="flex items-center space-x-1">
                                    <!-- Los números de página se generarán dinámicamente -->
                                </div>
                                <button id="pagination-next"
                                    class="btn btn-sm btn-light px-3 disabled:opacity-50 disabled:cursor-not-allowed">Siguiente
                                    &raquo;</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista Estado Flota -->
                <div id="flota-view" class="view-container hidden space-y-6 animate-fadeIn">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Estado Actual Flota</h1>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Estado actualizado de extintores
                                por bus</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center space-x-2">
                                <label for="flota-filter-terminal"
                                    class="text-sm font-medium text-gray-700 dark:text-gray-300">Terminal:</label>
                                <select id="flota-filter-terminal" class="form-select text-sm py-1.5">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Indicadores de Estado -->
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div class="card flex items-center p-4 border-l-4 border-green-500">
                            <div class="bg-green-100 dark:bg-green-900/30 p-2 rounded-full mr-4">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                    class="h-6 w-6 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Estado OK</h3>
                                <p id="flota-estado-ok" class="text-xl font-bold text-gray-900 dark:text-white">--</p>
                            </div>
                        </div>

                        <div class="card flex items-center p-4 border-l-4 border-amber-500">
                            <div class="bg-amber-100 dark:bg-amber-900/30 p-2 rounded-full mr-4">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                    class="h-6 w-6 text-amber-600 dark:text-amber-400" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Mantención</h3>
                                <p id="flota-estado-mantencion"
                                    class="text-xl font-bold text-amber-600 dark:text-amber-400">--</p>
                            </div>
                        </div>

                        <div class="card flex items-center p-4 border-l-4 border-red-500">
                            <div class="bg-red-100 dark:bg-red-900/30 p-2 rounded-full mr-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600 dark:text-red-400"
                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Compra</h3>
                                <p id="flota-estado-compra" class="text-xl font-bold text-red-600 dark:text-red-400">--
                                </p>
                            </div>
                        </div>

                        <div class="card flex items-center p-4 border-l-4 border-blue-500">
                            <div class="bg-blue-100 dark:bg-blue-900/30 p-2 rounded-full mr-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600 dark:text-blue-400"
                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Buses</h3>
                                <p id="flota-estado-total" class="text-xl font-bold text-gray-900 dark:text-white">--
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla Estado Flota -->
                    <div class="card p-0 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead
                                    class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-800 dark:text-gray-300">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">PPU</th>
                                        <th scope="col" class="px-6 py-3">N° Int</th>
                                        <th scope="col" class="px-6 py-3">Terminal</th>
                                        <th scope="col" class="px-6 py-3">Últ. Inspección</th>
                                        <th scope="col" class="px-6 py-3">Estado General</th>
                                        <th scope="col" class="px-6 py-3 text-right">Detalles</th>
                                    </tr>
                                </thead>
                                <tbody id="flota-tbody" class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Los datos se cargarán dinámicamente -->
                                    <tr class="animate-pulse">
                                        <td colspan="6" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                                            Cargando estado de la flota...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Mensaje de error -->
                        <div id="flota-lista-error-container"
                            class="p-4 text-center text-red-600 dark:text-red-400 hidden"></div>

                        <!-- Paginación -->
                        <div id="flota-pagination-controls"
                            class="px-6 py-3 border-t border-gray-200 dark:border-gray-700 flex flex-col sm:flex-row justify-between items-center text-sm text-gray-600 dark:text-gray-400">
                            <div id="flota-pagination-info" class="mb-3 sm:mb-0">Mostrando 0 a 0 de 0 buses</div>
                            <div class="flex items-center space-x-1">
                                <button id="flota-pagination-prev"
                                    class="btn btn-sm btn-light px-3 disabled:opacity-50 disabled:cursor-not-allowed">&laquo;
                                    Anterior</button>
                                <div id="flota-pagination-numbers" class="flex items-center space-x-1">
                                    <!-- Los números de página se generarán dinámicamente -->
                                </div>
                                <button id="flota-pagination-next"
                                    class="btn btn-sm btn-light px-3 disabled:opacity-50 disabled:cursor-not-allowed">Siguiente
                                    &raquo;</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista Análisis Avanzado -->
                <div id="analisis-view" class="view-container hidden space-y-6 animate-fadeIn">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Análisis Avanzado</h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Insights y métricas detalladas del
                            estado de extintores</p>
                    </div>

                    <!-- Filtros de Análisis -->
                    <div class="card p-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label for="analisis-periodo" class="form-label">Período</label>
                                <select id="analisis-periodo" class="form-select">
                                    <option value="ultimo-mes">Último mes</option>
                                    <option value="ultimo-trimestre">Último trimestre</option>
                                    <option value="ultimo-semestre">Último semestre</option>
                                    <option value="ultimo-ano">Último año</option>
                                    <option value="personalizado">Personalizado</option>
                                </select>
                            </div>
                            <div>
                                <label for="analisis-terminal" class="form-label">Terminal</label>
                                <select id="analisis-terminal" class="form-select">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div id="fecha-inicio-container" class="hidden">
                                <label for="analisis-fecha-inicio" class="form-label">Fecha Inicio</label>
                                <input type="date" id="analisis-fecha-inicio" class="form-control">
                            </div>
                            <div id="fecha-fin-container" class="hidden">
                                <label for="analisis-fecha-fin" class="form-label">Fecha Fin</label>
                                <input type="date" id="analisis-fecha-fin" class="form-control">
                            </div>
                            <div class="md:col-span-4 flex justify-end">
                                <button id="analisis-filtrar" class="btn btn-primary">Generar Análisis</button>
                            </div>
                        </div>
                    </div>

                    <!-- Métricas Principales -->
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                        <div class="card">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Ratio de Cumplimiento
                            </h3>
                            <div class="gauge-container h-52">
                                <div id="gauge-compliance"></div>
                                <div class="gauge-value" id="compliance-value">--%</div>
                                <div class="gauge-label"></div>
                            </div>
                            <div class="mt-4 text-center text-sm text-gray-600 dark:text-gray-400">
                                Porcentaje de buses con extintores en regla
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Evolución Inspecciones
                            </h3>
                            <div class="h-52">
                                <canvas id="inspeccion-tendencia-chart"></canvas>
                            </div>
                            <div class="mt-4 text-center text-sm text-gray-600 dark:text-gray-400">
                                Inspecciones realizadas en el período
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Necesidades por Tipo
                            </h3>
                            <div class="h-52">
                                <canvas id="necesidades-tipo-chart"></canvas>
                            </div>
                            <div class="mt-4 text-center text-sm text-gray-600 dark:text-gray-400">
                                Distribución de necesidades detectadas
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Vencimientos
                                Proyectados</h3>
                            <div class="h-52">
                                <canvas id="vencimientos-proyectados-chart"></canvas>
                            </div>
                            <div class="mt-4 text-center text-sm text-gray-600 dark:text-gray-400">
                                Extintores a vencer en próximos meses
                            </div>
                        </div>
                    </div>

                    <!-- Análisis por Terminal -->
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Análisis por Terminal</h3>
                            <button id="export-analisis-terminal" class="btn btn-sm btn-light">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Exportar
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-800">
                                    <tr>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Terminal</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Total Buses</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Extintores OK</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Mantención</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Compra</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Cumplimiento</th>
                                    </tr>
                                </thead>
                                <tbody id="analisis-terminal-body"
                                    class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Los datos se cargarán dinámicamente -->
                                    <tr class="animate-pulse">
                                        <td colspan="6" class="px-6 py-10 text-center text-gray-500 dark:text-gray-400">
                                            Genere un análisis para ver los resultados
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Vista Reportes -->
                <div id="reportes-view" class="view-container hidden space-y-6 animate-fadeIn">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Reportes</h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Generación de reportes personalizados
                        </p>
                    </div>

                    <!-- Selección de Reporte -->
                    <div class="card">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                            <div>
                                <label for="reporte-terminal" class="form-label">Terminal</label>
                                <select id="reporte-terminal" class="form-select">
                                    <option value="">Todos los Terminales</option>
                                </select>
                            </div>
                            <div>
                                <label for="reporte-tipo" class="form-label">Tipo de Reporte</label>
                                <select id="reporte-tipo" class="form-select">
                                    <option value="necesidades">Necesidades (Mantención/Compra)</option>
                                    <option value="estado_general">Estado General Flota</option>
                                    <option value="vencimientos">Próximos Vencimientos</option>
                                    <option value="inspecciones_recientes">Inspecciones Recientes</option>
                                </select>
                            </div>
                            <div>
                                <button id="generar-reporte-btn" class="btn btn-primary w-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    Generar Reporte
                                </button>
                            </div>
                        </div>

                        <div id="fecha-reporte-container" class="mt-6 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="reporte-fecha-inicio" class="form-label">Fecha Desde</label>
                                    <input type="date" id="reporte-fecha-inicio" class="form-control">
                                </div>
                                <div>
                                    <label for="reporte-fecha-fin" class="form-label">Fecha Hasta</label>
                                    <input type="date" id="reporte-fecha-fin" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resultado del Reporte -->
                    <div id="reporte-resultados" class="card">
                        <div id="reporte-imprimir">
                            <div class="flex justify-between items-center mb-6">
                                <h2 id="reporte-titulo" class="text-xl font-semibold text-gray-900 dark:text-white">
                                    Reporte</h2>
                                <div id="reporte-metadata" class="text-sm text-gray-500 dark:text-gray-400">
                                    Seleccione filtros y genere un reporte
                                </div>
                            </div>

                            <div id="reporte-contenido" class="prose dark:prose-invert max-w-none">
                                <div class="flex items-center justify-center py-16">
                                    <div class="text-center">
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                            class="h-12 w-12 mx-auto text-gray-400 dark:text-gray-600 mb-4" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                        <p class="text-gray-500 dark:text-gray-400">Seleccione los parámetros y genere
                                            un reporte</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3 mt-6 border-t border-gray-200 dark:border-gray-700 pt-4">
                            <button id="exportar-reporte-btn" class="btn btn-light" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Exportar Excel
                            </button>
                            <button id="imprimir-reporte-btn" class="btn btn-primary" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                Imprimir
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Vista Centro de Alertas -->
                <div id="alertas-view" class="view-container hidden space-y-6 animate-fadeIn">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Centro de Alertas</h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Monitoreo de vencimientos y necesidades
                            de mantenimiento</p>
                    </div>

                    <!-- Indicadores y Filtros -->
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="md:w-3/4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="card bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800">
                                    <div class="flex items-center">
                                        <div class="p-3 rounded-full bg-red-500/20 mr-4">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                class="h-6 w-6 text-red-600 dark:text-red-400" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </div>
                                        <div>
                                            <h3 class="text-xs font-medium text-red-800 dark:text-red-300 uppercase">
                                                Críticas</h3>
                                            <p id="alertas-criticas"
                                                class="text-2xl font-bold text-red-600 dark:text-red-400">--</p>
                                        </div>
                                    </div>
                                </div>

                                <div
                                    class="card bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-800">
                                    <div class="flex items-center">
                                        <div class="p-3 rounded-full bg-amber-500/20 mr-4">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                class="h-6 w-6 text-amber-600 dark:text-amber-400" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                            </svg>
                                        </div>
                                        <div>
                                            <h3
                                                class="text-xs font-medium text-amber-800 dark:text-amber-300 uppercase">
                                                Advertencias</h3>
                                            <p id="alertas-advertencias"
                                                class="text-2xl font-bold text-amber-600 dark:text-amber-400">--</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="card bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800">
                                    <div class="flex items-center">
                                        <div class="p-3 rounded-full bg-blue-500/20 mr-4">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                class="h-6 w-6 text-blue-600 dark:text-blue-400" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </div>
                                        <div>
                                            <h3 class="text-xs font-medium text-blue-800 dark:text-blue-300 uppercase">
                                                Informativas</h3>
                                            <p id="alertas-informativas"
                                                class="text-2xl font-bold text-blue-600 dark:text-blue-400">--</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="md:w-1/4">
                            <div class="card h-full">
                                <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Filtros</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label for="alertas-filter-terminal" class="form-label text-xs">Terminal</label>
                                        <select id="alertas-filter-terminal" class="form-select text-sm">
                                            <option value="">Todos</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="alertas-filter-tipo" class="form-label text-xs">Tipo de
                                            Alerta</label>
                                        <select id="alertas-filter-tipo" class="form-select text-sm">
                                            <option value="">Todos</option>
                                            <option value="critica">Críticas</option>
                                            <option value="advertencia">Advertencias</option>
                                            <option value="informativa">Informativas</option>
                                        </select>
                                    </div>
                                    <button id="alertas-filter-apply"
                                        class="btn btn-sm btn-primary w-full mt-2">Aplicar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Alertas -->
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Alertas Activas</h3>
                            <button id="alertas-export" class="btn btn-sm btn-light">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Exportar
                            </button>
                        </div>

                        <div id="alertas-container" class="space-y-4">
                            <!-- Las alertas se cargarán dinámicamente -->
                            <div class="animate-pulse">
                                <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-2.5"></div>
                                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded mb-2.5"></div>
                                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded mb-2.5"></div>
                                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded w-5/6"></div>
                            </div>
                            <div class="animate-pulse">
                                <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-2.5"></div>
                                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded mb-2.5"></div>
                                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded mb-2.5"></div>
                                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded w-5/6"></div>
                            </div>
                            <div class="animate-pulse">
                                <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-2.5"></div>
                                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded mb-2.5"></div>
                                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded mb-2.5"></div>
                                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded w-5/6"></div>
                            </div>
                        </div>

                        <!-- Paginación -->
                        <div id="alertas-pagination"
                            class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <div class="text-sm text-gray-700 dark:text-gray-300">
                                Mostrando <span id="alertas-showing">0</span> de <span id="alertas-total">0</span>
                                alertas
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="alertas-prev-page" class="btn btn-sm btn-light" disabled>&laquo;
                                    Anterior</button>
                                <div id="alertas-page-numbers" class="flex space-x-1">
                                    <!-- Números de página -->
                                </div>
                                <button id="alertas-next-page" class="btn btn-sm btn-light" disabled>Siguiente
                                    &raquo;</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista Configuración -->
                <div id="configuracion-view" class="view-container hidden space-y-6 animate-fadeIn">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Configuración</h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Ajustes del sistema y preferencias</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Configuración de Alertas -->
                        <div class="card lg:col-span-2">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Configuración de
                                Alertas</h3>

                            <form id="alertas-config-form" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="config-alerta-vencimiento" class="form-label">Días previos para
                                            alerta de vencimiento</label>
                                        <input type="number" id="config-alerta-vencimiento" class="form-control" min="1"
                                            max="90" value="30">
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Días antes del
                                            vencimiento para mostrar alerta</p>
                                    </div>
                                    <div>
                                        <label for="config-recordatorio-inspeccion" class="form-label">Recordatorio de
                                            inspecciones</label>
                                        <select id="config-recordatorio-inspeccion" class="form-select">
                                            <option value="30">Mensual</option>
                                            <option value="60">Bimestral</option>
                                            <option value="90">Trimestral</option>
                                            <option value="180">Semestral</option>
                                        </select>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Frecuencia recomendada
                                            para inspecciones</p>
                                    </div>
                                </div>

                                <div
                                    class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                                    <div>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="config-notificacion-email"
                                                class="w-4 h-4 text-blue-600 dark:text-blue-500 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500 dark:focus:ring-blue-400">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Enviar
                                                notificaciones por email</span>
                                        </label>
                                    </div>
                                    <div>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="config-notificacion-sistema" checked
                                                class="w-4 h-4 text-blue-600 dark:text-blue-500 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500 dark:focus:ring-blue-400">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Notificaciones
                                                en sistema</span>
                                        </label>
                                    </div>
                                </div>

                                <div
                                    class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                                    <div>
                                        <label for="config-email-destinatarios" class="form-label">Destinatarios de
                                            alertas (emails)</label>
                                        <textarea id="config-email-destinatarios" class="form-control" rows="2"
                                            placeholder="ejemplo@correo.com, otro@correo.com"></textarea>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Separados por comas</p>
                                    </div>
                                    <div>
                                        <label for="config-frecuencia-reporte" class="form-label">Frecuencia de reportes
                                            automáticos</label>
                                        <select id="config-frecuencia-reporte" class="form-select">
                                            <option value="diario">Diario</option>
                                            <option value="semanal" selected>Semanal</option>
                                            <option value="quincenal">Quincenal</option>
                                            <option value="mensual">Mensual</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="flex justify-end pt-4 border-t border-gray-200 dark:border-gray-700">
                                    <button type="submit" class="btn btn-primary">Guardar Configuración</button>
                                </div>
                            </form>
                        </div>

                        <!-- Preferencias de Interfaz -->
                        <div class="card">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Preferencias de
                                Interfaz</h3>

                            <div class="space-y-4">
                                <div>
                                    <label class="form-label">Tema</label>
                                    <div class="flex items-center space-x-4 mt-2">
                                        <label class="flex items-center">
                                            <input type="radio" name="theme-preference" value="light"
                                                class="w-4 h-4 text-blue-600 dark:text-blue-500 border-gray-300 dark:border-gray-600 focus:ring-blue-500 dark:focus:ring-blue-400">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Claro</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="theme-preference" value="dark"
                                                class="w-4 h-4 text-blue-600 dark:text-blue-500 border-gray-300 dark:border-gray-600 focus:ring-blue-500 dark:focus:ring-blue-400">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Oscuro</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="theme-preference" value="system" checked
                                                class="w-4 h-4 text-blue-600 dark:text-blue-500 border-gray-300 dark:border-gray-600 focus:ring-blue-500 dark:focus:ring-blue-400">
                                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Sistema</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                                    <label for="dashboard-default" class="form-label">Vista predeterminada</label>
                                    <select id="dashboard-default" class="form-select">
                                        <option value="dashboard">Dashboard</option>
                                        <option value="registrar">Registrar Inspección</option>
                                        <option value="lista">Historial Inspecciones</option>
                                        <option value="flota">Estado Flota</option>
                                        <option value="alertas">Centro de Alertas</option>
                                    </select>
                                </div>

                                <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                                    <label for="rows-per-page" class="form-label">Filas por página</label>
                                    <select id="rows-per-page" class="form-select">
                                        <option value="10">10 filas</option>
                                        <option value="25" selected>25 filas</option>
                                        <option value="50">50 filas</option>
                                        <option value="100">100 filas</option>
                                    </select>
                                </div>

                                <div
                                    class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                                    <button id="reset-preferences" class="btn btn-sm btn-light">Restablecer</button>
                                    <button id="save-preferences" class="btn btn-sm btn-primary">Guardar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Detalle -->
    <div id="detalle-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center pb-3 border-b border-gray-200 dark:border-gray-700">
                <h3 id="modal-title" class="text-lg font-semibold text-gray-900 dark:text-white">Detalles</h3>
                <button id="close-modal-button" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="py-4">
                <div id="modal-imprimir">
                    <div id="modal-content" class="space-y-4">
                        <!-- El contenido se cargará dinámicamente -->
                        <div class="flex justify-center items-center h-40">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                <button id="print-modal-button" class="btn btn-light">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z" />
                    </svg>
                    Imprimir
                </button>
                <button id="close-modal-button-bottom" class="btn btn-primary">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Notificación en tiempo real -->
    <div id="realtime-notification-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black opacity-50"></div>
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 animate-slideIn">
            <div class="p-4 sm:p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 id="notification-title" class="text-lg font-semibold text-gray-900 dark:text-white">
                        Nueva Inspección Registrada
                    </h3>
                    <button id="close-notification-button"
                        class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="notification-content" class="mb-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 pt-0.5">
                            <div
                                class="h-10 w-10 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600 dark:text-blue-400"
                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-900 dark:text-white">Se ha registrado una nueva
                                inspección</p>
                            <div class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                <p>Bus: <span id="notification-bus">ABCD12</span></p>
                                <p>Terminal: <span id="notification-terminal">Terminal Central</span></p>
                                <p>Estado: <span id="notification-estado"
                                        class="font-medium text-green-600 dark:text-green-400">OK</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="notification-dismiss" class="btn btn-light">Descartar</button>
                    <button id="notification-view" class="btn btn-primary">Ver Detalles</button>
                </div>
            </div>
        </div>

        <!-- Modal de información (tooltip avanzado) -->
        <div id="info-popup-modal"
            class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-sm w-full p-5 relative">
                <button id="close-info-popup"
                    class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>
                <h4 id="info-popup-title" class="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-100">
                    Información</h4>
                <p id="info-popup-content" class="text-sm text-gray-600 dark:text-gray-300"></p>
                <img id="info-popup-image" src="" alt="Imagen descriptiva" class="mt-3 rounded max-h-40 mx-auto hidden">
            </div>
        </div>

        <!-- Confirmación cambio de estado -->
        <div id="change-status-modal" class="modal">
            <div class="modal-content max-w-sm">
                <div class="flex justify-between items-center pb-3 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Confirmar cambio</h3>
                    <button id="close-change-status-button"
                        class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="py-4">
                    <p class="text-sm text-gray-700 dark:text-gray-300">
                        Este bus ya tiene una inspección reciente. ¿Estás seguro de que deseas cambiar su estado?
                    </p>
                    <div
                        class="mt-3 p-3 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800 rounded-md">
                        <p class="text-sm text-yellow-800 dark:text-yellow-300">
                            Se creará un nuevo registro de inspección. El historial anterior se mantendrá para fines de
                            auditoría.
                        </p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                    <button id="cancel-change-status" class="btn btn-light">Cancelar</button>
                    <button id="confirm-change-status" class="btn btn-primary">Confirmar</button>
                </div>
            </div>
        </div>

        <!-- Mensaje de alerta para bus ya revisado -->
        <div id="bus-already-inspected-toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 z-50 hidden">
            <div class="bg-blue-600 text-white rounded-lg shadow-lg px-4 py-3 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-sm font-medium">Este bus ya ha sido inspeccionado recientemente</span>
                <button class="ml-4 text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Contenedor de notificaciones flotantes -->
        <div id="notification-container" class="fixed bottom-5 right-5 z-50 space-y-3"></div>

        <!-- Botón flotante para nueva inspección rápida (visible solo en móvil) -->
        <button id="mobile-quick-add" class="floating-action-btn md:hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
        </button>

        <script src="pendientes-flota.js"></script>

        <script>

            // --- Variables Globales ---
            let currentView = 'dashboard';
            let criteriosData = [];
            let busesData = [];
            let terminalesData = [];
            let inspeccionesData = [];
            let flotaData = [];
            let alertasData = [];
            let vencimientosData = [];
            let chartInstances = {};
            let supabaseClient = null;
            let debounceTimer = null;
            let isDarkMode = false;
            let listaCurrentPage = 1;
            let listaTotalPages = 1;
            let listaTotalRecords = 0;
            let flotaCurrentPage = 1;
            let flotaTotalPages = 1;
            let flotaTotalRecords = 0;
            let alertasCurrentPage = 1;
            let alertasTotalPages = 1;
            let alertasTotalRecords = 0;
            let realtimeSubscription = null;
            const PAGE_SIZE = 25; // Registros por página
            const DEBOUNCE_DELAY = 500;
            const CURRENT_YEAR = new Date().getFullYear();

            // --- Configuración Supabase ---
            const SUPABASE_URL = 'https://tcmtxvuucjttngcazgff.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjbXR4dnV1Y2p0dG5nY2F6Z2ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA3MjUwMDEsImV4cCI6MjA1NjMwMTAwMX0.2WcIjMUEhSM6j9kYpbsYArQocZdHx86k7wXk-NyjIs0';

            // --- Mapeo de DOM Elements (Se inicializan en DOMContentLoaded) ---
            const DOM = {
                views: {},
                sidebar: null,
                sidebarOverlay: null,
                menuButton: null,
                navLinks: null,
                viewTitle: null,
                themeToggle: null,
                themeToggleText: null,
                themeToggleDarkIcon: null,
                themeToggleLightIcon: null,
                // Dashboard elements
                dashboardFilterTerminal: null,
                dashboardFilterPeriodo: null,
                dashboardRefreshBtn: null,
                kpiMantencion: null,
                kpiCompra: null,
                kpiHoy: null,
                kpiOk: null,
                extintorEstadoChart: null,
                terminalDistribucionChart: null,
                proximosVencimientosContainer: null,
                actividadRecienteBody: null,
                necesidadesContainer: null,
                // Registro elements
                registroForm: null,
                terminalSelect: null,
                terminalErrorContainer: null,
                numeroInternoInput: null,
                ppuInput: null,
                ppuHiddenInput: null,
                busValidationMsg: null,
                ppuErrorContainer: null,
                busAlreadyChecked: null,
                lastInspectionDate: null,
                usePreviousDataBtn: null,
                createNewInspectionBtn: null,
                historialBusBtn: null,
                extintorEstadoRadios: null,
                extintorDetailsContainer: null,
                fotoExtintorContainer: null,
                fotoExtintor: null,
                previewContainer: null,
                previewImage: null,
                removeImageBtn: null,
                vencimientoMesSelect: null,
                vencimientoAnoSelect: null,
                formMessage: null,
                submitButton: null,
                // Lista elements
                advancedFiltersToggle: null,
                advancedFiltersContainer: null,
                searchPpuLista: null,
                filterTerminalLista: null,
                filterEstadoExtintor: null,
                filterFechaInicioLista: null,
                filterFechaFinLista: null,
                applyFiltersListaButton: null,
                exportListaButton: null,
                inspeccionesTbody: null,
                listaErrorContainer: null,
                paginationControls: null,
                paginationInfo: null,
                paginationPrev: null,
                paginationNext: null,
                paginationNumbers: null,
                // Flota elements
                flotaFilterTerminal: null,
                flotaEstadoOk: null,
                flotaEstadoMantencion: null,
                flotaEstadoCompra: null,
                flotaEstadoTotal: null,
                flotaTbody: null,
                flotaListaErrorContainer: null,
                flotaPaginationControls: null,
                flotaPaginationInfo: null,
                flotaPaginationPrev: null,
                flotaPaginationNext: null,
                flotaPaginationNumbers: null,
                // Análisis elements
                analisisPeriodo: null,
                analisisTerminal: null,
                analisisFechaInicio: null,
                analisisFechaFin: null,
                fechaInicioContainer: null,
                fechaFinContainer: null,
                analisisFiltrarBtn: null,
                gaugeCompliance: null,
                complianceValue: null,
                inspeccionTendenciaChart: null,
                necesidadesTipoChart: null,
                vencimientosProyectadosChart: null,
                analisisTerminalBody: null,
                exportAnalisisTerminal: null,
                // Reportes elements
                reporteTerminalSelect: null,
                reporteTipoSelect: null,
                fechaReporteContainer: null,
                reporteFechaInicio: null,
                reporteFechaFin: null,
                generarReporteBtn: null,
                reporteResultados: null,
                reporteTitulo: null,
                reporteMetadata: null,
                reporteContenido: null,
                exportarReporteBtn: null,
                imprimirReporteBtn: null,
                // Alertas elements
                alertasBadge: null,
                alertasFilterTerminal: null,
                alertasFilterTipo: null,
                alertasFilterApply: null,
                alertasCriticas: null,
                alertasAdvertencias: null,
                alertasInformativas: null,
                alertasContainer: null,
                alertasPagination: null,
                alertasShowing: null,
                alertasTotal: null,
                alertasPrevPage: null,
                alertasNextPage: null,
                alertasPageNumbers: null,
                alertasExport: null,
                // Configuración elements
                alertasConfigForm: null,
                configAlertaVencimiento: null,
                configRecordatorioInspeccion: null,
                configNotificacionEmail: null,
                configNotificacionSistema: null,
                configEmailDestinatarios: null,
                configFrecuenciaReporte: null,
                themePreference: null,
                dashboardDefault: null,
                rowsPerPage: null,
                resetPreferences: null,
                savePreferences: null,
                // Modals
                detalleModal: null,
                modalTitle: null,
                modalContent: null,
                closeModalButton: null,
                closeModalButtonBottom: null,
                printModalButton: null,
                realtimeNotificationModal: null,
                notificationTitle: null,
                notificationContent: null,
                notificationBus: null,
                notificationTerminal: null,
                notificationEstado: null,
                closeNotificationButton: null,
                notificationDismiss: null,
                notificationView: null,
                infoPopupModal: null,
                infoPopupTitle: null,
                infoPopupContent: null,
                infoPopupImage: null,
                closeInfoPopup: null,
                changeStatusModal: null,
                closeChangeStatusButton: null,
                cancelChangeStatus: null,
                confirmChangeStatus: null,
                busAlreadyInspectedToast: null,
                notificationContainer: null,
                mobileQuickAdd: null,
                // Header elements
                notificationsMenuButton: null,
                notificationBadge: null,
                notificationsDropdown: null,
                notificationsContainer: null,
                quickActionsButton: null,
                quickActionsDropdown: null
            };

            // --- Funciones Auxiliares ---

            /**
             * Cambia la vista actual
             * @param {string} viewId - ID de la vista a mostrar
             */
            function showView(viewId) {
                if (!DOM.views.dashboard) {
                    console.error("showView: Selectores de vista no listos.");
                    return;
                }

                // Ocultar todas las vistas
                Object.values(DOM.views).forEach(view => {
                    if (view) view.classList.add('hidden');
                });

                // Mostrar la vista solicitada
                if (DOM.views[viewId]) {
                    DOM.views[viewId].classList.remove('hidden');

                    // Actualizar título
                    let titleText = viewId.charAt(0).toUpperCase() + viewId.slice(1);
                    switch (viewId) {
                        case 'lista': titleText = 'Historial Inspecciones'; break;
                        case 'registrar': titleText = 'Registrar Inspección'; break;
                        case 'reportes': titleText = 'Reportes'; break;
                        case 'flota': titleText = 'Estado Flota'; break;
                        case 'analisis': titleText = 'Análisis Avanzado'; break;
                        case 'alertas': titleText = 'Centro de Alertas'; break;
                        case 'configuracion': titleText = 'Configuración'; break;
                    }

                    if (DOM.viewTitle) DOM.viewTitle.textContent = titleText;
                    currentView = viewId;

                    // Actualizar navegación
                    DOM.navLinks.forEach(l => l.classList.remove('bg-blue-700', 'text-white'));
                    const activeLink = document.querySelector(`.nav-link[data-view="${viewId}"]`);
                    if (activeLink) activeLink.classList.add('bg-blue-700', 'text-white');

                    // Cargar datos específicos de la vista si está lista
                    if (supabaseClient && document.readyState === 'complete') {
                        switch (viewId) {
                            case 'dashboard':
                                loadTerminalesParaFiltroDashboard();
                                loadDashboardData();
                                break;
                            case 'registrar':
                                loadTerminalesParaFormulario();
                                // En móvil, si se abre directamente registro, autofocus al terminal
                                if (window.innerWidth < 768 && DOM.terminalSelect) {
                                    setTimeout(() => DOM.terminalSelect.focus(), 300);
                                }
                                break;
                            case 'lista':
                                loadTerminalesParaFiltroLista();
                                loadInspecciones(getCurrentFiltersLista(), 1);
                                break;
                            case 'flota':
                                loadTerminalesParaFiltroFlota();
                                loadFlotaStatus(getCurrentFiltersFlota(), 1);
                                break;
                            case 'analisis':
                                loadTerminalesParaFiltroAnalisis();
                                break;
                            case 'reportes':
                                loadTerminalesParaFiltroReporte();
                                if (DOM.reporteContenido) DOM.reporteContenido.innerHTML = '<div class="flex items-center justify-center py-16"><div class="text-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 dark:text-gray-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><p class="text-gray-500 dark:text-gray-400">Seleccione los parámetros y genere un reporte</p></div></div>';
                                if (DOM.reporteTitulo) DOM.reporteTitulo.textContent = 'Reporte';
                                if (DOM.reporteMetadata) DOM.reporteMetadata.textContent = '';
                                if (DOM.imprimirReporteBtn) DOM.imprimirReporteBtn.disabled = true;
                                if (DOM.exportarReporteBtn) DOM.exportarReporteBtn.disabled = true;
                                break;
                            case 'alertas':
                                loadTerminalesParaFiltroAlertas();
                                loadAlertas(getCurrentFiltersAlertas(), 1);
                                updateAlertasCounter();
                                break;
                        }
                    }

                    // En móvil, cerrar sidebar al cambiar de vista
                    if (window.innerWidth < 1024 && DOM.sidebar && DOM.sidebarOverlay) {
                        DOM.sidebar.classList.remove('open');
                        DOM.sidebarOverlay.classList.add('hidden');
                    }
                } else {
                    console.error(`Vista no encontrada: ${viewId}`);
                    showView('dashboard');
                }
            }

            /**
             * Muestra mensaje de carga en un contenedor
             * @param {HTMLElement} container - Contenedor donde mostrar el mensaje
             * @param {string} message - Mensaje a mostrar
             */
            function showLoadingMessage(container, message = "Cargando...") {
                if (container) {
                    container.innerHTML = `
                    <div class="flex justify-center items-center p-4">
                        <div class="loading-spinner mr-2"></div>
                        <span class="text-gray-500 dark:text-gray-400">${message}</span>
                    </div>`;
                }
            }

            /**
             * Muestra un mensaje de error
             * @param {HTMLElement} element - Elemento donde mostrar el error
             * @param {string} message - Mensaje de error
             */
            function showErrorMessage(element, message) {
                if (element) {
                    element.textContent = message;
                    element.className = 'mt-1 text-sm text-red-600 dark:text-red-400 font-medium';
                    element.classList.remove('hidden');
                }
                console.error(message);
            }

            /**
             * Muestra un mensaje de éxito
             * @param {HTMLElement} element - Elemento donde mostrar el mensaje
             * @param {string} message - Mensaje de éxito
             */
            function showSuccessMessage(element, message) {
                if (element) {
                    element.textContent = message;
                    element.className = 'mt-1 text-sm text-green-600 dark:text-green-400 font-medium';
                }
            }

            /**
             * Formatea una fecha
             * @param {string} dateString - Fecha en formato string
             * @returns {string} - Fecha formateada
             */
            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                const options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
                try {
                    const date = new Date(dateString);
                    return date.toLocaleString('es-CL', options);
                } catch (error) {
                    return dateString;
                }
            }

            /**
             * Formatea una fecha simple (sin hora)
             * @param {string} dateString - Fecha en formato string
             * @returns {string} - Fecha formateada sin hora
             */
            function formatSimpleDate(dateString) {
                if (!dateString) return 'N/A';
                const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
                try {
                    const date = new Date(dateString);
                    return date.toLocaleString('es-CL', options);
                } catch (error) {
                    return dateString;
                }
            }

            /**
             * Muestra una notificación flotante
             * @param {string} message - Mensaje a mostrar
             * @param {string} type - Tipo de notificación (success, error, warning, info)
             * @param {number} duration - Duración en ms
             */
            function showNotification(message, type = 'info', duration = 5000) {
                if (!DOM.notificationContainer) return;

                const alertId = `alert-${Date.now()}`;
                let bgColor, textColor, iconSvg, borderColor;

                switch (type) {
                    case 'success':
                        bgColor = 'bg-green-50 dark:bg-green-900/30';
                        textColor = 'text-green-800 dark:text-green-300';
                        borderColor = 'border-green-300 dark:border-green-700';
                        iconSvg = '<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
                        break;
                    case 'error':
                        bgColor = 'bg-red-50 dark:bg-red-900/30';
                        textColor = 'text-red-800 dark:text-red-300';
                        borderColor = 'border-red-300 dark:border-red-700';
                        iconSvg = '<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';
                        break;
                    case 'warning':
                        bgColor = 'bg-yellow-50 dark:bg-yellow-900/30';
                        textColor = 'text-yellow-800 dark:text-yellow-300';
                        borderColor = 'border-yellow-300 dark:border-yellow-700';
                        iconSvg = '<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 5a1 1 0 011 1v3a1 1 0 11-2 0V6a1 1 0 011-1zm1 5a1 1 0 10-2 0v2a1 1 0 102 0v-2z" clip-rule="evenodd"></path></svg>';
                        break;
                    default: // info
                        bgColor = 'bg-blue-50 dark:bg-blue-900/30';
                        textColor = 'text-blue-800 dark:text-blue-300';
                        borderColor = 'border-blue-300 dark:border-blue-700';
                        iconSvg = '<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>';
                }

                const alertElement = document.createElement('div');
                alertElement.id = alertId;
                alertElement.className = `flex items-center p-4 mb-4 text-sm ${textColor} rounded-lg ${bgColor} border ${borderColor} shadow-lg transition-all duration-300 ease-in-out max-w-md`;
                alertElement.setAttribute('role', 'alert');
                alertElement.innerHTML = `
                ${iconSvg}
                <span class="flex-1">${message}</span>
                <button type="button" class="ml-auto -mx-1.5 -my-1.5 ${bgColor} ${textColor} rounded-lg focus:ring-2 focus:ring-blue-400 p-1.5 hover:bg-opacity-30 inline-flex h-8 w-8" onclick="document.getElementById('${alertId}').remove()">
                    <span class="sr-only">Cerrar</span>
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            `;
                DOM.notificationContainer.appendChild(alertElement);

                // Animación de entrada
                alertElement.style.transform = 'translateX(100%)';
                alertElement.style.opacity = '0';

                setTimeout(() => {
                    alertElement.style.transform = 'translateX(0)';
                    alertElement.style.opacity = '1';
                }, 10);

                // Auto eliminar después de la duración
                setTimeout(() => {
                    const el = document.getElementById(alertId);
                    if (el) {
                        el.style.opacity = '0';
                        el.style.transform = 'translateX(100%)';
                        setTimeout(() => el.remove(), 300);
                    }
                }, duration);
            }

            /**
             * Formatea fecha a mes/año
             * @param {number} month - Número de mes
             * @param {number} year - Año
             * @returns {string} - Mes/Año formateado
             */
            function formatMonthYear(month, year) {
                if (!month || !year) return 'N/A';
                return `${String(month).padStart(2, '0')}/${year}`;
            }

            /**
             * Abre uno de los modales
             * @param {HTMLElement} modal - Modal a abrir
             */
            function openModal(modal) {
                if (!modal) return;
                modal.classList.add('active');
                document.body.classList.add('overflow-hidden');
            }

            /**
             * Cierra uno de los modales
             * @param {HTMLElement} modal - Modal a cerrar
             */
            function closeModal(modal) {
                if (!modal) return;
                modal.classList.remove('active');
                document.body.classList.remove('overflow-hidden');
            }

            // --- Carga de Datos Comunes ---

            /**
             * Inicializa la carga de datos para la aplicación
             */
            async function loadInitialData() {
                if (!supabaseClient) {
                    console.error("Supabase client no inicializado.");
                    return;
                }

                if (!DOM.views.dashboard) {
                    console.error("Selectores DOM no inicializados.");
                    return;
                }

                console.log("Iniciando carga de datos iniciales...");

                // Inicializar configuración general
                initDarkMode();

                // Cargar terminales base
                await loadTerminales();

                // Iniciar suscripción en tiempo real
                setupRealtimeSubscription();

                // Mostrar la vista por defecto
                // En móvil, ir directo a Registrar si es la primera vez
                if (window.innerWidth < 768 && localStorage.getItem('mobileFirstVisit') !== 'true') {
                    localStorage.setItem('mobileFirstVisit', 'true');
                    showView('registrar');
                } else {
                    showView(currentView);
                }

                // Inicializar contador de alertas
                updateAlertasCounter();

                console.log("Carga de datos iniciales completa.");
            }

            /**
             * Configura suscripción para actualizaciones en tiempo real
             */
            function setupRealtimeSubscription() {
                if (!supabaseClient) return;

                // Cerrar suscripción existente
                if (realtimeSubscription) {
                    realtimeSubscription.unsubscribe();
                }

                // Suscribirse a nueva inspección
                realtimeSubscription = supabaseClient
                    .channel('public:CatastroExtintor_inspecciones')
                    .on('INSERT', handleNewInspeccion)
                    .subscribe();

                console.log("Suscripción en tiempo real configurada");
            }

            /**
             * Maneja nueva inspección en tiempo real
             * @param {Object} payload - Datos de la nueva inspección
             */
            async function handleNewInspeccion(payload) {
                console.log("Nueva inspección recibida:", payload);

                // Obtener detalles del bus
                try {
                    const { data: busData, error: busError } = await supabaseClient
                        .from('CatastroExtintor_buses')
                        .select('*, terminal:CatastroExtintor_terminales(nombre)')
                        .eq('ppu', payload.new.bus_ppu)
                        .single();

                    if (busError) throw busError;

                    // Mostrar notificación
                    showInspeccionNotification(payload.new, busData);

                    // Actualizar vistas si es necesario
                    if (currentView === 'dashboard') loadDashboardData();
                    if (currentView === 'lista') loadInspecciones(getCurrentFiltersLista(), listaCurrentPage);
                    if (currentView === 'flota') loadFlotaStatus(getCurrentFiltersFlota(), flotaCurrentPage);

                    // Actualizar contador de alertas
                    updateAlertasCounter();

                } catch (error) {
                    console.error("Error obteniendo datos del bus:", error);
                }
            }

            /**
             * Muestra notificación de nueva inspección
             * @param {Object} inspeccion - Datos de la inspección
             * @param {Object} busData - Datos del bus
             */
            function showInspeccionNotification(inspeccion, busData) {
                if (!DOM.notificationBus || !DOM.notificationTerminal || !DOM.notificationEstado) return;

                // Configurar datos de la notificación
                DOM.notificationBus.textContent = busData.ppu;
                DOM.notificationTerminal.textContent = busData.terminal?.nombre || 'Desconocido';

                let estado = inspeccion.extintor_estado;
                let estadoClass = '';

                if (estado === 'Tiene') {
                    estado = 'OK';
                    estadoClass = 'text-green-600 dark:text-green-400';
                } else if (estado === 'No Tiene') {
                    estado = 'Sin Extintor';
                    estadoClass = 'text-red-600 dark:text-red-400';
                }

                DOM.notificationEstado.textContent = estado;
                DOM.notificationEstado.className = `font-medium ${estadoClass}`;

                // Mostrar modal de notificación
                openModal(DOM.realtimeNotificationModal);

                // También mostrar notificación flotante
                showNotification(`Nueva inspección registrada: Bus ${busData.ppu}`, 'info', 8000);
            }

            /**
             * Carga lista de terminales
             * @returns {Array} - Lista de terminales
             */
            async function loadTerminales() {
                if (terminalesData.length > 0) return terminalesData;

                try {
                    const { data, error } = await supabaseClient
                        .from('CatastroExtintor_terminales')
                        .select('id, nombre')
                        .order('nombre');

                    if (error) throw error;
                    terminalesData = data;
                    return terminalesData;
                } catch (error) {
                    console.error(`Error al cargar terminales: ${error.message}`);
                    showNotification(`Error al cargar terminales: ${error.message}`, 'error');
                    return [];
                }
            }

            /**
             * Llena un select con las opciones de terminales
             * @param {HTMLElement} selectElement - Elemento select a llenar
             * @param {HTMLElement} errorContainer - Contenedor para mensajes de error
             * @param {boolean} includeAllOption - Si debe incluir opción "Todos"
             * @param {string} defaultText - Texto por defecto
             */
            async function populateTerminalSelect(selectElement, errorContainer, includeAllOption = false, defaultText = 'Seleccione...') {
                if (!selectElement) {
                    console.warn(`populateTerminalSelect: Elemento select no encontrado.`);
                    return;
                }

                // Si ya está cargado, no hacer nada
                if (selectElement.options.length > 1 && selectElement.options[1]?.value !== '') return;

                selectElement.innerHTML = `<option value="">Cargando...</option>`;
                selectElement.disabled = true;

                if (errorContainer) errorContainer.innerHTML = '';

                const terminales = await loadTerminales();

                if (terminales.length === 0) {
                    selectElement.innerHTML = `<option value="">No hay terminales</option>`;
                    if (errorContainer) showErrorMessage(errorContainer, 'No se encontraron terminales.');
                } else {
                    selectElement.innerHTML = includeAllOption
                        ? `<option value="">${defaultText}</option>`
                        : `<option value="">${defaultText}</option>`;

                    terminales.forEach(t => {
                        selectElement.appendChild(new Option(t.nombre, t.id));
                    });

                    selectElement.disabled = false;
                }
            }

            /**
             * Carga terminales para el formulario de registro
             */
            async function loadTerminalesParaFormulario() {
                await populateTerminalSelect(DOM.terminalSelect, DOM.terminalErrorContainer, false, 'Seleccione Terminal...');

                const lastTerminalId = localStorage.getItem('lastTerminalId_extintor');
                if (lastTerminalId && DOM.terminalSelect.querySelector(`option[value="${lastTerminalId}"]`)) {
                    DOM.terminalSelect.value = lastTerminalId;
                    loadBusesParaFormulario(lastTerminalId);
                } else {
                    loadBusesParaFormulario();
                }
            }

            /**
             * Carga terminales para filtro de lista
             */
            async function loadTerminalesParaFiltroLista() {
                await populateTerminalSelect(DOM.filterTerminalLista, null, true, 'Todos los Terminales');
            }

            /**
             * Carga terminales para filtro de dashboard
             */
            async function loadTerminalesParaFiltroDashboard() {
                await populateTerminalSelect(DOM.dashboardFilterTerminal, null, true, 'Todos');

                if (DOM.dashboardFilterTerminal && !DOM.dashboardFilterTerminal.dataset.listenerAdded) {
                    DOM.dashboardFilterTerminal.addEventListener('change', () => loadDashboardData());
                    DOM.dashboardFilterTerminal.dataset.listenerAdded = 'true';
                }
            }

            /**
             * Carga terminales para filtro de reporte
             */
            async function loadTerminalesParaFiltroReporte() {
                await populateTerminalSelect(DOM.reporteTerminalSelect, null, true, 'Todos los Terminales');
            }

            /**
             * Carga terminales para filtro de flota
             */
            async function loadTerminalesParaFiltroFlota() {
                await populateTerminalSelect(DOM.flotaFilterTerminal, null, true, 'Todos los Terminales');
            }

            /**
             * Carga terminales para filtro de análisis
             */
            async function loadTerminalesParaFiltroAnalisis() {
                await populateTerminalSelect(DOM.analisisTerminal, null, true, 'Todos los Terminales');
            }

            /**
             * Carga terminales para filtro de alertas
             */
            async function loadTerminalesParaFiltroAlertas() {
                await populateTerminalSelect(DOM.alertasFilterTerminal, null, true, 'Todos los Terminales');
            }

            /**
             * Carga buses para el formulario
             * @param {string} terminalId - ID del terminal
             */
            async function loadBusesParaFormulario(terminalId = null) {
                if (!DOM.ppuErrorContainer || !DOM.numeroInternoInput || !DOM.ppuInput || !DOM.ppuHiddenInput || !DOM.busValidationMsg) return;

                if (!supabaseClient) {
                    showErrorMessage(DOM.ppuErrorContainer, 'Error: DB no conectada.');
                    return;
                }

                showLoadingMessage(DOM.ppuErrorContainer, 'Cargando flota...');
                DOM.numeroInternoInput.disabled = true;
                DOM.ppuInput.disabled = true;
                DOM.ppuHiddenInput.value = '';
                DOM.busValidationMsg.textContent = '';
                DOM.numeroInternoInput.value = '';
                DOM.ppuInput.value = '';

                // Ocultar alerta de bus ya revisado
                if (DOM.busAlreadyChecked) DOM.busAlreadyChecked.classList.add('hidden');

                // Deshabilitar botón de historial
                if (DOM.historialBusBtn) DOM.historialBusBtn.disabled = true;

                try {
                    let query = supabaseClient
                        .from('CatastroExtintor_buses')
                        .select('ppu, numero_interno, terminal_id')
                        .order('ppu');

                    if (terminalId && terminalId !== '') {
                        query = query.eq('terminal_id', terminalId);
                    }

                    const { data, error } = await query;

                    if (error) throw error;

                    busesData = data;
                    DOM.ppuErrorContainer.innerHTML = '';

                    if (data && data.length > 0) {
                        DOM.numeroInternoInput.disabled = false;
                        DOM.ppuInput.disabled = false;
                        DOM.busValidationMsg.textContent = `Flota cargada (${data.length}). Ingrese N° Interno o PPU.`;
                        DOM.busValidationMsg.className = 'mt-1 text-xs text-green-600 dark:text-green-400';
                    } else {
                        showErrorMessage(DOM.ppuErrorContainer, `No hay buses ${terminalId ? 'para este terminal' : 'registrados'}.`);
                    }
                } catch (error) {
                    console.error(`Error buses: ${error.message}`);
                    showErrorMessage(DOM.ppuErrorContainer, `Error al cargar buses: ${error.message}`);
                }
            }

            /**
             * Busca un bus por PPU o número interno
             * @param {string} inputValue - Valor ingresado
             * @param {string} inputType - Tipo de input (numero_interno o ppu)
             */
            async function findBusAndFill(inputValue, inputType) {
                if (!inputValue || !supabaseClient || !busesData || !DOM.numeroInternoInput || !DOM.ppuInput || !DOM.ppuHiddenInput || !DOM.busValidationMsg) return;

                clearTimeout(debounceTimer);

                debounceTimer = setTimeout(async () => {
                    let foundBus = null;
                    DOM.busValidationMsg.textContent = 'Buscando...';
                    DOM.busValidationMsg.className = 'mt-1 text-xs text-gray-500 dark:text-gray-400';
                    DOM.ppuHiddenInput.value = '';

                    // Ocultar alerta de bus ya revisado
                    if (DOM.busAlreadyChecked) DOM.busAlreadyChecked.classList.add('hidden');

                    // Deshabilitar botón de historial
                    if (DOM.historialBusBtn) DOM.historialBusBtn.disabled = true;

                    if (inputType === 'numero_interno') {
                        const numInt = parseInt(inputValue, 10);
                        if (!isNaN(numInt)) {
                            foundBus = busesData.find(bus => bus.numero_interno === numInt);
                        }
                    } else {
                        const ppuUpper = inputValue.toUpperCase().replace(/[^A-Z0-9]/g, '');
                        DOM.ppuInput.value = ppuUpper;

                        if (ppuUpper.length >= 6) {
                            foundBus = busesData.find(bus => bus.ppu === ppuUpper);
                        }
                    }

                    if (foundBus) {
                        DOM.busValidationMsg.textContent = 'Bus encontrado!';
                        DOM.busValidationMsg.className = 'mt-1 text-xs text-green-600 dark:text-green-400';

                        if (inputType === 'numero_interno') {
                            DOM.ppuInput.value = foundBus.ppu;
                        } else {
                            DOM.numeroInternoInput.value = foundBus.numero_interno || '';
                        }

                        DOM.ppuHiddenInput.value = foundBus.ppu;

                        // Habilitar botón de historial
                        if (DOM.historialBusBtn) {
                            DOM.historialBusBtn.disabled = false;
                        }

                        // Verificar si el bus ya tiene una inspección reciente
                        checkBusRecentInspection(foundBus.ppu);

                    } else {
                        DOM.busValidationMsg.textContent = 'Bus no encontrado en este terminal.';
                        DOM.busValidationMsg.className = 'mt-1 text-xs text-red-600 dark:text-red-400';

                        if (inputType === 'numero_interno') {
                            DOM.ppuInput.value = '';
                        } else {
                            DOM.numeroInternoInput.value = '';
                        }
                    }
                }, DEBOUNCE_DELAY);
            }

            /**
             * Verifica si un bus tiene inspección reciente
             * @param {string} busPPU - PPU del bus
             */
            async function checkBusRecentInspection(busPPU) {
                if (!busPPU || !supabaseClient || !DOM.busAlreadyChecked || !DOM.lastInspectionDate) return;

                try {
                    // Obtener la fecha de 30 días atrás
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                    const { data, error } = await supabaseClient
                        .from('CatastroExtintor_inspecciones')
                        .select('*')
                        .eq('bus_ppu', busPPU)
                        .gte('fecha_inspeccion', thirtyDaysAgo.toISOString())
                        .order('fecha_inspeccion', { ascending: false })
                        .limit(1);

                    if (error) throw error;

                    if (data && data.length > 0) {
                        // Mostrar alerta
                        DOM.lastInspectionDate.textContent = formatDate(data[0].fecha_inspeccion);
                        DOM.busAlreadyChecked.classList.remove('hidden');

                        // Guardar datos de la última inspección para posible reutilización
                        DOM.busAlreadyChecked.dataset.lastInspection = JSON.stringify(data[0]);
                    } else {
                        // No hay inspección reciente
                        DOM.busAlreadyChecked.classList.add('hidden');
                    }
                } catch (error) {
                    console.error(`Error al verificar inspección reciente: ${error.message}`);
                    DOM.busAlreadyChecked.classList.add('hidden');
                }
            }

            /**
             * Llena los campos del formulario con los datos de la última inspección
             */
            function fillFormWithPreviousData() {
                if (!DOM.busAlreadyChecked || !DOM.busAlreadyChecked.dataset.lastInspection) return;

                try {
                    const lastInspection = JSON.parse(DOM.busAlreadyChecked.dataset.lastInspection);

                    // Establecer estado de extintor
                    const radios = document.querySelectorAll('input[name="extintor_estado"]');
                    radios.forEach(radio => {
                        if (radio.value === lastInspection.extintor_estado) {
                            radio.checked = true;
                            // Disparar el evento change para mostrar/ocultar campos adicionales
                            radio.dispatchEvent(new Event('change'));
                        }
                    });

                    // Establecer fecha de vencimiento
                    if (lastInspection.vencimiento_mes && lastInspection.vencimiento_ano) {
                        if (DOM.vencimientoMesSelect) DOM.vencimientoMesSelect.value = lastInspection.vencimiento_mes;
                        if (DOM.vencimientoAnoSelect) DOM.vencimientoAnoSelect.value = lastInspection.vencimiento_ano;
                    }

                    // Establecer resto de campos
                    if (lastInspection.certificacion_estado && document.getElementById('certificacion_estado')) {
                        document.getElementById('certificacion_estado').value = lastInspection.certificacion_estado;
                    }

                    if (lastInspection.sonda_estado && document.getElementById('sonda_estado')) {
                        document.getElementById('sonda_estado').value = lastInspection.sonda_estado;
                    }

                    if (lastInspection.manometro_estado && document.getElementById('manometro_estado')) {
                        document.getElementById('manometro_estado').value = lastInspection.manometro_estado;
                    }

                    if (lastInspection.portaextintor_estado && document.getElementById('portaextintor_estado')) {
                        document.getElementById('portaextintor_estado').value = lastInspection.portaextintor_estado;
                    }

                    if (lastInspection.observaciones && document.getElementById('observaciones')) {
                        document.getElementById('observaciones').value = lastInspection.observaciones;
                    }

                    // Ocultar alerta
                    DOM.busAlreadyChecked.classList.add('hidden');

                    showNotification('Campos completados con la inspección anterior', 'success');

                } catch (error) {
                    console.error('Error al llenar formulario con datos anteriores:', error);
                    showNotification('Error al recuperar datos anteriores', 'error');
                }
            }

            // --- Lógica Formulario Registro ---

            /**
             * Controla envío del formulario de registro
             * @param {Event} event - Evento de submit
             */
            function handleRegistroSubmit(event) {
                event.preventDefault();

                if (!DOM.registroForm || !DOM.submitButton || !DOM.formMessage || !supabaseClient || !DOM.ppuHiddenInput || !DOM.terminalSelect) {
                    console.error("handleRegistroSubmit: Faltan elementos.");
                    return;
                }

                const validatedPPU = DOM.ppuHiddenInput.value;

                if (!validatedPPU) {
                    showNotification('Debe validar un N° Interno o PPU existente antes de guardar.', 'warning');
                    return;
                }

                DOM.submitButton.disabled = true;
                DOM.submitButton.innerHTML = '<div class="loading-spinner-inline mr-2"></div> Guardando...';
                DOM.formMessage.textContent = '';

                const formData = new FormData(DOM.registroForm);
                const extintorPresente = formData.get('extintor_estado') === 'Tiene';
                const mesVence = formData.get('vencimiento_mes');
                const anoVence = formData.get('vencimiento_ano');

                // Validación de Vencimiento si Extintor está presente
                if (extintorPresente && (!mesVence || !anoVence)) {
                    showNotification('Si el extintor está presente, debe indicar Mes y Año de Vencimiento.', 'warning');
                    DOM.submitButton.disabled = false;
                    DOM.submitButton.textContent = 'Guardar Inspección';
                    return;
                }

                // Validación de otros campos si extintor está presente
                if (extintorPresente && (!formData.get('certificacion_estado') || !formData.get('sonda_estado') || !formData.get('manometro_estado') || !formData.get('portaextintor_estado'))) {
                    showNotification('Si el extintor está presente, debe completar todos los detalles (Certificación, Sonda, Manómetro, Porta Extintor).', 'warning');
                    DOM.submitButton.disabled = false;
                    DOM.submitButton.textContent = 'Guardar Inspección';
                    return;
                }

                const inspeccionData = {
                    bus_ppu: validatedPPU,
                    registrador: null, /* TODO: Añadir campo registrador? */
                    extintor_estado: formData.get('extintor_estado'),
                    vencimiento_mes: mesVence ? parseInt(mesVence, 10) : null,
                    vencimiento_ano: anoVence ? parseInt(anoVence, 10) : null,
                    certificacion_estado: extintorPresente ? (formData.get('certificacion_estado') || null) : null,
                    sonda_estado: extintorPresente ? (formData.get('sonda_estado') || null) : null,
                    manometro_estado: extintorPresente ? (formData.get('manometro_estado') || null) : null,
                    portaextintor_estado: extintorPresente ? (formData.get('portaextintor_estado') || null) : null,
                    observaciones: formData.get('observaciones') || null,
                    fecha_inspeccion: new Date().toISOString()
                };

                (async () => {
                    try {
                        const { error } = await supabaseClient
                            .from('CatastroExtintor_inspecciones')
                            .insert([inspeccionData]);

                        if (error) throw error;

                        showNotification('¡Inspección registrada con éxito!', 'success');

                        // Limpiar formulario
                        DOM.registroForm.reset();
                        DOM.ppuHiddenInput.value = '';
                        DOM.busValidationMsg.textContent = '';

                        // Restaurar último terminal
                        const lastTerminal = localStorage.getItem('lastTerminalId_extintor');
                        if (lastTerminal) DOM.terminalSelect.value = lastTerminal;

                        // Recargar buses para el terminal actual
                        loadBusesParaFormulario(DOM.terminalSelect.value);

                        // Actualizar vistas si es necesario
                        if (currentView === 'dashboard') loadDashboardData();
                        if (currentView === 'lista') loadInspecciones(getCurrentFiltersLista(), listaCurrentPage);
                        if (currentView === 'flota') loadFlotaStatus(getCurrentFiltersFlota(), flotaCurrentPage);

                        // Ocultar contenedor de detalles
                        if (DOM.extintorDetailsContainer) DOM.extintorDetailsContainer.classList.add('hidden');

                    } catch (error) {
                        showNotification(`Error al guardar: ${error.message}`, 'error');
                        console.error("Error guardando:", error);
                    } finally {
                        DOM.submitButton.disabled = false;
                        DOM.submitButton.textContent = 'Guardar Inspección';
                    }
                })();
            }

            /**
             * Controla cambio en estado de extintor (tiene/no tiene)
             * @param {Event} event - Evento de cambio
             */
            function handleExtintorEstadoChange(event) {
                if (!DOM.extintorDetailsContainer || !DOM.fotoExtintorContainer) return;

                if (event.target.value === 'Tiene') {
                    DOM.extintorDetailsContainer.classList.remove('hidden');
                    DOM.fotoExtintorContainer.classList.remove('hidden');
                } else {
                    DOM.extintorDetailsContainer.classList.add('hidden');
                    DOM.fotoExtintorContainer.classList.remove('hidden');
                }
            }

            /**
             * Maneja la carga de imagen para vista previa
             * @param {Event} event - Evento de carga de archivo
             */
            function handleImageUpload(event) {
                if (!DOM.fotoExtintor || !DOM.previewContainer || !DOM.previewImage) return;

                const file = DOM.fotoExtintor.files[0];
                if (!file) return;

                // Validar tipo de archivo
                if (!file.type.match('image.*')) {
                    showNotification('Por favor, seleccione un archivo de imagen válido', 'warning');
                    DOM.fotoExtintor.value = '';
                    return;
                }

                // Validar tamaño (5MB máximo)
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('La imagen excede el tamaño máximo permitido (5MB)', 'warning');
                    DOM.fotoExtintor.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    DOM.previewImage.src = e.target.result;
                    DOM.previewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }

            /**
             * Elimina la imagen cargada
             */
            function removeUploadedImage() {
                if (!DOM.fotoExtintor || !DOM.previewContainer || !DOM.previewImage) return;

                DOM.fotoExtintor.value = '';
                DOM.previewImage.src = '';
                DOM.previewContainer.classList.add('hidden');
            }

            // --- Lógica Lista Historial Inspecciones ---

            /**
             * Carga las inspecciones con filtros
             * @param {Object} filters - Filtros aplicados
             * @param {number} page - Número de página
             */
            async function loadInspecciones(filters = {}, page = 1) {
                if (!DOM.inspeccionesTbody || !supabaseClient || !DOM.listaErrorContainer || !DOM.paginationControls) return;

                showLoadingMessage(DOM.inspeccionesTbody, 'Cargando historial...');
                DOM.listaErrorContainer.innerHTML = '';
                DOM.listaErrorContainer.classList.add('hidden');
                listaCurrentPage = page;

                try {
                    let needsMaintenanceFilter = filters.estadoExtintor === 'REQUIERE_MANTENCION';
                    let isExpiredFilter = filters.estadoExtintor === 'VENCIDO';

                    // Determinar qué tabla usar según el filtro
                    let baseTable = (needsMaintenanceFilter || isExpiredFilter)
                        ? 'CatastroExtintor_vista_necesidades'
                        : 'CatastroExtintor_inspecciones';

                    // Campos a seleccionar según la tabla
                    let selectFields = baseTable === 'CatastroExtintor_inspecciones'
                        ? `id, fecha_inspeccion, extintor_estado, vencimiento_mes, vencimiento_ano, certificacion_estado, manometro_estado, sonda_estado, portaextintor_estado, bus:CatastroExtintor_buses!inner ( ppu, numero_interno, terminal:CatastroExtintor_terminales ( nombre ) )`
                        : `bus_ppu, numero_interno, terminal_nombre, fecha_inspeccion, extintor_estado, vencimiento_mes, vencimiento_ano, certificacion_estado, manometro_estado, sonda_estado, portaextintor_estado, requiere_compra, requiere_mantencion`;

                    let query = supabaseClient.from(baseTable).select(selectFields, { count: 'exact' });

                    // Ordenamiento
                    if (baseTable === 'CatastroExtintor_inspecciones') {
                        query = query.order('fecha_inspeccion', { ascending: false });
                    } else {
                        query = query.order('terminal_nombre').order('numero_interno');
                    }

                    // Aplicar filtros
                    if (filters.ppu) {
                        if (baseTable === 'CatastroExtintor_inspecciones') {
                            query = query.or(`bus.ppu.ilike.%${filters.ppu}%,bus.numero_interno.eq.${parseInt(filters.ppu, 10) || 0}`, { foreignTable: 'CatastroExtintor_buses' });
                        } else {
                            query = query.or(`bus_ppu.ilike.%${filters.ppu}%,numero_interno.eq.${parseInt(filters.ppu, 10) || 0}`);
                        }
                    }

                    if (filters.terminal) {
                        if (baseTable === 'CatastroExtintor_inspecciones') {
                            query = query.eq('bus.terminal_id', filters.terminal, { foreignTable: 'CatastroExtintor_buses' });
                        } else {
                            query = query.eq('terminal_id', filters.terminal);
                        }
                    }

                    if (filters.estadoExtintor === 'Tiene') {
                        query = query.eq('extintor_estado', 'Tiene');
                    }

                    if (filters.estadoExtintor === 'No Tiene') {
                        query = query.eq('extintor_estado', 'No Tiene');
                    }

                    if (needsMaintenanceFilter) {
                        query = query.eq('requiere_mantencion', true);
                    }

                    if (isExpiredFilter) {
                        const today = new Date();
                        const firstDayOfNextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                        query = query.lt('make_date(vencimiento_ano, vencimiento_mes, 1)', firstDayOfNextMonth.toISOString().split('T')[0]);
                        query = query.eq('extintor_estado', 'Tiene');
                    }

                    if (filters.fechaInicio) {
                        query = query.gte('fecha_inspeccion', filters.fechaInicio + 'T00:00:00Z');
                    }

                    if (filters.fechaFin) {
                        query = query.lte('fecha_inspeccion', filters.fechaFin + 'T23:59:59Z');
                    }

                    // Paginación
                    const startIndex = (page - 1) * PAGE_SIZE;
                    const endIndex = page * PAGE_SIZE - 1;
                    query = query.range(startIndex, endIndex);

                    // Ejecutar consulta
                    const { data, error, count } = await query;

                    if (error) throw error;

                    inspeccionesData = data;
                    DOM.inspeccionesTbody.innerHTML = '';
                    listaTotalRecords = count || 0;
                    listaTotalPages = Math.ceil(listaTotalRecords / PAGE_SIZE);

                    // Si no hay resultados
                    if (data.length === 0) {
                        DOM.inspeccionesTbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-6 py-10 text-center text-gray-500 dark:text-gray-400">
                                No se encontraron inspecciones que coincidan con los filtros.
                            </td>
                        </tr>`;
                        updatePaginationControls(page, listaTotalPages, listaTotalRecords);
                        return;
                    }

                    // Mostrar resultados
                    data.forEach(insp => {
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';

                        // Obtener datos según la tabla utilizada
                        const busPPU = baseTable === 'CatastroExtintor_inspecciones' ? insp.bus.ppu : insp.bus_ppu;
                        const busNumInt = baseTable === 'CatastroExtintor_inspecciones' ? insp.bus.numero_interno : insp.numero_interno;
                        const termNombre = baseTable === 'CatastroExtintor_inspecciones' ? insp.bus.terminal?.nombre : insp.terminal_nombre;

                        // Formato de fecha de vencimiento
                        const venceStr = (insp.vencimiento_mes && insp.vencimiento_ano)
                            ? `${String(insp.vencimiento_mes).padStart(2, '0')}/${insp.vencimiento_ano}`
                            : 'N/A';

                        // Verificar si está vencido
                        let venceClass = '';
                        let isExpired = false;
                        if (insp.vencimiento_ano && insp.vencimiento_mes) {
                            const venceDate = new Date(insp.vencimiento_ano, insp.vencimiento_mes - 1, 1);
                            const lastDayOfMonth = new Date(venceDate.getFullYear(), venceDate.getMonth() + 1, 0);
                            const hoy = new Date();
                            isExpired = lastDayOfMonth < hoy;
                            if (isExpired) venceClass = 'text-red-500 dark:text-red-400 font-bold';
                        }

                        // Determinar estado general
                        let estadoGeneral = 'OK';
                        let estadoClass = 'text-green-500 dark:text-green-400';

                        if (insp.extintor_estado === 'No Tiene') {
                            estadoGeneral = 'Sin Extintor';
                            estadoClass = 'text-red-500 dark:text-red-400';
                        } else if (isExpired) {
                            estadoGeneral = 'Vencido';
                            estadoClass = 'text-red-500 dark:text-red-400';
                        } else if (insp.requiere_mantencion) {
                            estadoGeneral = 'Requiere Mantención';
                            estadoClass = 'text-amber-500 dark:text-amber-400';
                        }

                        // Construir fila
                        tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${busPPU}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${busNumInt || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${termNombre || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatDate(insp.fecha_inspeccion)}</td>
                        <td class="px-6 py-4 whitespace-nowrap ${insp.extintor_estado === 'No Tiene' ? 'text-red-500 dark:text-red-400' : ''}">${insp.extintor_estado || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap ${venceClass}">${venceStr}</td>
                        <td class="px-6 py-4 whitespace-nowrap ${estadoClass}">${estadoGeneral}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <button data-ppu="${busPPU}" class="view-details-button text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 font-medium">
                                Ver Historial
                            </button>
                        </td>`;

                        DOM.inspeccionesTbody.appendChild(tr);
                    });

                    // Actualizar controles de paginación
                    updatePaginationControls(page, listaTotalPages, listaTotalRecords);

                } catch (error) {
                    console.error(`Error al cargar inspecciones: ${error.message}`);
                    DOM.inspeccionesTbody.innerHTML = '';
                    DOM.listaErrorContainer.classList.remove('hidden');
                    showErrorMessage(DOM.listaErrorContainer, `Error al cargar inspecciones: ${error.message}`);
                    updatePaginationControls(1, 1, 0);
                }
            }

            /**
             * Obtiene los filtros actuales de la lista
             * @returns {Object} - Filtros aplicados
             */
            function getCurrentFiltersLista() {
                return {
                    ppu: DOM.searchPpuLista?.value.trim() || '',
                    terminal: DOM.filterTerminalLista?.value || '',
                    estadoExtintor: DOM.filterEstadoExtintor?.value || '',
                    fechaInicio: DOM.filterFechaInicioLista?.value || '',
                    fechaFin: DOM.filterFechaFinLista?.value || '',
                };
            }

            /**
             * Maneja la aplicación de filtros
             */
            function handleApplyFiltersLista() {
                loadInspecciones(getCurrentFiltersLista(), 1);

                // Ocultar panel de filtros avanzados
                if (DOM.advancedFiltersContainer) {
                    DOM.advancedFiltersContainer.classList.add('hidden');
                }
            }

            /**
             * Toggle de filtros avanzados
             */
            function toggleAdvancedFilters() {
                if (DOM.advancedFiltersContainer) {
                    DOM.advancedFiltersContainer.classList.toggle('hidden');
                }
            }

            /**
             * Actualiza los controles de paginación
             * @param {number} currentPage - Página actual
             * @param {number} totalPages - Total de páginas
             * @param {number} totalRecords - Total de registros
             */
            function updatePaginationControls(currentPage, totalPages, totalRecords) {
                if (!DOM.paginationControls || !DOM.paginationInfo || !DOM.paginationPrev || !DOM.paginationNext || !DOM.paginationNumbers) return;

                listaCurrentPage = currentPage;

                if (totalRecords === 0) {
                    DOM.paginationControls.classList.add('hidden');
                    return;
                }

                DOM.paginationControls.classList.remove('hidden');

                // Información de registros mostrados
                const startRecord = totalRecords > 0 ? (currentPage - 1) * PAGE_SIZE + 1 : 0;
                const endRecord = Math.min(currentPage * PAGE_SIZE, totalRecords);
                DOM.paginationInfo.textContent = `Mostrando ${startRecord} a ${endRecord} de ${totalRecords} registros`;

                // Habilitar/deshabilitar botones de navegación
                DOM.paginationPrev.disabled = currentPage <= 1;
                DOM.paginationNext.disabled = currentPage >= totalPages;

                // Generar números de página
                DOM.paginationNumbers.innerHTML = '';

                // Mostrar un máximo de 5 páginas
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, startPage + 4);

                if (endPage - startPage < 4 && totalPages > 4) {
                    startPage = Math.max(1, endPage - 4);
                }

                // Añadir primera página si no está en el rango
                if (startPage > 1) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `btn btn-sm ${1 === currentPage ? 'btn-primary' : 'btn-light'} px-3`;
                    pageBtn.textContent = '1';
                    pageBtn.addEventListener('click', () => loadInspecciones(getCurrentFiltersLista(), 1));
                    DOM.paginationNumbers.appendChild(pageBtn);

                    // Añadir elipsis si hay un salto
                    if (startPage > 2) {
                        const elipsis = document.createElement('span');
                        elipsis.className = 'px-2 text-gray-500 dark:text-gray-400';
                        elipsis.textContent = '...';
                        DOM.paginationNumbers.appendChild(elipsis);
                    }
                }

                // Añadir páginas del rango
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-light'} px-3`;
                    pageBtn.textContent = i;
                    pageBtn.addEventListener('click', () => loadInspecciones(getCurrentFiltersLista(), i));
                    DOM.paginationNumbers.appendChild(pageBtn);
                }

                // Añadir última página si no está en el rango
                if (endPage < totalPages) {
                    // Añadir elipsis si hay un salto
                    if (endPage < totalPages - 1) {
                        const elipsis = document.createElement('span');
                        elipsis.className = 'px-2 text-gray-500 dark:text-gray-400';
                        elipsis.textContent = '...';
                        DOM.paginationNumbers.appendChild(elipsis);
                    }

                    const pageBtn = document.createElement('button');
                    pageBtn.className = `btn btn-sm ${totalPages === currentPage ? 'btn-primary' : 'btn-light'} px-3`;
                    pageBtn.textContent = totalPages;
                    pageBtn.addEventListener('click', () => loadInspecciones(getCurrentFiltersLista(), totalPages));
                    DOM.paginationNumbers.appendChild(pageBtn);
                }
            }

            // --- Lógica Vista Estado Flota ---

            /**
             * Carga el estado de la flota
             * @param {Object} filters - Filtros aplicados
             * @param {number} page - Número de página
             */
            async function loadFlotaStatus(filters = {}, page = 1) {
                if (!DOM.flotaTbody || !supabaseClient || !DOM.flotaListaErrorContainer || !DOM.flotaPaginationControls) return;

                showLoadingMessage(DOM.flotaTbody, 'Cargando estado de flota...');
                DOM.flotaListaErrorContainer.innerHTML = '';
                DOM.flotaListaErrorContainer.classList.add('hidden');
                flotaCurrentPage = page;

                try {
                    // Contar totales por estado primero para mostrar en KPIs
                    let countOK = 0;
                    let countMantencion = 0;
                    let countCompra = 0;
                    let countTotal = 0;

                    let countQuery = supabaseClient
                        .from('CatastroExtintor_vista_necesidades')
                        .select('requiere_compra, requiere_mantencion', { count: 'exact' });

                    if (filters.terminal) {
                        countQuery = countQuery.eq('terminal_id', filters.terminal);
                    }

                    const countResult = await countQuery;

                    if (countResult.error) throw countResult.error;

                    countTotal = countResult.count || 0;

                    if (countResult.data) {
                        countMantencion = countResult.data.filter(b => b.requiere_mantencion && !b.requiere_compra).length;
                        countCompra = countResult.data.filter(b => b.requiere_compra).length;
                        countOK = countTotal - countMantencion - countCompra;
                    }

                    // Actualizar KPIs
                    if (DOM.flotaEstadoOk) DOM.flotaEstadoOk.textContent = countOK;
                    if (DOM.flotaEstadoMantencion) DOM.flotaEstadoMantencion.textContent = countMantencion;
                    if (DOM.flotaEstadoCompra) DOM.flotaEstadoCompra.textContent = countCompra;
                    if (DOM.flotaEstadoTotal) DOM.flotaEstadoTotal.textContent = countTotal;

                    // Obtener datos paginados
                    let query = supabaseClient
                        .from('CatastroExtintor_vista_necesidades')
                        .select(`bus_ppu, numero_interno, terminal_nombre, fecha_inspeccion, requiere_compra, requiere_mantencion, detalle_problema, extintor_estado, vencimiento_mes, vencimiento_ano, certificacion_estado, sonda_estado, manometro_estado, portaextintor_estado`, { count: 'exact' })
                        .order('terminal_nombre')
                        .order('numero_interno');

                    if (filters.terminal) {
                        query = query.eq('terminal_id', filters.terminal);
                    }

                    // Paginación
                    const startIndex = (page - 1) * PAGE_SIZE;
                    const endIndex = page * PAGE_SIZE - 1;
                    query = query.range(startIndex, endIndex);

                    const { data, error, count } = await query;

                    if (error) throw error;

                    flotaData = data;
                    DOM.flotaTbody.innerHTML = '';
                    flotaTotalRecords = count || 0;
                    flotaTotalPages = Math.ceil(flotaTotalRecords / PAGE_SIZE);

                    // Si no hay resultados
                    if (data.length === 0) {
                        DOM.flotaTbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-10 text-center text-gray-500 dark:text-gray-400">
                                No se encontraron buses que coincidan con los filtros.
                            </td>
                        </tr>`;
                        updateFlotaPaginationControls(page, flotaTotalPages, flotaTotalRecords);
                        return;
                    }

                    // Mostrar resultados
                    populateFlotaTable(data);

                    // Actualizar controles de paginación
                    updateFlotaPaginationControls(page, flotaTotalPages, flotaTotalRecords);

                } catch (error) {
                    console.error(`Error al cargar estado flota: ${error.message}`);
                    DOM.flotaTbody.innerHTML = '';
                    DOM.flotaListaErrorContainer.classList.remove('hidden');
                    showErrorMessage(DOM.flotaListaErrorContainer, `Error: ${error.message}`);
                    updateFlotaPaginationControls(1, 1, 0);
                }
            }

            /**
             * Llena la tabla de flota con los datos
             * @param {Array} data - Datos de flota
             */
            function populateFlotaTable(data) {
                if (!DOM.flotaTbody) return;

                DOM.flotaTbody.innerHTML = '';

                data.forEach((bus, index) => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';

                    // Determinar estado general
                    let estadoGeneral, estadoClass, estadoBadgeClass;

                    if (bus.requiere_compra) {
                        estadoGeneral = `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300">REQUIERE COMPRA</span>`;
                        estadoClass = 'text-red-600';
                        estadoBadgeClass = 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300';
                    } else if (bus.requiere_mantencion) {
                        estadoGeneral = `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300">MANTENCIÓN</span>`;
                        estadoClass = 'text-amber-600';
                        estadoBadgeClass = 'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300';
                    } else {
                        estadoGeneral = `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300">OK</span>`;
                        estadoClass = 'text-green-600';
                        estadoBadgeClass = 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300';
                    }

                    // Construir fila
                    tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${bus.bus_ppu}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${bus.numero_interno || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${bus.terminal_nombre || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${formatDate(bus.fecha_inspeccion)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${estadoGeneral}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <button data-index="${index}" class="flota-details-button text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 font-medium">
                            Ver Detalles
                        </button>
                    </td>`;

                    DOM.flotaTbody.appendChild(tr);
                });
            }

            /**
             * Obtiene filtros actuales de flota
             * @returns {Object} - Filtros aplicados
             */
            function getCurrentFiltersFlota() {
                return {
                    terminal: DOM.flotaFilterTerminal?.value || ''
                };
            }

            /**
             * Aplica filtros a la flota
             */
            function handleApplyFiltersFlota() {
                loadFlotaStatus(getCurrentFiltersFlota(), 1);
            }

            /**
             * Actualiza controles de paginación de flota
             * @param {number} currentPage - Página actual
             * @param {number} totalPages - Total de páginas
             * @param {number} totalRecords - Total de registros
             */
            function updateFlotaPaginationControls(currentPage, totalPages, totalRecords) {
                if (!DOM.flotaPaginationControls || !DOM.flotaPaginationInfo || !DOM.flotaPaginationPrev || !DOM.flotaPaginationNext || !DOM.flotaPaginationNumbers) return;

                flotaCurrentPage = currentPage;

                if (totalRecords === 0) {
                    DOM.flotaPaginationControls.classList.add('hidden');
                    return;
                }

                DOM.flotaPaginationControls.classList.remove('hidden');

                // Información de registros mostrados
                const startRecord = totalRecords > 0 ? (currentPage - 1) * PAGE_SIZE + 1 : 0;
                const endRecord = Math.min(currentPage * PAGE_SIZE, totalRecords);
                DOM.flotaPaginationInfo.textContent = `Mostrando ${startRecord} a ${endRecord} de ${totalRecords} buses`;

                // Habilitar/deshabilitar botones de navegación
                DOM.flotaPaginationPrev.disabled = currentPage <= 1;
                DOM.flotaPaginationNext.disabled = currentPage >= totalPages;

                // Generar números de página
                DOM.flotaPaginationNumbers.innerHTML = '';

                // Mostrar un máximo de 5 páginas
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, startPage + 4);

                if (endPage - startPage < 4 && totalPages > 4) {
                    startPage = Math.max(1, endPage - 4);
                }

                // Añadir primera página si no está en el rango
                if (startPage > 1) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `btn btn-sm ${1 === currentPage ? 'btn-primary' : 'btn-light'} px-3`;
                    pageBtn.textContent = '1';
                    pageBtn.addEventListener('click', () => loadFlotaStatus(getCurrentFiltersFlota(), 1));
                    DOM.flotaPaginationNumbers.appendChild(pageBtn);

                    // Añadir elipsis si hay un salto
                    if (startPage > 2) {
                        const elipsis = document.createElement('span');
                        elipsis.className = 'px-2 text-gray-500 dark:text-gray-400';
                        elipsis.textContent = '...';
                        DOM.flotaPaginationNumbers.appendChild(elipsis);
                    }
                }

                // Añadir páginas del rango
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-light'} px-3`;
                    pageBtn.textContent = i;
                    pageBtn.addEventListener('click', () => loadFlotaStatus(getCurrentFiltersFlota(), i));
                    DOM.flotaPaginationNumbers.appendChild(pageBtn);
                }

                // Añadir última página si no está en el rango
                if (endPage < totalPages) {
                    // Añadir elipsis si hay un salto
                    if (endPage < totalPages - 1) {
                        const elipsis = document.createElement('span');
                        elipsis.className = 'px-2 text-gray-500 dark:text-gray-400';
                        elipsis.textContent = '...';
                        DOM.flotaPaginationNumbers.appendChild(elipsis);
                    }

                    const pageBtn = document.createElement('button');
                    pageBtn.className = `btn btn-sm ${totalPages === currentPage ? 'btn-primary' : 'btn-light'} px-3`;
                    pageBtn.textContent = totalPages;
                    pageBtn.addEventListener('click', () => loadFlotaStatus(getCurrentFiltersFlota(), totalPages));
                    DOM.flotaPaginationNumbers.appendChild(pageBtn);
                }
            }

            // --- Lógica Modal Detalles ---

            /**
             * Abre modal de detalles de flota
             * @param {Object} busData - Datos del bus
             */
            function openFlotaDetalleModal(busData) {
                if (!DOM.detalleModal || !DOM.modalContent || !DOM.modalTitle) return;

                DOM.modalTitle.textContent = `Detalle Extintor - PPU: ${busData.bus_ppu}`;

                let estadoGeneral, estadoClass;
                if (busData.requiere_compra) {
                    estadoGeneral = 'REQUIERE COMPRA';
                    estadoClass = 'text-red-600 dark:text-red-400';
                } else if (busData.requiere_mantencion) {
                    estadoGeneral = 'REQUIERE MANTENCIÓN';
                    estadoClass = 'text-amber-600 dark:text-amber-400';
                } else {
                    estadoGeneral = 'OK';
                    estadoClass = 'text-green-600 dark:text-green-400';
                }

                let contentHTML = `
                <section class="mb-5">
                    <h4 class="text-base font-semibold text-gray-800 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-1 mb-2">Información del Bus</h4>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                        <div><strong class="text-gray-600 dark:text-gray-400">PPU:</strong> ${busData.bus_ppu}</div>
                        <div><strong class="text-gray-600 dark:text-gray-400">N° Interno:</strong> ${busData.numero_interno || 'N/A'}</div>
                        <div><strong class="text-gray-600 dark:text-gray-400">Terminal:</strong> ${busData.terminal_nombre || 'N/A'}</div>
                        <div><strong class="text-gray-600 dark:text-gray-400">Últ. Inspección:</strong> ${formatDate(busData.fecha_inspeccion)}</div>
                    </div>
                </section>
                
                <section class="mb-5">
                    <h4 class="text-base font-semibold text-gray-800 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-1 mb-2">Estado Actual Extintor</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 text-sm mb-3">
                        <div><strong class="text-gray-600 dark:text-gray-400">Extintor:</strong> ${busData.extintor_estado || '-'}</div>
                        <div><strong class="text-gray-600 dark:text-gray-400">Vence:</strong> ${(busData.vencimiento_mes && busData.vencimiento_ano) ? `${String(busData.vencimiento_mes).padStart(2, '0')}/${busData.vencimiento_ano}` : 'N/A'}</div>
                        <div><strong class="text-gray-600 dark:text-gray-400">Cert.:</strong> ${busData.certificacion_estado || '-'}</div>
                        <div><strong class="text-gray-600 dark:text-gray-400">Sonda:</strong> ${busData.sonda_estado || '-'}</div>
                        <div><strong class="text-gray-600 dark:text-gray-400">Manóm.:</strong> ${busData.manometro_estado || '-'}</div>
                        <div><strong class="text-gray-600 dark:text-gray-400">Soporte:</strong> ${busData.portaextintor_estado || '-'}</div>
                    </div>
                    
                    <div class="mt-3 p-3 rounded-md ${busData.requiere_compra ? 'bg-red-100 dark:bg-red-900/30 border border-red-300 dark:border-red-800' : busData.requiere_mantencion ? 'bg-amber-100 dark:bg-amber-900/30 border border-amber-300 dark:border-amber-800' : 'bg-green-100 dark:bg-green-900/30 border border-green-300 dark:border-green-800'}">
                        <p class="text-sm font-medium ${estadoClass}">${estadoGeneral}</p>
                        ${busData.detalle_problema ? `<p class="text-xs ${estadoClass} mt-1">Detalle: ${busData.detalle_problema}</p>` : ''}
                    </div>
                </section>
                
                <section class="mt-6">
                    <h4 class="text-base font-semibold text-gray-800 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-1 mb-2">Acciones Recomendadas</h4>
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-md">
                        ${busData.requiere_compra ?
                        `<div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">Extintor no presente - COMPRA URGENTE</p>
                                    <ul class="mt-2 text-xs text-gray-600 dark:text-gray-400 list-disc list-inside">
                                        <li>Adquirir extintor de acuerdo a normativa</li>
                                        <li>Verificar soporte de instalación</li>
                                        <li>Registrar nueva inspección al completar instalación</li>
                                    </ul>
                                </div>
                            </div>`
                        : busData.requiere_mantencion ?
                            `<div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-amber-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 5a1 1 0 011 1v3a1 1 0 11-2 0V6a1 1 0 011-1zm1 5a1 1 0 10-2 0v2a1 1 0 102 0v-2z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">Requiere mantención/revisión</p>
                                    <ul class="mt-2 text-xs text-gray-600 dark:text-gray-400 list-disc list-inside">
                                        ${busData.vencimiento_mes && busData.vencimiento_ano ?
                                `<li>Verificar fecha de vencimiento (${String(busData.vencimiento_mes).padStart(2, '0')}/${busData.vencimiento_ano})</li>` : ''}
                                        ${busData.manometro_estado && busData.manometro_estado !== 'Tiene' ?
                                `<li>Revisar manómetro (${busData.manometro_estado})</li>` : ''}
                                        ${busData.sonda_estado && busData.sonda_estado !== 'Tiene' ?
                                `<li>Revisar sonda/manguera (${busData.sonda_estado})</li>` : ''}
                                        ${busData.certificacion_estado && busData.certificacion_estado === 'DAÑADO' || busData.certificacion_estado === 'NO TIENE' ?
                                `<li>Verificar certificación (${busData.certificacion_estado})</li>` : ''}
                                        ${busData.portaextintor_estado && busData.portaextintor_estado !== 'Tiene' ?
                                `<li>Revisar soporte (${busData.portaextintor_estado})</li>` : ''}
                                    </ul>
                                </div>
                            </div>`
                            :
                            `<div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">Extintor en buen estado</p>
                                    <p class="mt-1 text-xs text-gray-600 dark:text-gray-400">Todos los componentes se encuentran operativos y dentro de los estándares requeridos.</p>
                                </div>
                            </div>`
                    }
                    </div>
                </section>`;

                DOM.modalContent.innerHTML = contentHTML;
                openModal(DOM.detalleModal);
            }

            /**
             * Abre modal de historial de bus
             * @param {string} busPPU - PPU del bus
             */
            async function openHistorialModal(busPPU) {
                if (!DOM.detalleModal || !DOM.modalContent || !supabaseClient || !busPPU || !DOM.modalTitle) return;

                DOM.modalTitle.textContent = `Historial Inspecciones - PPU: ${busPPU}`;
                showLoadingMessage(DOM.modalContent, 'Cargando historial...');
                openModal(DOM.detalleModal);

                try {
                    // Obtener datos del bus
                    const { data: busData, error: busError } = await supabaseClient
                        .from('CatastroExtintor_buses')
                        .select('*, terminal:CatastroExtintor_terminales(nombre)')
                        .eq('ppu', busPPU)
                        .single();

                    if (busError) throw busError;

                    // Obtener historial
                    const { data: historial, error } = await supabaseClient
                        .from('CatastroExtintor_inspecciones')
                        .select('*')
                        .eq('bus_ppu', busPPU)
                        .order('fecha_inspeccion', { ascending: false });

                    if (error) throw error;

                    let modalHTML = `
                    <section class="mb-5">
                        <h4 class="text-base font-semibold text-gray-800 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-1 mb-2">Información del Bus</h4>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                            <div><strong class="text-gray-600 dark:text-gray-400">PPU:</strong> ${busPPU}</div>
                            <div><strong class="text-gray-600 dark:text-gray-400">N° Interno:</strong> ${busData.numero_interno || 'N/A'}</div>
                            <div><strong class="text-gray-600 dark:text-gray-400">Terminal:</strong> ${busData.terminal?.nombre || 'N/A'}</div>
                        </div>
                    </section>
                    
                    <h4 class="text-base font-semibold text-gray-800 dark:text-gray-100 mb-3 border-b border-gray-200 dark:border-gray-700 pb-1">Historial de Inspecciones</h4>`;

                    if (!historial || historial.length === 0) {
                        modalHTML += '<p class="text-gray-500 dark:text-gray-400">No hay historial registrado.</p>';
                    } else {
                        modalHTML += '<div class="space-y-4 max-h-[50vh] overflow-y-auto pr-2">';

                        historial.forEach((insp, index) => {
                            const venceStr = (insp.vencimiento_mes && insp.vencimiento_ano)
                                ? `${String(insp.vencimiento_mes).padStart(2, '0')}/${insp.vencimiento_ano}`
                                : 'N/A';

                            // Determinar si es la inspección más reciente
                            const isNewest = index === 0;
                            const borderClass = isNewest ? 'border-blue-300 dark:border-blue-700 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50';

                            modalHTML += `
                            <div class="border ${borderClass} rounded-lg p-4 text-sm">
                                <div class="flex justify-between items-start">
                                    <p class="font-medium text-gray-900 dark:text-white mb-2">Fecha: ${formatDate(insp.fecha_inspeccion)}</p>
                                    ${isNewest ? '<span class="badge badge-primary">Más reciente</span>' : ''}
                                </div>
                                
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 text-gray-600 dark:text-gray-400 mb-3">
                                    <div><strong>Extintor:</strong> ${insp.extintor_estado || '-'}</div>
                                    <div><strong>Vence:</strong> ${venceStr}</div>
                                    <div><strong>Cert:</strong> ${insp.certificacion_estado || '-'}</div>
                                    <div><strong>Sonda:</strong> ${insp.sonda_estado || '-'}</div>
                                    <div><strong>Manóm:</strong> ${insp.manometro_estado || '-'}</div>
                                    <div><strong>Soporte:</strong> ${insp.portaextintor_estado || '-'}</div>
                                </div>
                                
                                ${insp.observaciones ? `
                                <div class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-700">
                                    <p class="text-xs italic text-gray-500 dark:text-gray-400">
                                        <strong>Observaciones:</strong> ${insp.observaciones}
                                    </p>
                                </div>` : ''}
                            </div>`;
                        });

                        modalHTML += '</div>';
                    }

                    DOM.modalContent.innerHTML = modalHTML;
                } catch (error) {
                    DOM.modalContent.innerHTML = `
                    <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-md p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800 dark:text-red-300">Error al cargar historial</h3>
                                <div class="mt-2 text-sm text-red-700 dark:text-red-200">
                                    <p>${error.message}</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    console.error("Error fetching history:", error);
                }
            }

            // --- Lógica Dashboard ---

            /**
             * Carga datos del dashboard
             */
            async function loadDashboardData() {
                if (!DOM.kpiMantencion || !DOM.kpiCompra || !DOM.kpiHoy || !DOM.kpiOk || !DOM.extintorEstadoChart || !supabaseClient) return;

                // Mostrar estado de carga en KPIs
                DOM.kpiMantencion.textContent = '--';
                DOM.kpiCompra.textContent = '--';
                DOM.kpiHoy.textContent = '--';
                DOM.kpiOk.textContent = '--';

                // Período seleccionado
                const selectedPeriodo = DOM.dashboardFilterPeriodo?.value || 'todo';

                // Terminal seleccionado
                const selectedTerminalId = DOM.dashboardFilterTerminal?.value || '';

                try {
                    // 1. Consultar necesidades (mantencion/compra)
                    let queryNeeds = supabaseClient
                        .from('CatastroExtintor_vista_necesidades')
                        .select('requiere_compra, requiere_mantencion', { count: 'exact' });

                    // 2. Consultar inspecciones de hoy
                    let queryToday = supabaseClient
                        .from('CatastroExtintor_inspecciones')
                        .select('id', { count: 'exact', head: true });

                    // Crear fechas para filtrar por período
                    const todayStart = new Date();
                    todayStart.setHours(0, 0, 0, 0);

                    const todayEnd = new Date();
                    todayEnd.setHours(23, 59, 59, 999);

                    // Filtrar por fecha según período seleccionado
                    queryToday = queryToday.gte('fecha_inspeccion', todayStart.toISOString()).lte('fecha_inspeccion', todayEnd.toISOString());

                    // 3. Filtrar por terminal si se seleccionó uno
                    if (selectedTerminalId) {
                        queryNeeds = queryNeeds.eq('terminal_id', selectedTerminalId);
                        // Filtro para inspecciones hoy por terminal es más complejo (requiere join)
                        queryToday = queryToday.in('bus_ppu', `(SELECT ppu FROM CatastroExtintor_buses WHERE terminal_id = '${selectedTerminalId}')`);
                    }

                    // 4. Ejecutar consultas en paralelo
                    const [needsResult, todayResult] = await Promise.all([
                        queryNeeds,
                        queryToday
                    ]);

                    if (needsResult.error) throw needsResult.error;
                    if (todayResult.error) throw todayResult.error;

                    // 5. Procesar resultados
                    const needsData = needsResult.data || [];
                    const totalBuses = needsResult.count || 0;

                    const countMantencion = needsData.filter(b => b.requiere_mantencion && !b.requiere_compra).length;
                    const countCompra = needsData.filter(b => b.requiere_compra).length;
                    const countOk = totalBuses - countMantencion - countCompra;
                    const countHoy = todayResult.count || 0;

                    // 6. Actualizar KPIs
                    DOM.kpiMantencion.textContent = countMantencion;
                    DOM.kpiCompra.textContent = countCompra;
                    DOM.kpiHoy.textContent = countHoy;
                    DOM.kpiOk.textContent = countOk >= 0 ? countOk : 0;

                    // 7. Obtener tendencias (simuladas por ahora)
                    // En una implementación real, se calcularían comparando con días anteriores
                    DOM.kpiOkTrend.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                    <span>2% desde ayer</span>`;
                    DOM.kpiMantencionTrend.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                    <span>3% desde ayer</span>`;
                    DOM.kpiCompraTrend.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                    </svg>
                    <span>Sin cambios</span>`;
                    DOM.kpiHoyTrend.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                    <span>5% desde ayer</span>`;

                    // Actualizar contador de total
                    const chartTotalCount = document.getElementById('chart-total-count');
                    if (chartTotalCount) chartTotalCount.textContent = `Total: ${totalBuses} buses`;

                    // 8. Actualizar gráfico de estado
                    updateEstadoChart(countOk, countMantencion, countCompra);

                    // 9. Cargar datos para otros elementos del dashboard
                    await Promise.all([
                        loadProximosVencimientos(),
                        loadTerminalDistribution(),
                        loadActividadReciente(),
                        loadNecesidadesCriticas()
                    ]);

                } catch (error) {
                    console.error("Error dashboard:", error);
                    showNotification(`Error al cargar dashboard: ${error.message}`, 'error');
                }
            }

            /**
             * Actualiza gráfico de estado de extintores
             * @param {number} countOk - Cantidad en buen estado
             * @param {number} countMantencion - Cantidad que requieren mantención
             * @param {number} countCompra - Cantidad que requieren compra
             */
            function updateEstadoChart(countOk, countMantencion, countCompra) {
                if (!DOM.extintorEstadoChart) return;

                // Destruir gráfico existente si hay uno
                if (chartInstances.estadoExtintor) {
                    chartInstances.estadoExtintor.destroy();
                }

                // Colores para tema claro y oscuro
                const colors = isDarkMode
                    ? ['#34d399', '#fbbf24', '#f87171'] // Verde, Ámbar, Rojo para tema oscuro
                    : ['#10b981', '#f59e0b', '#ef4444']; // Verde, Ámbar, Rojo para tema claro

                const borderColor = isDarkMode ? '#1f2937' : '#ffffff';

                const ctx = DOM.extintorEstadoChart.getContext('2d');

                chartInstances.estadoExtintor = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['OK', 'Mantención', 'Compra'],
                        datasets: [{
                            label: 'Estado',
                            data: [countOk, countMantencion, countCompra],
                            backgroundColor: colors,
                            borderColor: borderColor,
                            borderWidth: 2,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    boxWidth: 15,
                                    font: {
                                        size: 12
                                    },
                                    color: isDarkMode ? '#f3f4f6' : '#1f2937'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const value = context.raw;
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        cutout: '65%',
                        animation: {
                            animateScale: true,
                            animateRotate: true
                        }
                    }
                });
            }

            /**
             * Carga distribución por terminal
             */
            async function loadTerminalDistribution() {
                if (!DOM.terminalDistribucionChart || !supabaseClient) return;

                try {
                    // Destruir gráfico existente si hay uno
                    if (chartInstances.terminalDistribucion) {
                        chartInstances.terminalDistribucion.destroy();
                    }

                    // Terminal seleccionado
                    const selectedTerminalId = DOM.dashboardFilterTerminal?.value || '';

                    // Consultar distribución por terminal
                    let query = supabaseClient
                        .from('CatastroExtintor_vista_necesidades')
                        .select('terminal_nombre, terminal_id, requiere_compra, requiere_mantencion');

                    if (selectedTerminalId) {
                        query = query.eq('terminal_id', selectedTerminalId);
                    }

                    const { data, error } = await query;

                    if (error) throw error;

                    // Agrupar por terminal
                    const terminalStats = {};

                    data.forEach(item => {
                        const terminalNombre = item.terminal_nombre;

                        if (!terminalStats[terminalNombre]) {
                            terminalStats[terminalNombre] = {
                                ok: 0,
                                mantencion: 0,
                                compra: 0
                            };
                        }

                        if (item.requiere_compra) {
                            terminalStats[terminalNombre].compra++;
                        } else if (item.requiere_mantencion) {
                            terminalStats[terminalNombre].mantencion++;
                        } else {
                            terminalStats[terminalNombre].ok++;
                        }
                    });

                    // Preparar datos para el gráfico
                    const terminales = Object.keys(terminalStats);
                    const datasets = [
                        {
                            label: 'OK',
                            data: terminales.map(t => terminalStats[t].ok),
                            backgroundColor: isDarkMode ? 'rgba(52, 211, 153, 0.8)' : 'rgba(16, 185, 129, 0.8)',
                            borderColor: isDarkMode ? 'rgba(52, 211, 153, 1)' : 'rgba(16, 185, 129, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Mantención',
                            data: terminales.map(t => terminalStats[t].mantencion),
                            backgroundColor: isDarkMode ? 'rgba(251, 191, 36, 0.8)' : 'rgba(245, 158, 11, 0.8)',
                            borderColor: isDarkMode ? 'rgba(251, 191, 36, 1)' : 'rgba(245, 158, 11, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Compra',
                            data: terminales.map(t => terminalStats[t].compra),
                            backgroundColor: isDarkMode ? 'rgba(248, 113, 113, 0.8)' : 'rgba(239, 68, 68, 0.8)',
                            borderColor: isDarkMode ? 'rgba(248, 113, 113, 1)' : 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }
                    ];

                    // Crear gráfico
                    const ctx = DOM.terminalDistribucionChart.getContext('2d');

                    chartInstances.terminalDistribucion = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: terminales,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    stacked: true,
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        color: isDarkMode ? '#d1d5db' : '#4b5563',
                                        font: {
                                            size: 10
                                        }
                                    }
                                },
                                y: {
                                    stacked: true,
                                    beginAtZero: true,
                                    grid: {
                                        color: isDarkMode ? 'rgba(75, 85, 99, 0.2)' : 'rgba(229, 231, 235, 0.5)'
                                    },
                                    ticks: {
                                        color: isDarkMode ? '#d1d5db' : '#4b5563',
                                        precision: 0
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 20,
                                        boxWidth: 12,
                                        color: isDarkMode ? '#f3f4f6' : '#1f2937'
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false
                                }
                            },
                            animation: {
                                duration: 1000
                            }
                        }
                    });

                } catch (error) {
                    console.error("Error cargando distribución por terminal:", error);
                    // Silenciar error para no interrumpir otras funcionalidades del dashboard
                }
            }

            /**
             * Carga próximos vencimientos
             */
            async function loadProximosVencimientos() {
                if (!DOM.proximosVencimientosContainer || !supabaseClient) return;

                showLoadingMessage(DOM.proximosVencimientosContainer, 'Cargando próximos vencimientos...');

                try {
                    // Terminal seleccionado
                    const selectedTerminalId = DOM.dashboardFilterTerminal?.value || '';

                    // Fecha actual
                    const today = new Date();

                    // Consultar vencimientos próximos (próximos 3 meses)
                    let nextThreeMonths = new Date(today);
                    nextThreeMonths.setMonth(today.getMonth() + 3);

                    let query = supabaseClient
                        .from('CatastroExtintor_inspecciones')
                        .select(`
                        id, fecha_inspeccion, vencimiento_mes, vencimiento_ano,
                        bus:CatastroExtintor_buses!inner (
                            ppu, numero_interno,
                            terminal:CatastroExtintor_terminales (
                                id, nombre
                            )
                        )
                    `)
                        .eq('extintor_estado', 'Tiene')
                        .not('vencimiento_mes', 'is', null)
                        .not('vencimiento_ano', 'is', null)
                        .order('vencimiento_ano')
                        .order('vencimiento_mes')
                        .limit(10);

                    if (selectedTerminalId) {
                        query = query.eq('bus.terminal.id', selectedTerminalId, { foreignTable: 'CatastroExtintor_buses.terminal' });
                    }

                    const { data, error } = await query;

                    if (error) throw error;

                    // Filtrar y ordenar vencimientos
                    const vencimientos = data
                        .filter(item => {
                            // Verificar si tiene fecha de vencimiento
                            if (!item.vencimiento_mes || !item.vencimiento_ano) return false;

                            // Crear fecha de vencimiento (último día del mes)
                            const venceDate = new Date(item.vencimiento_ano, item.vencimiento_mes - 1 + 1, 0);

                            // Solo incluir si vence en los próximos 3 meses o ya venció (para advertencias)
                            return venceDate <= nextThreeMonths;
                        })
                        .map(item => {
                            // Calcular días hasta vencimiento
                            const venceDate = new Date(item.vencimiento_ano, item.vencimiento_mes - 1 + 1, 0);
                            const diffTime = venceDate.getTime() - today.getTime();
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                            return {
                                ...item,
                                venceDate,
                                diasHastaVencimiento: diffDays
                            };
                        })
                        .sort((a, b) => a.diasHastaVencimiento - b.diasHastaVencimiento);

                    // Guardar para uso en otras funciones
                    vencimientosData = vencimientos;

                    // Mostrar vencimientos
                    if (vencimientos.length === 0) {
                        DOM.proximosVencimientosContainer.innerHTML = `
                        <div class="flex items-center justify-center h-72 text-gray-500 dark:text-gray-400">
                            <div class="text-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <p>No hay vencimientos próximos.</p>
                            </div>
                        </div>`;
                        return;
                    }

                    let html = '<div class="space-y-3 max-h-72 overflow-y-auto pr-1">';

                    vencimientos.forEach(item => {
                        const venceStr = `${String(item.vencimiento_mes).padStart(2, '0')}/${item.vencimiento_ano}`;
                        let statusClass, statusText, statusIcon, alertLevel;

                        // Determinar nivel de alerta
                        if (item.diasHastaVencimiento < 0) {
                            statusClass = 'bg-red-100 dark:bg-red-900/30 border-red-300 dark:border-red-700 text-red-700 dark:text-red-300';
                            statusText = `Vencido hace ${Math.abs(item.diasHastaVencimiento)} días`;
                            statusIcon = `<svg class="h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`;
                            alertLevel = 'critico';
                        } else if (item.diasHastaVencimiento < 30) {
                            statusClass = 'bg-amber-100 dark:bg-amber-900/30 border-amber-300 dark:border-amber-700 text-amber-700 dark:text-amber-300';
                            statusText = `Vence en ${item.diasHastaVencimiento} días`;
                            statusIcon = `<svg class="h-5 w-5 text-amber-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 5a1 1 0 011 1v3a1 1 0 11-2 0V6a1 1 0 011-1zm1 5a1 1 0 10-2 0v2a1 1 0 102 0v-2z" clip-rule="evenodd" /></svg>`;
                            alertLevel = 'urgente';
                        } else if (item.diasHastaVencimiento < 60) {
                            statusClass = 'bg-blue-100 dark:bg-blue-900/30 border-blue-300 dark:border-blue-700 text-blue-700 dark:text-blue-300';
                            statusText = `Vence en ${item.diasHastaVencimiento} días`;
                            statusIcon = `<svg class="h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>`;
                            alertLevel = 'proximamente';
                        } else {
                            statusClass = 'bg-gray-100 dark:bg-gray-800 border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300';
                            statusText = `Vence en ${item.diasHastaVencimiento} días`;
                            statusIcon = `<svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 9.586V6z" clip-rule="evenodd" /></svg>`;
                            alertLevel = 'normal';
                        }

                        html += `
                        <div class="p-3 rounded-lg border ${statusClass} ${alertLevel === 'critico' ? 'animate-pulse' : ''}" data-level="${alertLevel}">
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    ${statusIcon}
                                </div>
                                <div class="ml-3 flex-1">
                                    <div class="flex justify-between items-start">
                                        <p class="text-sm font-medium">Bus ${item.bus.ppu}</p>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${statusClass}">${venceStr}</span>
                                    </div>
                                    <div class="mt-1 flex justify-between items-center">
                                        <p class="text-xs">${item.bus.terminal.nombre} - N° ${item.bus.numero_interno || 'N/A'}</p>
                                        <span class="text-xs">${statusText}</span>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    });

                    html += '</div>';
                    DOM.proximosVencimientosContainer.innerHTML = html;

                } catch (error) {
                    console.error("Error cargando próximos vencimientos:", error);
                    DOM.proximosVencimientosContainer.innerHTML = `
                    <div class="flex items-center justify-center h-72 text-red-500 dark:text-red-400">
                        <div class="text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p>Error al cargar vencimientos.</p>
                            <p class="text-xs mt-1">${error.message}</p>
                        </div>
                    </div>`;
                }
            }

            /**
             * Carga actividad reciente
             */
            async function loadActividadReciente() {
                if (!DOM.actividadRecienteBody || !supabaseClient) return;

                DOM.actividadRecienteBody.innerHTML = `
                <tr class="animate-pulse">
                    <td colspan="5" class="px-3 py-10 text-center text-gray-500 dark:text-gray-400">
                        Cargando actividad reciente...
                    </td>
                </tr>`;

                try {
                    // Terminal seleccionado
                    const selectedTerminalId = DOM.dashboardFilterTerminal?.value || '';

                    // Consultar actividad reciente (últimas 5 inspecciones)
                    let query = supabaseClient
                        .from('CatastroExtintor_inspecciones')
                        .select(`
                        id, fecha_inspeccion, extintor_estado, vencimiento_mes, vencimiento_ano,
                        bus:CatastroExtintor_buses!inner (
                            ppu, numero_interno,
                            terminal:CatastroExtintor_terminales (
                                id, nombre
                            )
                        )
                    `)
                        .order('fecha_inspeccion', { ascending: false })
                        .limit(5);

                    if (selectedTerminalId) {
                        query = query.eq('bus.terminal.id', selectedTerminalId, { foreignTable: 'CatastroExtintor_buses.terminal' });
                    }

                    const { data, error } = await query;

                    if (error) throw error;

                    // Mostrar actividad reciente
                    if (data.length === 0) {
                        DOM.actividadRecienteBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-3 py-10 text-center text-gray-500 dark:text-gray-400">
                                No hay actividad reciente.
                            </td>
                        </tr>`;
                        return;
                    }

                    DOM.actividadRecienteBody.innerHTML = '';

                    data.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';

                        // Determinar estado
                        let estadoHtml;

                        if (item.extintor_estado === 'No Tiene') {
                            estadoHtml = `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300">Sin Extintor</span>`;
                        } else if (item.vencimiento_mes && item.vencimiento_ano) {
                            const venceDate = new Date(item.vencimiento_ano, item.vencimiento_mes - 1 + 1, 0);
                            const hoy = new Date();
                            const isExpired = venceDate < hoy;

                            if (isExpired) {
                                estadoHtml = `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300">Vencido</span>`;
                            } else {
                                estadoHtml = `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300">OK</span>`;
                            }
                        } else {
                            estadoHtml = `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">Sin Datos</span>`;
                        }

                        tr.innerHTML = `
                        <td class="px-3 py-3 whitespace-nowrap">
                            <div class="flex items-center">
                                <div>
                                    <div class="text-sm font-medium text-gray-900 dark:text-white">${item.bus.ppu}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">N° ${item.bus.numero_interno || 'N/A'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap">
                            <div class="text-sm text-gray-900 dark:text-white">${item.bus.terminal.nombre}</div>
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap">
                            <div class="text-sm text-gray-900 dark:text-white">${formatSimpleDate(item.fecha_inspeccion)}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${new Date(item.fecha_inspeccion).toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' })}</div>
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap">
                            ${estadoHtml}
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-right">
                            <button data-ppu="${item.bus.ppu}" class="view-details-button text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs font-medium">
                                Ver Detalles
                            </button>
                        </td>`;

                        DOM.actividadRecienteBody.appendChild(tr);
                    });

                } catch (error) {
                    console.error("Error cargando actividad reciente:", error);
                    DOM.actividadRecienteBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-3 py-6 text-center">
                            <div class="bg-red-50 dark:bg-red-900/30 p-3 rounded-md border border-red-200 dark:border-red-900 inline-block text-red-500 dark:text-red-400">
                                Error al cargar actividad reciente. ${error.message}
                            </div>
                        </td>
                    </tr>`;
                }
            }

            /**
             * Carga necesidades críticas
             */
            async function loadNecesidadesCriticas() {
                if (!DOM.necesidadesContainer || !supabaseClient) return;

                DOM.necesidadesContainer.innerHTML = `
                <div class="animate-pulse flex space-x-4">
                    <div class="flex-1 space-y-4 py-1">
                        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
                        <div class="space-y-2">
                            <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded"></div>
                            <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-5/6"></div>
                        </div>
                    </div>
                </div>`;

                try {
                    // Terminal seleccionado
                    const selectedTerminalId = DOM.dashboardFilterTerminal?.value || '';

                    // Consultar necesidades críticas
                    let query = supabaseClient
                        .from('CatastroExtintor_vista_necesidades')
                        .select(`
                        bus_ppu, numero_interno, terminal_nombre, terminal_id,
                        fecha_inspeccion, requiere_compra, requiere_mantencion,
                        detalle_problema, extintor_estado, vencimiento_mes, vencimiento_ano
                    `)
                        .or('requiere_compra.eq.true,requiere_mantencion.eq.true')
                        .order('requiere_compra', { ascending: false }) // Primero los que requieren compra
                        .order('terminal_nombre')
                        .order('numero_interno')
                        .limit(6);

                    if (selectedTerminalId) {
                        query = query.eq('terminal_id', selectedTerminalId);
                    }

                    const { data, error } = await query;

                    if (error) throw error;

                    // Mostrar necesidades críticas
                    if (data.length === 0) {
                        DOM.necesidadesContainer.innerHTML = `
                        <div class="col-span-full flex items-center justify-center py-10">
                            <div class="text-center text-gray-500 dark:text-gray-400">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <p>¡No hay necesidades críticas pendientes!</p>
                            </div>
                        </div>`;
                        return;
                    }

                    DOM.necesidadesContainer.innerHTML = '';

                    data.forEach(item => {
                        const card = document.createElement('div');
                        const isCompra = item.requiere_compra;
                        const borderClass = isCompra ? 'border-l-4 border-l-red-500' : 'border-l-4 border-l-amber-500';
                        const bgClass = isCompra ? 'bg-red-50 dark:bg-red-900/10' : 'bg-amber-50 dark:bg-amber-900/10';
                        const iconColor = isCompra ? 'text-red-500 dark:text-red-400' : 'text-amber-500 dark:text-amber-400';
                        const iconSvg = isCompra
                            ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`
                            : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`;

                        // Construir texto detalle
                        let detalleTexto = 'Se requiere ';

                        if (isCompra) {
                            detalleTexto += 'adquirir extintor (no presente)';
                        } else {
                            if (item.detalle_problema) {
                                detalleTexto += item.detalle_problema;
                            } else {
                                detalleTexto += 'revisión de ';

                                const problemas = [];

                                // Verificar fecha vencimiento
                                if (item.vencimiento_mes && item.vencimiento_ano) {
                                    const venceDate = new Date(item.vencimiento_ano, item.vencimiento_mes - 1 + 1, 0);
                                    const hoy = new Date();
                                    if (venceDate < hoy) {
                                        problemas.push('vencimiento');
                                    }
                                }

                                // Otros posibles problemas
                                if (item.certificacion_estado && (item.certificacion_estado === 'DAÑADO' || item.certificacion_estado === 'NO TIENE')) {
                                    problemas.push('certificación');
                                }

                                if (item.sonda_estado && item.sonda_estado !== 'Tiene') {
                                    problemas.push('sonda/manguera');
                                }

                                if (item.manometro_estado && item.manometro_estado !== 'Tiene') {
                                    problemas.push('manómetro');
                                }

                                if (item.portaextintor_estado && item.portaextintor_estado !== 'Tiene') {
                                    problemas.push('soporte');
                                }

                                detalleTexto += problemas.join(', ');
                            }
                        }

                        card.className = `report-card ${bgClass} ${borderClass}`;
                        card.innerHTML = `
                        <div class="flex">
                            <div class="flex-shrink-0">
                                ${iconSvg}
                            </div>
                            <div class="ml-4 flex-1">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-sm font-medium text-gray-900 dark:text-white">Bus ${item.bus_ppu}</h3>
                                        <p class="text-xs text-gray-600 dark:text-gray-400">${item.terminal_nombre} - N° ${item.numero_interno || 'N/A'}</p>
                                    </div>
                                    <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full ${isCompra ? 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300' : 'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300'}">
                                        ${isCompra ? 'COMPRA' : 'MANTENCIÓN'}
                                    </span>
                                </div>
                                <p class="mt-1 text-xs text-gray-600 dark:text-gray-400">
                                    ${detalleTexto}
                                </p>
                                <div class="mt-2 flex justify-end">
                                    <button data-ppu="${item.bus_ppu}" class="view-details-button text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium">
                                        Ver Detalles
                                    </button>
                                </div>
                            </div>
                        </div>`;

                        DOM.necesidadesContainer.appendChild(card);
                    });

                } catch (error) {
                    console.error("Error cargando necesidades críticas:", error);
                    DOM.necesidadesContainer.innerHTML = `
                    <div class="col-span-full p-4 bg-red-50 dark:bg-red-900/30 rounded-lg border border-red-200 dark:border-red-900 text-center text-red-500 dark:text-red-400">
                        Error al cargar necesidades críticas. ${error.message}
                    </div>`;
                }
            }

            // --- Lógica Alertas ---

            /**
             * Actualiza el contador de alertas
             */
            async function updateAlertasCounter() {
                if (!DOM.alertasBadge || !DOM.notificationBadge || !supabaseClient) return;

                try {
                    // Contar alertas activas
                    const { data, error, count } = await supabaseClient
                        .from('CatastroExtintor_vista_necesidades')
                        .select('*', { count: 'exact', head: true })
                        .or('requiere_compra.eq.true,requiere_mantencion.eq.true');

                    if (error) throw error;

                    const alertCount = count || 0;

                    // Actualizar badges
                    DOM.alertasBadge.textContent = alertCount;
                    DOM.alertasBadge.classList.toggle('hidden', alertCount === 0);

                    DOM.notificationBadge.textContent = alertCount;
                    DOM.notificationBadge.classList.toggle('hidden', alertCount === 0);

                    // Actualizar título con conteo si hay alertas
                    if (alertCount > 0 && document.title.indexOf('(') === -1) {
                        document.title = `(${alertCount}) Catastro Extintores Pro`;
                    } else if (alertCount === 0 && document.title.indexOf('(') !== -1) {
                        document.title = 'Catastro Extintores Pro';
                    }

                    return alertCount;

                } catch (error) {
                    console.error("Error actualizando contador de alertas:", error);
                    return 0;
                }
            }

            /**
             * Obtiene filtros actuales de alertas
             * @returns {Object} - Filtros aplicados
             */
            function getCurrentFiltersAlertas() {
                return {
                    terminal: DOM.alertasFilterTerminal?.value || '',
                    tipo: DOM.alertasFilterTipo?.value || ''
                };
            }

            /**
             * Carga alertas con filtros
             * @param {Object} filters - Filtros aplicados
             * @param {number} page - Número de página
             */
            async function loadAlertas(filters = {}, page = 1) {
                if (!DOM.alertasContainer || !supabaseClient || !DOM.alertasCriticas || !DOM.alertasAdvertencias || !DOM.alertasInformativas) return;

                DOM.alertasContainer.innerHTML = `
                <div class="animate-pulse space-y-4">
                    <div class="h-20 bg-gray-200 dark:bg-gray-700 rounded"></div>
                    <div class="h-20 bg-gray-200 dark:bg-gray-700 rounded"></div>
                    <div class="h-20 bg-gray-200 dark:bg-gray-700 rounded"></div>
                </div>`;

                alertasCurrentPage = page;

                try {
                    // Contar por tipo de alerta primero
                    // Estos conteos no se filtran por terminal para mostrar totales generales
                    const countPromises = [
                        // Alertas críticas (compra)
                        supabaseClient
                            .from('CatastroExtintor_vista_necesidades')
                            .select('*', { count: 'exact', head: true })
                            .eq('requiere_compra', true),

                        // Alertas advertencias (mantenimiento)
                        supabaseClient
                            .from('CatastroExtintor_vista_necesidades')
                            .select('*', { count: 'exact', head: true })
                            .eq('requiere_mantencion', true)
                            .eq('requiere_compra', false),

                        // Alertas informativas (próximos vencimientos 60-90 días)
                        getProximosVencimientosCount()
                    ];

                    const [criticasResult, advertenciasResult, informativasCount] = await Promise.all(countPromises);

                    if (criticasResult.error) throw criticasResult.error;
                    if (advertenciasResult.error) throw advertenciasResult.error;

                    const criticasCount = criticasResult.count || 0;
                    const advertenciasCount = advertenciasResult.count || 0;

                    // Actualizar contadores
                    DOM.alertasCriticas.textContent = criticasCount;
                    DOM.alertasAdvertencias.textContent = advertenciasCount;
                    DOM.alertasInformativas.textContent = informativasCount;

                    // Consultar alertas con filtros
                    let query = supabaseClient
                        .from('CatastroExtintor_vista_necesidades')
                        .select(`
                        bus_ppu, numero_interno, terminal_nombre, terminal_id,
                        fecha_inspeccion, requiere_compra, requiere_mantencion,
                        detalle_problema, extintor_estado, vencimiento_mes, vencimiento_ano,
                        certificacion_estado, sonda_estado, manometro_estado, portaextintor_estado
                    `, { count: 'exact' })
                        .or('requiere_compra.eq.true,requiere_mantencion.eq.true')
                        .order('requiere_compra', { ascending: false }) // Compra primero
                        .order('terminal_nombre')
                        .order('numero_interno');

                    if (filters.terminal) {
                        query = query.eq('terminal_id', filters.terminal);
                    }

                    if (filters.tipo === 'critica') {
                        query = query.eq('requiere_compra', true);
                    } else if (filters.tipo === 'advertencia') {
                        query = query.eq('requiere_mantencion', true)
                            .eq('requiere_compra', false);
                    } else if (filters.tipo === 'informativa') {
                        // Para alertas informativas, tenemos que obtener los próximos vencimientos
                        const proximosVencimientos = await getProximosVencimientos(filters.terminal);
                        showAlertasProximosVencimientos(proximosVencimientos, page);
                        return;
                    }

                    // Aplicar paginación
                    const startIndex = (page - 1) * PAGE_SIZE;
                    const endIndex = page * PAGE_SIZE - 1;
                    query = query.range(startIndex, endIndex);

                    const { data, error, count } = await query;

                    if (error) throw error;

                    alertasData = data || [];
                    alertasTotalRecords = count || 0;
                    alertasTotalPages = Math.ceil(alertasTotalRecords / PAGE_SIZE);

                    // Mostrar alertas
                    showAlertas(data, page);

                } catch (error) {
                    console.error("Error cargando alertas:", error);
                    DOM.alertasContainer.innerHTML = `
                    <div class="p-4 bg-red-50 dark:bg-red-900/30 rounded-lg border border-red-200 dark:border-red-900 text-center text-red-500 dark:text-red-400">
                        Error al cargar alertas. ${error.message}
                    </div>`;
                    updateAlertasPaginationControls(1, 1, 0);
                }
            }

            /**
             * Obtiene el conteo de próximos vencimientos
             * @returns {Promise<number>} - Número de vencimientos próximos
             */
            async function getProximosVencimientosCount() {
                try {
                    // Fecha actual
                    const today = new Date();

                    // Consultar vencimientos entre 60-90 días
                    let startDate = new Date(today);
                    startDate.setDate(today.getDate() + 60);

                    let endDate = new Date(today);
                    endDate.setDate(today.getDate() + 90);

                    // Convertir a mes/año para la consulta
                    const startMonth = startDate.getMonth() + 1;
                    const startYear = startDate.getFullYear();
                    const endMonth = endDate.getMonth() + 1;
                    const endYear = endDate.getFullYear();

                    // Esta consulta es aproximada ya que no podemos comparar directamente fechas
                    const query = `
                    vencimiento_ano > ${today.getFullYear()} OR 
                    (vencimiento_ano = ${today.getFullYear()} AND vencimiento_mes > ${today.getMonth() + 1}) AND
                    (vencimiento_ano < ${endYear} OR 
                    (vencimiento_ano = ${endYear} AND vencimiento_mes <= ${endMonth}))
                `;

                    const { count, error } = await supabaseClient
                        .from('CatastroExtintor_inspecciones')
                        .select('*', { count: 'exact', head: true })
                        .eq('extintor_estado', 'Tiene')
                        .not('vencimiento_mes', 'is', null)
                        .not('vencimiento_ano', 'is', null)
                        .or(query);

                    if (error) throw error;

                    return count || 0;

                } catch (error) {
                    console.error("Error obteniendo conteo de próximos vencimientos:", error);
                    return 0;
                }
            }

            /**
             * Obtiene próximos vencimientos
             * @param {string} terminalId - ID del terminal para filtrar
             * @returns {Promise<Array>} - Lista de próximos vencimientos
             */
            async function getProximosVencimientos(terminalId = '') {
                try {
                    // Fecha actual
                    const today = new Date();

                    // Consultar vencimientos entre 60-90 días
                    let startDate = new Date(today);
                    startDate.setDate(today.getDate() + 60);

                    let endDate = new Date(today);
                    endDate.setDate(today.getDate() + 90);

                    // Consulta con JOIN para obtener datos de bus y terminal
                    let query = supabaseClient
                        .from('CatastroExtintor_inspecciones')
                        .select(`
                        id, fecha_inspeccion, vencimiento_mes, vencimiento_ano,
                        bus:CatastroExtintor_buses!inner (
                            ppu, numero_interno, terminal_id,
                            terminal:CatastroExtintor_terminales (
                                id, nombre
                            )
                        )
                    `)
                        .eq('extintor_estado', 'Tiene')
                        .not('vencimiento_mes', 'is', null)
                        .not('vencimiento_ano', 'is', null)
                        .order('vencimiento_ano')
                        .order('vencimiento_mes');

                    if (terminalId) {
                        query = query.eq('bus.terminal_id', terminalId);
                    }

                    const { data, error } = await query;

                    if (error) throw error;

                    // Filtrar vencimientos en rango 60-90 días
                    const vencimientosProximos = data.filter(item => {
                        // Crear fecha de vencimiento (último día del mes)
                        const venceDate = new Date(item.vencimiento_ano, item.vencimiento_mes, 0);

                        // Calcular días hasta vencimiento
                        const diffTime = venceDate.getTime() - today.getTime();
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        // Solo incluir si vence en 60-90 días
                        return diffDays >= 60 && diffDays <= 90;
                    });

                    return vencimientosProximos;

                } catch (error) {
                    console.error("Error obteniendo próximos vencimientos:", error);
                    return [];
                }
            }

            /**
             * Muestra alertas en el contenedor
             * @param {Array} data - Datos de alertas
             * @param {number} page - Número de página
             */
            function showAlertas(data, page) {
                if (!DOM.alertasContainer || !DOM.alertasShowing || !DOM.alertasTotal) return;

                // Actualizar información de paginación
                DOM.alertasShowing.textContent = data.length;
                DOM.alertasTotal.textContent = alertasTotalRecords;

                // Si no hay alertas
                if (data.length === 0) {
                    DOM.alertasContainer.innerHTML = `
                    <div class="flex items-center justify-center py-12 text-gray-500 dark:text-gray-400">
                        <div class="text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-400 dark:text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p class="text-xl font-medium mb-2">No hay alertas activas</p>
                            <p class="text-sm">Todos los extintores están en buen estado y vigentes.</p>
                        </div>
                    </div>`;
                    updateAlertasPaginationControls(1, 1, 0);
                    return;
                }

                // Mostrar alertas
                DOM.alertasContainer.innerHTML = '';

                data.forEach(item => {
                    const alerta = document.createElement('div');
                    const isCompra = item.requiere_compra;
                    const borderClass = isCompra
                        ? 'border-l-4 border-l-red-500 bg-red-50 dark:bg-red-900/10'
                        : 'border-l-4 border-l-amber-500 bg-amber-50 dark:bg-amber-900/10';

                    let detalleTexto = '';
                    let accionesRecomendadas = '';

                    if (isCompra) {
                        detalleTexto = 'Extintor no presente en el vehículo.';
                        accionesRecomendadas = `
                        <div class="mt-2 p-3 bg-white dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-700">
                            <h5 class="text-sm font-medium text-gray-900 dark:text-white mb-1">Acciones Recomendadas:</h5>
                            <ul class="text-xs text-gray-600 dark:text-gray-400 list-disc list-inside">
                                <li>Adquirir extintor según normativa</li>
                                <li>Verificar porta extintor (soporte)</li>
                                <li>Programar inspección de seguimiento</li>
                            </ul>
                        </div>
                    `;
                    } else {
                        let razonMantencion = [];

                        // Verificar fecha vencimiento
                        if (item.vencimiento_mes && item.vencimiento_ano) {
                            const venceDate = new Date(item.vencimiento_ano, item.vencimiento_mes - 1 + 1, 0);
                            const hoy = new Date();
                            if (venceDate < hoy) {
                                razonMantencion.push('Extintor vencido');
                            }
                        }

                        // Otros problemas
                        if (item.certificacion_estado && (item.certificacion_estado === 'DAÑADO' || item.certificacion_estado === 'NO TIENE')) {
                            razonMantencion.push('Certificación ' + item.certificacion_estado.toLowerCase());
                        }

                        if (item.sonda_estado && item.sonda_estado !== 'Tiene') {
                            razonMantencion.push('Sonda/manguera ' + item.sonda_estado.toLowerCase());
                        }

                        if (item.manometro_estado && item.manometro_estado !== 'Tiene') {
                            razonMantencion.push('Manómetro ' + item.manometro_estado.toLowerCase());
                        }

                        if (item.portaextintor_estado && item.portaextintor_estado !== 'Tiene') {
                            razonMantencion.push('Soporte ' + item.portaextintor_estado.toLowerCase());
                        }

                        detalleTexto = razonMantencion.join(' • ');

                        accionesRecomendadas = `
                        <div class="mt-2 p-3 bg-white dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-700">
                            <h5 class="text-sm font-medium text-gray-900 dark:text-white mb-1">Acciones Recomendadas:</h5>
                            <ul class="text-xs text-gray-600 dark:text-gray-400 list-disc list-inside">
                                ${razonMantencion.includes('Extintor vencido') ? '<li>Recargar/renovar certificación del extintor</li>' : ''}
                                ${razonMantencion.some(r => r.includes('Certificación')) ? '<li>Verificar/renovar sellos de certificación</li>' : ''}
                                ${razonMantencion.some(r => r.includes('Sonda') || r.includes('manguera')) ? '<li>Revisar/reparar manguera y boquilla</li>' : ''}
                                ${razonMantencion.some(r => r.includes('Manómetro')) ? '<li>Verificar presión y condición del manómetro</li>' : ''}
                                ${razonMantencion.some(r => r.includes('Soporte')) ? '<li>Instalar/reparar soporte de extintor</li>' : ''}
                                <li>Programar inspección de seguimiento</li>
                            </ul>
                        </div>
                    `;
                    }

                    alerta.className = `p-4 rounded-lg border ${borderClass} mb-4`;
                    alerta.innerHTML = `
                    <div class="flex flex-col md:flex-row md:items-start gap-4">
                        <div class="flex-shrink-0 ${isCompra ? 'text-red-500 dark:text-red-400' : 'text-amber-500 dark:text-amber-400'}">
                            ${isCompra ?
                            `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>` :
                            `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>`
                        }
                        </div>
                        <div class="flex-1">
                            <div class="flex flex-col md:flex-row md:items-center justify-between mb-2">
                                <div>
                                    <h3 class="text-base font-medium text-gray-900 dark:text-white flex items-center gap-2">
                                        ${isCompra ?
                            `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300">CRÍTICA</span>` :
                            `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300">ADVERTENCIA</span>`
                        }
                                        Bus ${item.bus_ppu}
                                    </h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">${item.terminal_nombre} - N° ${item.numero_interno || 'N/A'}</p>
                                </div>
                                <div class="mt-2 md:mt-0 text-sm text-gray-500 dark:text-gray-400">
                                    Última inspección: ${formatSimpleDate(item.fecha_inspeccion)}
                                </div>
                            </div>
                            
                            <div class="p-3 bg-white dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-700">
                                <p class="text-sm text-gray-900 dark:text-white">
                                    <span class="font-medium">Problema:</span> 
                                    ${isCompra ? 'Se requiere compra urgente.' : 'Se requiere mantención.'}
                                </p>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                    ${detalleTexto}
                                </p>
                            </div>
                            
                            ${accionesRecomendadas}
                            
                            <div class="mt-3 flex justify-end space-x-3">
                                <button data-ppu="${item.bus_ppu}" class="view-details-button text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium">
                                    Ver historial completo
                                </button>
                                <a href="#" data-view="registrar" data-ppu="${item.bus_ppu}" class="goto-register-button text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium">
                                    Registrar inspección
                                </a>
                            </div>
                        </div>
                    </div>
                `;

                    DOM.alertasContainer.appendChild(alerta);
                });

                // Actualizar controles de paginación
                updateAlertasPaginationControls(page, alertasTotalPages, alertasTotalRecords);
            }

            /**
             * Muestra alertas de próximos vencimientos
             * @param {Array} vencimientos - Lista de vencimientos
             * @param {number} page - Número de página
             */
            function showAlertasProximosVencimientos(vencimientos, page) {
                if (!DOM.alertasContainer || !DOM.alertasShowing || !DOM.alertasTotal) return;

                // Aplicar paginación
                const startIndex = (page - 1) * PAGE_SIZE;
                const endIndex = Math.min(page * PAGE_SIZE, vencimientos.length);
                const paginatedVencimientos = vencimientos.slice(startIndex, endIndex);

                // Actualizar información de paginación
                DOM.alertasShowing.textContent = paginatedVencimientos.length;
                DOM.alertasTotal.textContent = vencimientos.length;

                alertasTotalRecords = vencimientos.length;
                alertasTotalPages = Math.ceil(alertasTotalRecords / PAGE_SIZE);

                // Si no hay vencimientos
                if (vencimientos.length === 0) {
                    DOM.alertasContainer.innerHTML = `
                    <div class="flex items-center justify-center py-12 text-gray-500 dark:text-gray-400">
                        <div class="text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-400 dark:text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p class="text-xl font-medium mb-2">No hay vencimientos próximos</p>
                            <p class="text-sm">No se encontraron extintores que venzan en los próximos 60-90 días.</p>
                        </div>
                    </div>`;
                    updateAlertasPaginationControls(1, 1, 0);
                    return;
                }

                // Mostrar vencimientos
                DOM.alertasContainer.innerHTML = '';

                // Fecha actual
                const today = new Date();

                paginatedVencimientos.forEach(item => {
                    const alerta = document.createElement('div');

                    // Calcular días hasta vencimiento
                    const venceDate = new Date(item.vencimiento_ano, item.vencimiento_mes - 1, 1);
                    const ultimoDia = new Date(item.vencimiento_ano, item.vencimiento_mes, 0);

                    const diffTime = ultimoDia.getTime() - today.getTime();
                    const diasRestantes = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    alerta.className = 'p-4 rounded-lg border border-l-4 border-l-blue-500 bg-blue-50 dark:bg-blue-900/10 mb-4';
                    alerta.innerHTML = `
                    <div class="flex flex-col md:flex-row md:items-start gap-4">
                        <div class="flex-shrink-0 text-blue-500 dark:text-blue-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="flex flex-col md:flex-row md:items-center justify-between mb-2">
                                <div>
                                    <h3 class="text-base font-medium text-gray-900 dark:text-white flex items-center gap-2">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300">INFO</span>
                                        Bus ${item.bus.ppu}
                                    </h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">${item.bus.terminal.nombre} - N° ${item.bus.numero_interno || 'N/A'}</p>
                                </div>
                                <div class="mt-2 md:mt-0 text-sm text-gray-500 dark:text-gray-400">
                                    Última inspección: ${formatSimpleDate(item.fecha_inspeccion)}
                                </div>
                            </div>
                            
                            <div class="p-3 bg-white dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-700">
                                <p class="text-sm text-gray-900 dark:text-white">
                                    <span class="font-medium">Próximo vencimiento:</span> 
                                    ${String(item.vencimiento_mes).padStart(2, '0')}/${item.vencimiento_ano}
                                </p>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                    El extintor vence en <span class="font-medium text-blue-600 dark:text-blue-400">${diasRestantes} días</span>. Se recomienda programar reemplazo o mantenimiento.
                                </p>
                            </div>
                            
                            <div class="mt-2 p-3 bg-white dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-700">
                                <h5 class="text-sm font-medium text-gray-900 dark:text-white mb-1">Acciones Recomendadas:</h5>
                                <ul class="text-xs text-gray-600 dark:text-gray-400 list-disc list-inside">
                                    <li>Programar mantenimiento preventivo antes del vencimiento</li>
                                    <li>Coordinar con proveedor para recarga o reemplazo</li>
                                    <li>Actualizar registro después del mantenimiento</li>
                                </ul>
                            </div>
                            
                            <div class="mt-3 flex justify-end space-x-3">
                                <button data-ppu="${item.bus.ppu}" class="view-details-button text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium">
                                    Ver historial completo
                                </button>
                                <a href="#" data-view="registrar" data-ppu="${item.bus.ppu}" class="goto-register-button text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium">
                                    Registrar inspección
                                </a>
                            </div>
                        </div>
                    </div>
                `;

                    DOM.alertasContainer.appendChild(alerta);
                });

                // Actualizar controles de paginación
                updateAlertasPaginationControls(page, alertasTotalPages, alertasTotalRecords);
            }

            /**
             * Actualiza controles de paginación para alertas
             * @param {number} currentPage - Página actual
             * @param {number} totalPages - Total de páginas
             * @param {number} totalRecords - Total de registros
             */
            function updateAlertasPaginationControls(currentPage, totalPages, totalRecords) {
                if (!DOM.alertasPagination || !DOM.alertasPrevPage || !DOM.alertasNextPage || !DOM.alertasPageNumbers) return;

                alertasCurrentPage = currentPage;

                if (totalRecords === 0) {
                    DOM.alertasPagination.classList.add('hidden');
                    return;
                }

                DOM.alertasPagination.classList.remove('hidden');

                // Habilitar/deshabilitar botones de navegación
                DOM.alertasPrevPage.disabled = currentPage <= 1;
                DOM.alertasNextPage.disabled = currentPage >= totalPages;

                // Generar números de página
                DOM.alertasPageNumbers.innerHTML = '';

                // Mostrar un máximo de 5 páginas
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, startPage + 4);

                if (endPage - startPage < 4 && totalPages > 4) {
                    startPage = Math.max(1, endPage - 4);
                }

                // Añadir primera página si no está en el rango
                if (startPage > 1) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `btn btn-sm ${1 === currentPage ? 'btn-primary' : 'btn-light'} px-3`;
                    pageBtn.textContent = '1';
                    pageBtn.addEventListener('click', () => loadAlertas(getCurrentFiltersAlertas(), 1));
                    DOM.alertasPageNumbers.appendChild(pageBtn);

                    // Añadir elipsis si hay un salto
                    if (startPage > 2) {
                        const elipsis = document.createElement('span');
                        elipsis.className = 'px-2 text-gray-500 dark:text-gray-400';
                        elipsis.textContent = '...';
                        DOM.alertasPageNumbers.appendChild(elipsis);
                    }
                }

                // Añadir páginas del rango
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-light'} px-3`;
                    pageBtn.textContent = i;
                    pageBtn.addEventListener('click', () => loadAlertas(getCurrentFiltersAlertas(), i));
                    DOM.alertasPageNumbers.appendChild(pageBtn);
                }

                // Añadir última página si no está en el rango
                if (endPage < totalPages) {
                    // Añadir elipsis si hay un salto
                    if (endPage < totalPages - 1) {
                        const elipsis = document.createElement('span');
                        elipsis.className = 'px-2 text-gray-500 dark:text-gray-400';
                        elipsis.textContent = '...';
                        DOM.alertasPageNumbers.appendChild(elipsis);
                    }

                    const pageBtn = document.createElement('button');
                    pageBtn.className = `btn btn-sm ${totalPages === currentPage ? 'btn-primary' : 'btn-light'} px-3`;
                    pageBtn.textContent = totalPages;
                    pageBtn.addEventListener('click', () => loadAlertas(getCurrentFiltersAlertas(), totalPages));
                    DOM.alertasPageNumbers.appendChild(pageBtn);
                }
            }

            // --- Lógica Reportes ---

            /**
             * Genera reportes
             */
            async function generarReporte() {
                if (!DOM.reporteTerminalSelect || !DOM.reporteTipoSelect || !DOM.reporteContenido || !supabaseClient || !DOM.reporteTitulo || !DOM.reporteMetadata || !DOM.imprimirReporteBtn || !DOM.exportarReporteBtn) return;

                const terminalId = DOM.reporteTerminalSelect.value;
                const tipoReporte = DOM.reporteTipoSelect.value;

                showLoadingMessage(DOM.reporteContenido, 'Generando reporte...');
                DOM.reporteTitulo.textContent = 'Reporte';
                DOM.reporteMetadata.textContent = '';
                DOM.imprimirReporteBtn.disabled = true;
                DOM.exportarReporteBtn.disabled = true;

                try {
                    let query;
                    let tituloReporte = '';
                    let fechaGen = new Date().toLocaleString('es-CL');
                    let terminalNombre = terminalId ? terminalesData.find(t => t.id == terminalId)?.nombre : 'Todos';

                    // Actualizar metadata
                    DOM.reporteMetadata.textContent = `Generado: ${fechaGen} | Terminal: ${terminalNombre || 'Todos'}`;

                    switch (tipoReporte) {
                        case 'necesidades':
                            tituloReporte = `Reporte de Necesidades (Mantención/Compra)`;
                            await generarReporteNecesidades(terminalId);
                            break;
                        case 'estado_general':
                            tituloReporte = `Reporte Estado General Flota`;
                            await generarReporteEstadoGeneral(terminalId);
                            break;
                        case 'vencimientos':
                            tituloReporte = `Reporte de Próximos Vencimientos`;
                            await generarReporteVencimientos(terminalId);
                            break;
                        case 'inspecciones_recientes':
                            tituloReporte = `Reporte de Inspecciones Recientes`;
                            await generarReporteInspeccionesRecientes(terminalId);
                            break;
                        default:
                            throw new Error('Tipo de reporte no soportado');
                    }

                    DOM.reporteTitulo.textContent = tituloReporte;
                    DOM.imprimirReporteBtn.disabled = false;
                    DOM.exportarReporteBtn.disabled = false;

                } catch (error) {
                    console.error("Error generando reporte:", error);
                    showNotification(`Error al generar reporte: ${error.message}`, 'error');
                    DOM.reporteContenido.innerHTML = `
                    <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-md p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800 dark:text-red-300">Error al generar reporte</h3>
                                <div class="mt-2 text-sm text-red-700 dark:text-red-200">
                                    <p>${error.message}</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }
            }

            /**
             * Genera reporte de necesidades
             * @param {string} terminalId - ID del terminal
             */
            async function generarReporteNecesidades(terminalId) {
                // Consulta base
                let query = supabaseClient
                    .from('CatastroExtintor_vista_necesidades')
                    .select('bus_ppu, numero_interno, terminal_nombre, requiere_compra, requiere_mantencion, detalle_problema, fecha_inspeccion, extintor_estado, vencimiento_mes, vencimiento_ano, certificacion_estado, sonda_estado, manometro_estado, portaextintor_estado')
                    .or('requiere_compra.eq.true,requiere_mantencion.eq.true')
                    .order('terminal_nombre')
                    .order('requiere_compra', { ascending: false })
                    .order('numero_interno');

                // Filtrar por terminal
                if (terminalId) {
                    query = query.eq('terminal_id', terminalId);
                }

                const { data, error } = await query;

                if (error) throw error;

                if (!data || data.length === 0) {
                    DOM.reporteContenido.innerHTML = `
                    <div class="flex items-center justify-center py-10 text-gray-500 dark:text-gray-400">
                        <div class="text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h4 class="text-xl font-medium mb-2">¡Sin necesidades pendientes!</h4>
                            <p>No se encontraron buses que requieran mantenimiento o compra.</p>
                        </div>
                    </div>`;
                    return;
                }

                // Agrupar por terminal
                const busesGroups = {};

                data.forEach(bus => {
                    const terminal = bus.terminal_nombre;

                    if (!busesGroups[terminal]) {
                        busesGroups[terminal] = {
                            compra: [],
                            mantencion: []
                        };
                    }

                    if (bus.requiere_compra) {
                        busesGroups[terminal].compra.push(bus);
                    } else if (bus.requiere_mantencion) {
                        busesGroups[terminal].mantencion.push(bus);
                    }
                });

                let totalCompra = 0;
                let totalMantencion = 0;

                let html = `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Resumen</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="p-4 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg">
                            <h4 class="text-base font-medium text-red-800 dark:text-red-300 mb-1">Buses que Requieren Compra</h4>
                            <div class="flex items-end">
                                <span class="text-2xl font-bold text-red-600 dark:text-red-400" id="count-compra">--</span>
                                <span class="ml-2 text-sm text-red-500 dark:text-red-500">buses</span>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800 rounded-lg">
                            <h4 class="text-base font-medium text-amber-800 dark:text-amber-300 mb-1">Buses que Requieren Mantención</h4>
                            <div class="flex items-end">
                                <span class="text-2xl font-bold text-amber-600 dark:text-amber-400" id="count-mantencion">--</span>
                                <span class="ml-2 text-sm text-amber-500 dark:text-amber-500">buses</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

                // Generar tabla por terminal
                Object.keys(busesGroups).forEach(terminal => {
                    const compra = busesGroups[terminal].compra;
                    const mantencion = busesGroups[terminal].mantencion;

                    totalCompra += compra.length;
                    totalMantencion += mantencion.length;

                    if (compra.length === 0 && mantencion.length === 0) return;

                    html += `
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 pb-1 border-b border-gray-200 dark:border-gray-700">Terminal: ${terminal}</h3>
                `;

                    // Sección de compra
                    if (compra.length > 0) {
                        html += `
                        <div class="mb-4">
                            <h4 class="text-base font-medium text-red-600 dark:text-red-400 mb-2">Requieren Compra (${compra.length})</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-700 text-sm">
                                    <thead class="bg-gray-50 dark:bg-gray-800">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Bus</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">N° Int.</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Última Insp.</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    `;

                        compra.forEach(bus => {
                            html += `
                            <tr>
                                <td class="px-6 py-2">${bus.bus_ppu}</td>
                                <td class="px-6 py-2">${bus.numero_interno || 'N/A'}</td>
                                <td class="px-6 py-2">${formatDate(bus.fecha_inspeccion)}</td>
                                <td class="px-6 py-2">
                                    <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300">Sin Extintor</span>
                                </td>
                            </tr>
                        `;
                        });

                        html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    }

                    // Sección de mantención
                    if (mantencion.length > 0) {
                        html += `
                        <div class="mb-4">
                            <h4 class="text-base font-medium text-amber-600 dark:text-amber-400 mb-2">Requieren Mantención (${mantencion.length})</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-700 text-sm">
                                    <thead class="bg-gray-50 dark:bg-gray-800">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Bus</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">N° Int.</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Última Insp.</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Problema</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    `;

                        mantencion.forEach(bus => {
                            const problemas = [];

                            // Verificar fecha vencimiento
                            if (bus.vencimiento_mes && bus.vencimiento_ano) {
                                const venceDate = new Date(bus.vencimiento_ano, bus.vencimiento_mes - 1 + 1, 0);
                                const hoy = new Date();
                                if (venceDate < hoy) {
                                    problemas.push('Vencido');
                                }
                            }

                            // Otros posibles problemas
                            if (bus.certificacion_estado && (bus.certificacion_estado === 'DAÑADO' || bus.certificacion_estado === 'NO TIENE')) {
                                problemas.push('Cert. ' + bus.certificacion_estado);
                            }

                            if (bus.sonda_estado && bus.sonda_estado !== 'Tiene') {
                                problemas.push('Sonda ' + bus.sonda_estado);
                            }

                            if (bus.manometro_estado && bus.manometro_estado !== 'Tiene') {
                                problemas.push('Manóm. ' + bus.manometro_estado);
                            }

                            if (bus.portaextintor_estado && bus.portaextintor_estado !== 'Tiene') {
                                problemas.push('Soporte ' + bus.portaextintor_estado);
                            }

                            const problema = problemas.join(' • ');

                            html += `
                            <tr>
                                <td class="px-6 py-2">${bus.bus_ppu}</td>
                                <td class="px-6 py-2">${bus.numero_interno || 'N/A'}</td>
                                <td class="px-6 py-2">${formatDate(bus.fecha_inspeccion)}</td>
                                <td class="px-6 py-2">${problema}</td>
                            </tr>
                        `;
                        });

                        html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    }

                    html += '</div>';
                });

                html += `
                <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 text-sm">
                    <p class="font-medium text-gray-700 dark:text-gray-300">Resumen General:</p>
                    <ul class="mt-2 list-disc list-inside text-gray-600 dark:text-gray-400">
                        <li>Total Buses que Requieren Compra: <strong>${totalCompra}</strong></li>
                        <li>Total Buses que Requieren Mantención: <strong>${totalMantencion}</strong></li>
                        <li>Total Necesidades: <strong>${totalCompra + totalMantencion}</strong></li>
                    </ul>
                </div>
            `;

                DOM.reporteContenido.innerHTML = html;

                // Actualizar contadores
                document.getElementById('count-compra').textContent = totalCompra;
                document.getElementById('count-mantencion').textContent = totalMantencion;
            }

            /**
             * Genera reporte de estado general
             * @param {string} terminalId - ID del terminal
             */
            async function generarReporteEstadoGeneral(terminalId) {
                // Consulta base
                let query = supabaseClient
                    .from('CatastroExtintor_vista_estado_actual')
                    .select('bus_ppu, numero_interno, terminal_nombre, fecha_inspeccion, extintor_estado, vencimiento_mes, vencimiento_ano, certificacion_estado, manometro_estado, sonda_estado, portaextintor_estado')
                    .order('terminal_nombre')
                    .order('numero_interno');

                // Filtrar por terminal
                if (terminalId) {
                    query = query.eq('terminal_id', terminalId);
                }

                const { data, error } = await query;

                if (error) throw error;

                if (!data || data.length === 0) {
                    DOM.reporteContenido.innerHTML = `
                    <div class="flex items-center justify-center py-10 text-gray-500 dark:text-gray-400">
                        <div class="text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            <p>No se encontraron datos para este reporte.</p>
                        </div>
                    </div>`;
                    return;
                }

                // Agrupar por terminal
                const busesGroups = {};

                data.forEach(bus => {
                    const terminal = bus.terminal_nombre;

                    if (!busesGroups[terminal]) {
                        busesGroups[terminal] = [];
                    }

                    busesGroups[terminal].push(bus);
                });

                // Estadísticas generales
                let totalBuses = data.length;
                let totalTiene = data.filter(b => b.extintor_estado === 'Tiene').length;
                let totalNoTiene = data.filter(b => b.extintor_estado === 'No Tiene').length;
                let totalVencidos = data.filter(b => {
                    if (b.extintor_estado !== 'Tiene' || !b.vencimiento_mes || !b.vencimiento_ano) return false;
                    const venceDate = new Date(b.vencimiento_ano, b.vencimiento_mes - 1 + 1, 0);
                    const hoy = new Date();
                    return venceDate < hoy;
                }).length;

                let html = `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Resumen General</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div class="p-4 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg">
                            <h4 class="text-base font-medium text-blue-800 dark:text-blue-300 mb-1">Total Buses</h4>
                            <div class="flex items-end">
                                <span class="text-2xl font-bold text-blue-600 dark:text-blue-400">${totalBuses}</span>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-lg">
                            <h4 class="text-base font-medium text-green-800 dark:text-green-300 mb-1">Con Extintor</h4>
                            <div class="flex items-end">
                                <span class="text-2xl font-bold text-green-600 dark:text-green-400">${totalTiene}</span>
                                <span class="ml-2 text-sm text-green-500 dark:text-green-500">${Math.round(totalTiene / totalBuses * 100)}%</span>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg">
                            <h4 class="text-base font-medium text-red-800 dark:text-red-300 mb-1">Sin Extintor</h4>
                            <div class="flex items-end">
                                <span class="text-2xl font-bold text-red-600 dark:text-red-400">${totalNoTiene}</span>
                                <span class="ml-2 text-sm text-red-500 dark:text-red-500">${Math.round(totalNoTiene / totalBuses * 100)}%</span>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800 rounded-lg">
                            <h4 class="text-base font-medium text-amber-800 dark:text-amber-300 mb-1">Vencidos</h4>
                            <div class="flex items-end">
                                <span class="text-2xl font-bold text-amber-600 dark:text-amber-400">${totalVencidos}</span>
                                <span class="ml-2 text-sm text-amber-500 dark:text-amber-500">${Math.round(totalVencidos / totalTiene * 100)}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

                // Generar tabla por terminal
                Object.keys(busesGroups).forEach(terminal => {
                    const buses = busesGroups[terminal];

                    html += `
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 pb-1 border-b border-gray-200 dark:border-gray-700">Terminal: ${terminal} (${buses.length} buses)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-700 text-sm">
                                <thead class="bg-gray-50 dark:bg-gray-800">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Bus</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">N° Int.</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Última Insp.</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Estado</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Vence</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Cert.</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Sonda</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Manóm.</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                `;

                    buses.forEach(bus => {
                        // Determinar si está vencido
                        let vencido = false;
                        let venceClass = '';
                        let venceStr = 'N/A';

                        if (bus.extintor_estado === 'Tiene' && bus.vencimiento_mes && bus.vencimiento_ano) {
                            venceStr = `${String(bus.vencimiento_mes).padStart(2, '0')}/${bus.vencimiento_ano}`;
                            const venceDate = new Date(bus.vencimiento_ano, bus.vencimiento_mes - 1 + 1, 0);
                            const hoy = new Date();
                            vencido = venceDate < hoy;
                            if (vencido) {
                                venceClass = 'text-red-600 dark:text-red-400 font-medium';
                            }
                        }

                        // Determinar estado general
                        let estadoHtml;

                        if (bus.extintor_estado === 'No Tiene') {
                            estadoHtml = `<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300">Sin Extintor</span>`;
                        } else if (vencido) {
                            estadoHtml = `<span class="px-2 py-1 text-xs rounded-full bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300">Vencido</span>`;
                        } else if (bus.manometro_estado !== 'Tiene' || bus.sonda_estado !== 'Tiene' || bus.certificacion_estado === 'DAÑADO' || bus.certificacion_estado === 'NO TIENE' || bus.portaextintor_estado !== 'Tiene') {
                            estadoHtml = `<span class="px-2 py-1 text-xs rounded-full bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300">Mantención</span>`;
                        } else {
                            estadoHtml = `<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300">OK</span>`;
                        }

                        html += `
                        <tr>
                            <td class="px-6 py-2">${bus.bus_ppu}</td>
                            <td class="px-6 py-2">${bus.numero_interno || 'N/A'}</td>
                            <td class="px-6 py-2">${formatDate(bus.fecha_inspeccion)}</td>
                            <td class="px-6 py-2">${estadoHtml}</td>
                            <td class="px-6 py-2 ${venceClass}">${venceStr}</td>
                            <td class="px-6 py-2">${bus.certificacion_estado || 'N/A'}</td>
                            <td class="px-6 py-2">${bus.sonda_estado || 'N/A'}</td>
                            <td class="px-6 py-2">${bus.manometro_estado || 'N/A'}</td>
                        </tr>
                    `;
                    });

                    html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                });

                DOM.reporteContenido.innerHTML = html;
            }

            /**
             * Genera reporte de vencimientos
             * @param {string} terminalId - ID del terminal
             */
            async function generarReporteVencimientos(terminalId) {
                // Obtener fecha actual
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();

                // Crear intervalos de vencimiento
                const intervals = [
                    { name: 'Vencidos', startMonth: null, startYear: null, endMonth: currentMonth, endYear: currentYear },
                    { name: '1-3 meses', startMonth: currentMonth + 1, startYear: currentYear, endMonth: currentMonth + 3, endYear: currentYear },
                    { name: '4-6 meses', startMonth: currentMonth + 4, startYear: currentYear, endMonth: currentMonth + 6, endYear: currentYear },
                    { name: '7-12 meses', startMonth: currentMonth + 7, startYear: currentYear, endMonth: currentMonth + 12, endYear: currentYear },
                    { name: '> 12 meses', startMonth: currentMonth + 13, startYear: currentYear, endMonth: null, endYear: null }
                ];

                // Ajustar meses que excedan 12
                intervals.forEach(interval => {
                    if (interval.startMonth && interval.startMonth > 12) {
                        interval.startYear++;
                        interval.startMonth -= 12;
                    }
                    if (interval.endMonth && interval.endMonth > 12) {
                        interval.endYear++;
                        interval.endMonth -= 12;
                    }
                });

                // Consulta base
                let query = supabaseClient
                    .from('CatastroExtintor_inspecciones')
                    .select(`
                    id, fecha_inspeccion, extintor_estado, vencimiento_mes, vencimiento_ano,
                    bus:CatastroExtintor_buses!inner (
                        ppu, numero_interno,
                        terminal:CatastroExtintor_terminales (
                            id, nombre
                        )
                    )
                `)
                    .eq('extintor_estado', 'Tiene')
                    .not('vencimiento_mes', 'is', null)
                    .not('vencimiento_ano', 'is', null)
                    .order('vencimiento_ano')
                    .order('vencimiento_mes');

                // Filtrar por terminal
                if (terminalId) {
                    query = query.eq('bus.terminal.id', terminalId, { foreignTable: 'CatastroExtintor_buses.terminal' });
                }

                const { data, error } = await query;

                if (error) throw error;

                if (!data || data.length === 0) {
                    DOM.reporteContenido.innerHTML = `
                    <div class="flex items-center justify-center py-10 text-gray-500 dark:text-gray-400">
                        <div class="text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p>No se encontraron datos de vencimientos.</p>
                        </div>
                    </div>`;
                    return;
                }

                // Agrupar vencimientos por intervalo
                const intervalBuses = intervals.map(interval => {
                    return {
                        ...interval,
                        buses: data.filter(bus => {
                            const venceMonth = bus.vencimiento_mes;
                            const venceYear = bus.vencimiento_ano;

                            // Para vencidos
                            if (interval.name === 'Vencidos') {
                                if (venceYear < currentYear) return true;
                                if (venceYear === currentYear && venceMonth <= currentMonth) return true;
                                return false;
                            }

                            // Para más de 12 meses
                            if (interval.name === '> 12 meses') {
                                if (venceYear > interval.startYear) return true;
                                if (venceYear === interval.startYear && venceMonth >= interval.startMonth) return true;
                                return false;
                            }

                            // Para intervalos intermedios
                            if (venceYear < interval.startYear || venceYear > interval.endYear) return false;
                            if (venceYear === interval.startYear && venceMonth < interval.startMonth) return false;
                            if (venceYear === interval.endYear && venceMonth > interval.endMonth) return false;
                            return true;
                        })
                    };
                });

                // Agrupar por terminales para resumen
                const terminalGroup = {};

                data.forEach(item => {
                    const terminal = item.bus.terminal.nombre;
                    const venceMonth = item.vencimiento_mes;
                    const venceYear = item.vencimiento_ano;

                    if (!terminalGroup[terminal]) {
                        terminalGroup[terminal] = {
                            vencidos: 0,
                            proximosMes: 0,
                            proximosTrimestre: 0,
                            proximosSemestre: 0,
                            masSemestre: 0,
                            total: 0
                        };
                    }

                    // Calcular grupo
                    terminalGroup[terminal].total++;

                    if (venceYear < currentYear || (venceYear === currentYear && venceMonth <= currentMonth)) {
                        terminalGroup[terminal].vencidos++;
                    } else if (venceYear === currentYear && venceMonth <= currentMonth + 1) {
                        terminalGroup[terminal].proximosMes++;
                    } else if (venceYear === currentYear && venceMonth <= currentMonth + 3) {
                        terminalGroup[terminal].proximosTrimestre++;
                    } else if (venceYear === currentYear && venceMonth <= currentMonth + 6) {
                        terminalGroup[terminal].proximosSemestre++;
                    } else {
                        terminalGroup[terminal].masSemestre++;
                    }
                });

                // Crear HTML del reporte
                let html = `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Resumen de Vencimientos</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                        <div class="p-4 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg">
                            <h4 class="text-base font-medium text-red-800 dark:text-red-300 mb-1">Vencidos</h4>
                            <div class="flex items-end">
                                <span class="text-2xl font-bold text-red-600 dark:text-red-400">${intervalBuses[0].buses.length}</span>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800 rounded-lg">
                            <h4 class="text-base font-medium text-amber-800 dark:text-amber-300 mb-1">1-3 meses</h4>
                            <div class="flex items-end">
                                <span class="text-2xl font-bold text-amber-600 dark:text-amber-400">${intervalBuses[1].buses.length}</span>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                            <h4 class="text-base font-medium text-yellow-800 dark:text-yellow-300 mb-1">4-6 meses</h4>
                            <div class="flex items-end">
                                <span class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">${intervalBuses[2].buses.length}</span>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-lg">
                            <h4 class="text-base font-medium text-green-800 dark:text-green-300 mb-1">7-12 meses</h4>
                            <div class="flex items-end">
                                <span class="text-2xl font-bold text-green-600 dark:text-green-400">${intervalBuses[3].buses.length}</span>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg">
                            <h4 class="text-base font-medium text-blue-800 dark:text-blue-300 mb-1">> 12 meses</h4>
                            <div class="flex items-end">
                                <span class="text-2xl font-bold text-blue-600 dark:text-blue-400">${intervalBuses[4].buses.length}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Resumen por Terminal</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-700 text-sm">
                            <thead class="bg-gray-50 dark:bg-gray-800">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Terminal</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Vencidos</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">1-3 meses</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">4-6 meses</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">7-12 meses</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">> 12 meses</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Total</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            `;

                // Agregar filas de resumen por terminal
                Object.keys(terminalGroup).forEach(terminal => {
                    const group = terminalGroup[terminal];

                    html += `
                    <tr>
                        <td class="px-6 py-2 font-medium">${terminal}</td>
                        <td class="px-6 py-2 text-red-600 dark:text-red-400">${group.vencidos}</td>
                        <td class="px-6 py-2 text-amber-600 dark:text-amber-400">${group.proximosMes + group.proximosTrimestre}</td>
                        <td class="px-6 py-2 text-yellow-600 dark:text-yellow-400">${group.proximosSemestre}</td>
                        <td class="px-6 py-2 text-green-600 dark:text-green-400">${group.masSemestre / 2}</td>
                        <td class="px-6 py-2 text-blue-600 dark:text-blue-400">${group.masSemestre / 2}</td>
                        <td class="px-6 py-2 font-medium">${group.total}</td>
                    </tr>
                `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

                // Detalles por grupo de vencimiento
                intervalBuses.forEach(interval => {
                    if (interval.buses.length === 0) return;

                    let bgClass = 'bg-blue-50 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800';
                    let textClass = 'text-blue-800 dark:text-blue-300';

                    switch (interval.name) {
                        case 'Vencidos':
                            bgClass = 'bg-red-50 dark:bg-red-900/30 border-red-200 dark:border-red-800';
                            textClass = 'text-red-800 dark:text-red-300';
                            break;
                        case '1-3 meses':
                            bgClass = 'bg-amber-50 dark:bg-amber-900/30 border-amber-200 dark:border-amber-800';
                            textClass = 'text-amber-800 dark:text-amber-300';
                            break;
                        case '4-6 meses':
                            bgClass = 'bg-yellow-50 dark:bg-yellow-900/30 border-yellow-200 dark:border-yellow-800';
                            textClass = 'text-yellow-800 dark:text-yellow-300';
                            break;
                        case '7-12 meses':
                            bgClass = 'bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-800';
                            textClass = 'text-green-800 dark:text-green-300';
                            break;
                    }

                    html += `
                    <div class="mb-8">
                        <div class="mb-4 p-3 rounded-lg ${bgClass}">
                            <h3 class="text-lg font-semibold ${textClass}">${interval.name} (${interval.buses.length} buses)</h3>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-700 text-sm">
                                <thead class="bg-gray-50 dark:bg-gray-800">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Bus</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">N° Int.</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Terminal</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Vence</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Última Insp.</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                `;

                    interval.buses.forEach(bus => {
                        const venceStr = `${String(bus.vencimiento_mes).padStart(2, '0')}/${bus.vencimiento_ano}`;
                        const venceClass = interval.name === 'Vencidos' ? 'text-red-600 dark:text-red-400 font-medium' : '';

                        html += `
                        <tr>
                            <td class="px-6 py-2">${bus.bus.ppu}</td>
                            <td class="px-6 py-2">${bus.bus.numero_interno || 'N/A'}</td>
                            <td class="px-6 py-2">${bus.bus.terminal.nombre}</td>
                            <td class="px-6 py-2 ${venceClass}">${venceStr}</td>
                            <td class="px-6 py-2">${formatDate(bus.fecha_inspeccion)}</td>
                        </tr>
                    `;
                    });

                    html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                });

                DOM.reporteContenido.innerHTML = html;
            }

            /**
             * Genera reporte de inspecciones recientes
             * @param {string} terminalId - ID del terminal
             */
            async function generarReporteInspeccionesRecientes(terminalId) {
                // Obtener fecha de hace 30 días
                const fecha30Dias = new Date();
                fecha30Dias.setDate(fecha30Dias.getDate() - 30);

                // Consulta base
                let query = supabaseClient
                    .from('CatastroExtintor_inspecciones')
                    .select(`
                    id, fecha_inspeccion, extintor_estado, vencimiento_mes, vencimiento_ano,
                    certificacion_estado, sonda_estado, manometro_estado, portaextintor_estado,
                    observaciones,
                    bus:CatastroExtintor_buses!inner (
                        ppu, numero_interno,
                        terminal:CatastroExtintor_terminales (
                            id, nombre
                        )
                    )
                `)
                    .gte('fecha_inspeccion', fecha30Dias.toISOString())
                    .order('fecha_inspeccion', { ascending: false });

                // Filtrar por terminal
                if (terminalId) {
                    query = query.eq('bus.terminal.id', terminalId, { foreignTable: 'CatastroExtintor_buses.terminal' });
                }

                const { data, error } = await query;

                if (error) throw error;

                if (!data || data.length === 0) {
                    DOM.reporteContenido.innerHTML = `
                    <div class="flex items-center justify-center py-10 text-gray-500 dark:text-gray-400">
                        <div class="text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p>No se encontraron inspecciones recientes (últimos 30 días).</p>
                        </div>
                    </div>`;
                    return;
                }

                // Agrupar por día
                const diasGroup = {};

                data.forEach(insp => {
                    const fechaInsp = new Date(insp.fecha_inspeccion);
                    const fechaKey = fechaInsp.toISOString().split('T')[0];

                    if (!diasGroup[fechaKey]) {
                        diasGroup[fechaKey] = [];
                    }

                    diasGroup[fechaKey].push(insp);
                });

                // Agrupar por terminal para resumen
                const terminalGroup = {};
                const estadoGroup = {
                    total: data.length,
                    tiene: data.filter(i => i.extintor_estado === 'Tiene').length,
                    noTiene: data.filter(i => i.extintor_estado === 'No Tiene').length
                };

                data.forEach(insp => {
                    const terminal = insp.bus.terminal.nombre;

                    if (!terminalGroup[terminal]) {
                        terminalGroup[terminal] = {
                            total: 0,
                            tiene: 0,
                            noTiene: 0
                        };
                    }

                    terminalGroup[terminal].total++;

                    if (insp.extintor_estado === 'Tiene') {
                        terminalGroup[terminal].tiene++;
                    } else {
                        terminalGroup[terminal].noTiene++;
                    }
                });

                // Crear HTML del reporte
                let html = `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Resumen de Inspecciones (últimos 30 días)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                        <div class="p-4 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg">
                            <h4 class="text-base font-medium text-blue-800 dark:text-blue-300 mb-1">Total Inspecciones</h4>
                            <div class="flex items-end">
                                <span class="text-2xl font-bold text-blue-600 dark:text-blue-400">${estadoGroup.total}</span>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-lg">
                            <h4 class="text-base font-medium text-green-800 dark:text-green-300 mb-1">Con Extintor</h4>
                            <div class="flex items-end">
                                <span class="text-2xl font-bold text-green-600 dark:text-green-400">${estadoGroup.tiene}</span>
                                <span class="ml-2 text-sm text-green-500 dark:text-green-500">${Math.round(estadoGroup.tiene / estadoGroup.total * 100)}%</span>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg">
                            <h4 class="text-base font-medium text-red-800 dark:text-red-300 mb-1">Sin Extintor</h4>
                            <div class="flex items-end">
                                <span class="text-2xl font-bold text-red-600 dark:text-red-400">${estadoGroup.noTiene}</span>
                                <span class="ml-2 text-sm text-red-500 dark:text-red-500">${Math.round(estadoGroup.noTiene / estadoGroup.total * 100)}%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Inspecciones por Terminal</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-700 text-sm">
                            <thead class="bg-gray-50 dark:bg-gray-800">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Terminal</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Total</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Con Extintor</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Sin Extintor</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">% Con Extintor</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            `;

                // Agregar filas de resumen por terminal
                Object.keys(terminalGroup).forEach(terminal => {
                    const group = terminalGroup[terminal];
                    const porcentaje = Math.round(group.tiene / group.total * 100);

                    html += `
                    <tr>
                        <td class="px-6 py-2 font-medium">${terminal}</td>
                        <td class="px-6 py-2">${group.total}</td>
                        <td class="px-6 py-2 text-green-600 dark:text-green-400">${group.tiene}</td>
                        <td class="px-6 py-2 text-red-600 dark:text-red-400">${group.noTiene}</td>
                        <td class="px-6 py-2">
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                <div class="bg-blue-600 dark:bg-blue-500 h-2.5 rounded-full" style="width: ${porcentaje}%"></div>
                            </div>
                            <span class="text-xs font-medium mt-1 inline-block">${porcentaje}%</span>
                        </td>
                    </tr>
                `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

                // Detalles por día
                const fechas = Object.keys(diasGroup).sort().reverse();

                fechas.forEach(fecha => {
                    const inspecciones = diasGroup[fecha];
                    const fechaFormateada = new Date(fecha).toLocaleDateString('es-CL', { day: '2-digit', month: '2-digit', year: 'numeric', weekday: 'long' });

                    html += `
                    <div class="mb-8">
                        <div class="mb-4 p-3 rounded-lg bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${fechaFormateada} (${inspecciones.length} inspecciones)</h3>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-700 text-sm">
                                <thead class="bg-gray-50 dark:bg-gray-800">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Bus</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">N° Int.</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Terminal</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Estado</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Vence</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Hora</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                `;

                    inspecciones.forEach(insp => {
                        const fecha = new Date(insp.fecha_inspeccion);
                        const hora = fecha.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' });

                        const venceStr = (insp.vencimiento_mes && insp.vencimiento_ano)
                            ? `${String(insp.vencimiento_mes).padStart(2, '0')}/${insp.vencimiento_ano}`
                            : 'N/A';

                        // Determinar estado
                        let estadoHtml;

                        if (insp.extintor_estado === 'No Tiene') {
                            estadoHtml = `<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300">Sin Extintor</span>`;
                        } else {
                            estadoHtml = `<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300">Con Extintor</span>`;
                        }

                        html += `
                        <tr>
                            <td class="px-6 py-2">${insp.bus.ppu}</td>
                            <td class="px-6 py-2">${insp.bus.numero_interno || 'N/A'}</td>
                            <td class="px-6 py-2">${insp.bus.terminal.nombre}</td>
                            <td class="px-6 py-2">${estadoHtml}</td>
                            <td class="px-6 py-2">${venceStr}</td>
                            <td class="px-6 py-2">${hora}</td>
                        </tr>
                    `;
                    });

                    html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                });

                DOM.reporteContenido.innerHTML = html;
            }

            /**
             * Exporta reporte a Excel
             */
            function exportarReporteExcel() {
                // Implementación pendiente
                showNotification('Exportación a Excel en desarrollo', 'info');
            }

            /**
             * Imprime reporte actual
             */
            function imprimirReporte() {
                window.print();
            }

            // --- Lógica Exportar Lista a Excel ---

            /**
             * Exporta lista de inspecciones a Excel
             */
            function exportarListaExcel() {
                if (!inspeccionesData || inspeccionesData.length === 0) {
                    showNotification("No hay datos en la lista para exportar.", "warning");
                    return;
                }

                try {
                    const dataToExport = inspeccionesData.map(insp => ({
                        'PPU': insp.bus?.ppu || insp.bus_ppu || '',
                        'N° Interno': insp.bus?.numero_interno || insp.numero_interno || '',
                        'Terminal': insp.bus?.terminal?.nombre || insp.terminal_nombre || '',
                        'Fecha Inspección': formatDate(insp.fecha_inspeccion),
                        'Extintor': insp.extintor_estado || '',
                        'Vencimiento': (insp.vencimiento_mes && insp.vencimiento_ano) ? `${String(insp.vencimiento_mes).padStart(2, '0')}/${insp.vencimiento_ano}` : '',
                        'Certificación': insp.certificacion_estado || '',
                        'Manómetro': insp.manometro_estado || '',
                        'Sonda': insp.sonda_estado || '',
                        'Portaextintor': insp.portaextintor_estado || '',
                        'Observaciones': insp.observaciones || ''
                    }));

                    const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Historial Inspecciones");

                    // Personalizar ancho de columnas
                    const colWidths = [
                        { wch: 10 }, // PPU
                        { wch: 10 }, // N° Interno
                        { wch: 15 }, // Terminal
                        { wch: 20 }, // Fecha Inspección
                        { wch: 10 }, // Extintor
                        { wch: 12 }, // Vencimiento
                        { wch: 12 }, // Certificación
                        { wch: 10 }, // Manómetro
                        { wch: 10 }, // Sonda
                        { wch: 10 }, // Portaextintor
                        { wch: 40 }  // Observaciones
                    ];

                    worksheet['!cols'] = colWidths;

                    const today = new Date().toISOString().split('T')[0];
                    XLSX.writeFile(workbook, `Historial_Extintores_${today}.xlsx`);

                    showNotification("Lista exportada a Excel correctamente", "success");

                } catch (error) {
                    console.error("Error al exportar a Excel:", error);
                    showNotification(`Error al exportar: ${error.message}`, "error");
                }
            }

            // --- Lógica Popups Informativos ---

            /**
             * Muestra popup informativo
             * @param {string} itemId - ID del elemento
             */
            function showInfoPopup(itemId) {
                const INFO_CONTENT = {
                    certificacion: {
                        title: "Certificación",
                        text: "Verifica el sello de certificación. Opciones: CESMEC, INCEN, DAÑADO (sello roto/ilegible), NO TIENE (sin sello)."
                    },
                    sonda: {
                        title: "Sonda (Manguera/Boquilla)",
                        text: "Revisa la manguera y/o boquilla. Busca grietas, roturas u obstrucciones."
                    },
                    manometro: {
                        title: "Manómetro (Reloj Presión)",
                        text: "Verifica el indicador de presión. 'Tiene (OK)' indica presente y en zona verde. Otras opciones indican problemas."
                    },
                    portaextintor: {
                        title: "Porta Extintor",
                        text: "Asegúrate de que el soporte que fija el extintor esté presente y en buen estado (no roto, suelto o deformado)."
                    }
                };

                if (!DOM.infoPopupModal || !INFO_CONTENT[itemId] || !DOM.infoPopupTitle || !DOM.infoPopupContent || !DOM.infoPopupImage) return;

                const content = INFO_CONTENT[itemId];
                DOM.infoPopupTitle.textContent = content.title;
                DOM.infoPopupContent.textContent = content.text;

                if (content.image) {
                    DOM.infoPopupImage.src = content.image;
                    DOM.infoPopupImage.alt = content.title;
                    DOM.infoPopupImage.classList.remove('hidden');
                } else {
                    DOM.infoPopupImage.classList.add('hidden');
                }

                DOM.infoPopupModal.classList.remove('hidden');
            }

            // --- Llenar Años y Meses Vencimiento ---

            /**
             * Llena el select de años
             */
            function populateYearSelect() {
                if (!DOM.vencimientoAnoSelect) return;

                const startYear = 2020;
                const endYear = CURRENT_YEAR + 5;

                // Guardar valor seleccionado si existe
                const selectedValue = DOM.vencimientoAnoSelect.value;

                DOM.vencimientoAnoSelect.innerHTML = '<option value="">Año</option>';

                for (let year = startYear; year <= endYear; year++) {
                    DOM.vencimientoAnoSelect.appendChild(new Option(year, year));
                }

                // Restaurar valor si es válido
                if (selectedValue && DOM.vencimientoAnoSelect.querySelector(`option[value="${selectedValue}"]`)) {
                    DOM.vencimientoAnoSelect.value = selectedValue;
                }
            }

            /**
             * Llena el select de meses
             */
            function populateMonthSelect() {
                if (!DOM.vencimientoMesSelect) return;

                const selectedValue = DOM.vencimientoMesSelect.value;

                DOM.vencimientoMesSelect.innerHTML = '<option value="">Mes</option>';

                for (let month = 1; month <= 12; month++) {
                    const monthName = new Date(2000, month - 1, 1).toLocaleString('es-CL', { month: 'long' });
                    const capitalizedMonth = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                    DOM.vencimientoMesSelect.appendChild(new Option(`${capitalizedMonth} (${String(month).padStart(2, '0')})`, month));
                }

                if (selectedValue && DOM.vencimientoMesSelect.querySelector(`option[value="${selectedValue}"]`)) {
                    DOM.vencimientoMesSelect.value = selectedValue;
                }
            }

            // --- Modo Oscuro ---

            /**
             * Activa/desactiva el modo oscuro
             */
            function toggleDarkMode() {
                isDarkMode = !isDarkMode;
                document.documentElement.classList.toggle('dark', isDarkMode);
                localStorage.setItem('theme_extintor', isDarkMode ? 'dark' : 'light');

                if (DOM.themeToggleText) DOM.themeToggleText.textContent = isDarkMode ? "Modo Oscuro" : "Modo Claro";
                if (DOM.themeToggleLightIcon) DOM.themeToggleLightIcon.classList.toggle('hidden', isDarkMode);
                if (DOM.themeToggleDarkIcon) DOM.themeToggleDarkIcon.classList.toggle('hidden', !isDarkMode);

                // Actualizar gráficos si es necesario
                if (currentView === 'dashboard') {
                    loadDashboardData();
                }
            }

            /**
             * Inicializa el modo oscuro según preferencias
             */
            function initDarkMode() {
                const storedTheme = localStorage.getItem('theme_extintor');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

                isDarkMode = storedTheme === 'dark' || (!storedTheme && prefersDark);

                document.documentElement.classList.toggle('dark', isDarkMode);

                if (DOM.themeToggleText) DOM.themeToggleText.textContent = isDarkMode ? "Modo Oscuro" : "Modo Claro";
                if (DOM.themeToggleLightIcon) DOM.themeToggleLightIcon.classList.toggle('hidden', isDarkMode);
                if (DOM.themeToggleDarkIcon) DOM.themeToggleDarkIcon.classList.toggle('hidden', !isDarkMode);
            }

            // === INICIALIZACIÓN Y EVENT LISTENERS ===

            document.addEventListener('DOMContentLoaded', () => {
                // Inicializar selectores DOM
                initDOMSelectors();

                // Inicializar Supabase
                initSupabase();

                // Inicializar interfaz
                initUI();

                // Configurar Event Listeners
                setupEventListeners();

                // Cargar datos iniciales
                loadInitialData();

                // Inicializar modo oscuro
                initDarkMode();
            });

            /**
             * Inicializa selectores DOM
             */
            function initDOMSelectors() {
                // Views
                DOM.views = {
                    dashboard: document.getElementById('dashboard-view'),
                    registrar: document.getElementById('registrar-view'),
                    lista: document.getElementById('lista-view'),
                    reportes: document.getElementById('reportes-view'),
                    flota: document.getElementById('flota-view'),
                    analisis: document.getElementById('analisis-view'),
                    alertas: document.getElementById('alertas-view'),
                    configuracion: document.getElementById('configuracion-view')
                };

                // Sidebar elements
                DOM.sidebar = document.getElementById('sidebar');
                DOM.sidebarOverlay = document.getElementById('sidebar-overlay');
                DOM.menuButton = document.getElementById('menu-button');
                DOM.navLinks = document.querySelectorAll('.nav-link');

                // Header elements
                DOM.viewTitle = document.getElementById('view-title');
                DOM.notificationsMenuButton = document.getElementById('notifications-menu-button');
                DOM.notificationBadge = document.getElementById('notification-badge');
                DOM.notificationsDropdown = document.getElementById('notifications-dropdown');
                DOM.notificationsContainer = document.getElementById('notifications-container');
                DOM.quickActionsButton = document.getElementById('quick-actions-button');
                DOM.quickActionsDropdown = document.getElementById('quick-actions-dropdown');

                // Theme elements
                DOM.themeToggle = document.getElementById('theme-toggle');
                DOM.themeToggleText = document.getElementById('theme-toggle-text');
                DOM.themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
                DOM.themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

                // Dashboard elements
                DOM.dashboardFilterTerminal = document.getElementById('dashboard-filter-terminal');
                DOM.dashboardFilterPeriodo = document.getElementById('dashboard-filter-periodo');
                DOM.dashboardRefreshBtn = document.getElementById('dashboard-refresh');
                DOM.kpiMantencion = document.getElementById('kpi-mantencion');
                DOM.kpiCompra = document.getElementById('kpi-compra');
                DOM.kpiHoy = document.getElementById('kpi-hoy');
                DOM.kpiOk = document.getElementById('kpi-ok');
                DOM.kpiOkTrend = document.getElementById('kpi-ok-trend');
                DOM.kpiMantencionTrend = document.getElementById('kpi-mantencion-trend');
                DOM.kpiCompraTrend = document.getElementById('kpi-compra-trend');
                DOM.kpiHoyTrend = document.getElementById('kpi-hoy-trend');
                DOM.extintorEstadoChart = document.getElementById('extintorEstadoChart');
                DOM.terminalDistribucionChart = document.getElementById('terminalDistribucionChart');
                DOM.proximosVencimientosContainer = document.getElementById('proximos-vencimientos-container');
                DOM.actividadRecienteBody = document.getElementById('actividad-reciente-body');
                DOM.necesidadesContainer = document.getElementById('necesidades-container');

                // Registro elements
                DOM.registroForm = document.getElementById('registro-form');
                DOM.terminalSelect = document.getElementById('terminal');
                DOM.terminalErrorContainer = document.getElementById('terminal-error-container');
                DOM.numeroInternoInput = document.getElementById('numero_interno_input');
                DOM.ppuInput = document.getElementById('ppu_input');
                DOM.ppuHiddenInput = document.getElementById('ppu_hidden');
                DOM.busValidationMsg = document.getElementById('bus-validation-msg');
                DOM.ppuErrorContainer = document.getElementById('ppu-error-container');
                DOM.busAlreadyChecked = document.getElementById('bus-already-checked');
                DOM.lastInspectionDate = document.getElementById('last-inspection-date');
                DOM.usePreviousDataBtn = document.getElementById('use-previous-data');
                DOM.createNewInspectionBtn = document.getElementById('create-new-inspection');
                DOM.historialBusBtn = document.getElementById('historial-bus-btn');
                DOM.extintorEstadoRadios = document.querySelectorAll('input[name="extintor_estado"]');
                DOM.extintorDetailsContainer = document.getElementById('extintor-details-container');
                DOM.fotoExtintorContainer = document.getElementById('foto-extintor-container');
                DOM.fotoExtintor = document.getElementById('foto_extintor');
                DOM.previewContainer = document.getElementById('preview-container');
                DOM.previewImage = document.getElementById('preview-image');
                DOM.removeImageBtn = document.getElementById('remove-image');
                DOM.vencimientoMesSelect = document.getElementById('vencimiento_mes');
                DOM.vencimientoAnoSelect = document.getElementById('vencimiento_ano');
                DOM.formMessage = document.getElementById('form-message');
                DOM.submitButton = document.getElementById('submit-button');

                // Lista elements
                DOM.advancedFiltersToggle = document.getElementById('advanced-filters-toggle');
                DOM.advancedFiltersContainer = document.getElementById('advanced-filters-container');
                DOM.searchPpuLista = document.getElementById('search-ppu-lista');
                DOM.filterTerminalLista = document.getElementById('filter-terminal-lista');
                DOM.filterEstadoExtintor = document.getElementById('filter-estado-extintor');
                DOM.filterFechaInicioLista = document.getElementById('filter-fecha-inicio-lista');
                DOM.filterFechaFinLista = document.getElementById('filter-fecha-fin-lista');
                DOM.applyFiltersListaButton = document.getElementById('apply-filters-lista-button');
                DOM.exportListaButton = document.getElementById('export-lista-button');
                DOM.inspeccionesTbody = document.getElementById('inspecciones-tbody');
                DOM.listaErrorContainer = document.getElementById('lista-error-container');
                DOM.paginationControls = document.getElementById('pagination-controls');
                DOM.paginationInfo = document.getElementById('pagination-info');
                DOM.paginationPrev = document.getElementById('pagination-prev');
                DOM.paginationNext = document.getElementById('pagination-next');
                DOM.paginationNumbers = document.getElementById('pagination-numbers');

                // Flota elements
                DOM.flotaFilterTerminal = document.getElementById('flota-filter-terminal');
                DOM.flotaEstadoOk = document.getElementById('flota-estado-ok');
                DOM.flotaEstadoMantencion = document.getElementById('flota-estado-mantencion');
                DOM.flotaEstadoCompra = document.getElementById('flota-estado-compra');
                DOM.flotaEstadoTotal = document.getElementById('flota-estado-total');
                DOM.flotaTbody = document.getElementById('flota-tbody');
                DOM.flotaListaErrorContainer = document.getElementById('flota-lista-error-container');
                DOM.flotaPaginationControls = document.getElementById('flota-pagination-controls');
                DOM.flotaPaginationInfo = document.getElementById('flota-pagination-info');
                DOM.flotaPaginationPrev = document.getElementById('flota-pagination-prev');
                DOM.flotaPaginationNext = document.getElementById('flota-pagination-next');
                DOM.flotaPaginationNumbers = document.getElementById('flota-pagination-numbers');

                // Análisis elements
                DOM.analisisPeriodo = document.getElementById('analisis-periodo');
                DOM.analisisTerminal = document.getElementById('analisis-terminal');
                DOM.analisisFechaInicio = document.getElementById('analisis-fecha-inicio');
                DOM.analisisFechaFin = document.getElementById('analisis-fecha-fin');
                DOM.fechaInicioContainer = document.getElementById('fecha-inicio-container');
                DOM.fechaFinContainer = document.getElementById('fecha-fin-container');
                DOM.analisisFiltrarBtn = document.getElementById('analisis-filtrar');

                console.log("Intentando añadir listener a:", DOM.analisisFiltrarBtn); // Verifica que ahora NO sea null
                if (DOM.analisisFiltrarBtn) {
                    console.log("AÑADIENDO listener de click a generarAnalisisAvanzado"); // Debería aparecer este log
                    DOM.analisisFiltrarBtn.addEventListener('click', generarAnalisisAvanzado);
                } else {
                    console.error("ERROR: No se pudo añadir listener en setupEventListeners, el botón es null."); // Este error ya NO debería aparecer
                }


                DOM.gaugeCompliance = document.getElementById('gauge-compliance');
                DOM.complianceValue = document.getElementById('compliance-value');
                DOM.inspeccionTendenciaChart = document.getElementById('inspeccion-tendencia-chart');
                DOM.necesidadesTipoChart = document.getElementById('necesidades-tipo-chart');
                DOM.vencimientosProyectadosChart = document.getElementById('vencimientos-proyectados-chart');
                DOM.analisisTerminalBody = document.getElementById('analisis-terminal-body');
                DOM.exportAnalisisTerminal = document.getElementById('export-analisis-terminal');

                // Reportes elements
                DOM.reporteTerminalSelect = document.getElementById('reporte-terminal');
                DOM.reporteTipoSelect = document.getElementById('reporte-tipo');
                DOM.fechaReporteContainer = document.getElementById('fecha-reporte-container');
                DOM.reporteFechaInicio = document.getElementById('reporte-fecha-inicio');
                DOM.reporteFechaFin = document.getElementById('reporte-fecha-fin');
                DOM.generarReporteBtn = document.getElementById('generar-reporte-btn');
                DOM.reporteResultados = document.getElementById('reporte-resultados');
                DOM.reporteTitulo = document.getElementById('reporte-titulo');
                DOM.reporteMetadata = document.getElementById('reporte-metadata');
                DOM.reporteContenido = document.getElementById('reporte-contenido');
                DOM.exportarReporteBtn = document.getElementById('exportar-reporte-btn');
                DOM.imprimirReporteBtn = document.getElementById('imprimir-reporte-btn');

                // Alertas elements
                DOM.alertasBadge = document.getElementById('alertas-badge');
                DOM.alertasFilterTerminal = document.getElementById('alertas-filter-terminal');
                DOM.alertasFilterTipo = document.getElementById('alertas-filter-tipo');
                DOM.alertasFilterApply = document.getElementById('alertas-filter-apply');
                DOM.alertasCriticas = document.getElementById('alertas-criticas');
                DOM.alertasAdvertencias = document.getElementById('alertas-advertencias');
                DOM.alertasInformativas = document.getElementById('alertas-informativas');
                DOM.alertasContainer = document.getElementById('alertas-container');
                DOM.alertasPagination = document.getElementById('alertas-pagination');
                DOM.alertasShowing = document.getElementById('alertas-showing');
                DOM.alertasTotal = document.getElementById('alertas-total');
                DOM.alertasPrevPage = document.getElementById('alertas-prev-page');
                DOM.alertasNextPage = document.getElementById('alertas-next-page');
                DOM.alertasPageNumbers = document.getElementById('alertas-page-numbers');
                DOM.alertasExport = document.getElementById('alertas-export');

                // Configuración elements
                DOM.alertasConfigForm = document.getElementById('alertas-config-form');
                DOM.configAlertaVencimiento = document.getElementById('config-alerta-vencimiento');
                DOM.configRecordatorioInspeccion = document.getElementById('config-recordatorio-inspeccion');
                DOM.configNotificacionEmail = document.getElementById('config-notificacion-email');
                DOM.configNotificacionSistema = document.getElementById('config-notificacion-sistema');
                DOM.configEmailDestinatarios = document.getElementById('config-email-destinatarios');
                DOM.configFrecuenciaReporte = document.getElementById('config-frecuencia-reporte');
                DOM.themePreference = document.getElementsByName('theme-preference');
                DOM.dashboardDefault = document.getElementById('dashboard-default');
                DOM.rowsPerPage = document.getElementById('rows-per-page');
                DOM.resetPreferences = document.getElementById('reset-preferences');
                DOM.savePreferences = document.getElementById('save-preferences');

                // Modals
                DOM.detalleModal = document.getElementById('detalle-modal');
                DOM.modalTitle = document.getElementById('modal-title');
                DOM.modalContent = document.getElementById('modal-content');
                DOM.closeModalButton = document.getElementById('close-modal-button');
                DOM.closeModalButtonBottom = document.getElementById('close-modal-button-bottom');
                DOM.printModalButton = document.getElementById('print-modal-button');
                DOM.realtimeNotificationModal = document.getElementById('realtime-notification-modal');
                DOM.notificationTitle = document.getElementById('notification-title');
                DOM.notificationContent = document.getElementById('notification-content');
                DOM.notificationBus = document.getElementById('notification-bus');
                DOM.notificationTerminal = document.getElementById('notification-terminal');
                DOM.notificationEstado = document.getElementById('notification-estado');
                DOM.closeNotificationButton = document.getElementById('close-notification-button');
                DOM.notificationDismiss = document.getElementById('notification-dismiss');
                DOM.notificationView = document.getElementById('notification-view');
                DOM.infoPopupModal = document.getElementById('info-popup-modal');
                DOM.infoPopupTitle = document.getElementById('info-popup-title');
                DOM.infoPopupContent = document.getElementById('info-popup-content');
                DOM.infoPopupImage = document.getElementById('info-popup-image');
                DOM.closeInfoPopup = document.getElementById('close-info-popup');
                DOM.changeStatusModal = document.getElementById('change-status-modal');
                DOM.closeChangeStatusButton = document.getElementById('close-change-status-button');
                DOM.cancelChangeStatus = document.getElementById('cancel-change-status');
                DOM.confirmChangeStatus = document.getElementById('confirm-change-status');
                DOM.busAlreadyInspectedToast = document.getElementById('bus-already-inspected-toast');

                // Otros
                DOM.notificationContainer = document.getElementById('notification-container');
                DOM.mobileQuickAdd = document.getElementById('mobile-quick-add');
            }

            /**
             * Inicializa Supabase
             */
            function initSupabase() {
                if (SUPABASE_URL.includes('TU_SUPABASE_URL')) {
                    showNotification('ERROR: Configura credenciales Supabase', 'error');
                    return;
                }

                try {
                    if (!supabase || !supabase.createClient) throw new Error("Librería Supabase no cargó.");

                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log("Supabase client inicializado.");

                } catch (error) {
                    console.error("Error inicialización Supabase:", error);
                    showNotification(`Error crítico: ${error.message}`, 'error');

                    // Mostrar error en main content
                    const mainContent = document.querySelector('main');
                    if (mainContent) {
                        mainContent.innerHTML = `
                        <div class="m-4 p-6 card bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800">
                            <h3 class="text-lg font-semibold text-red-800 dark:text-red-300 mb-2">Error Crítico</h3>
                            <p class="text-red-700 dark:text-red-200">${error.message}</p>
                            <p class="mt-2 text-sm text-red-600 dark:text-red-300">Verifique la conexión a Supabase y recargue la página.</p>
                        </div>`;
                    }
                }
            }

            /**
             * Inicializa la interfaz de usuario
             */
            function initUI() {
                // Llenar selects de fecha
                populateMonthSelect();
                populateYearSelect();

                // Fecha actual para campos de fecha
                const today = new Date().toISOString().split('T')[0];
                if (DOM.fecha_inspeccion) DOM.fecha_inspeccion.value = today;
                if (DOM.fecha_inspeccion) DOM.fecha_inspeccion.max = today;

                // Ocultar campos de detalles extintor por defecto
                if (DOM.extintorDetailsContainer) DOM.extintorDetailsContainer.classList.add('hidden');
            }


            console.log("Intentando añadir listener a:", DOM.analisisFiltrarBtn);

            function setupEventListeners() {
                // Navegación
                if (DOM.navLinks) {
                    DOM.navLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            showView(link.dataset.view);
                        });
                    });
                }

                // Sidebar móvil
                if (DOM.menuButton && DOM.sidebar && DOM.sidebarOverlay) {
                    DOM.menuButton.addEventListener('click', () => {
                        DOM.sidebar.classList.toggle('open');
                        DOM.sidebarOverlay.classList.toggle('hidden');
                    });

                    DOM.sidebarOverlay.addEventListener('click', () => {
                        DOM.sidebar.classList.remove('open');
                        DOM.sidebarOverlay.classList.add('hidden');
                    });

                    DOM.sidebar.querySelectorAll('.nav-link').forEach(link => {
                        link.addEventListener('click', () => {
                            if (window.innerWidth < 1024) {
                                DOM.sidebar.classList.remove('open');
                                DOM.sidebarOverlay.classList.add('hidden');
                            }
                        });
                    });
                }

                // Modo oscuro
                if (DOM.themeToggle) {
                    DOM.themeToggle.addEventListener('click', toggleDarkMode);
                }

                // Formulario de registro
                if (DOM.registroForm) {
                    DOM.registroForm.addEventListener('submit', handleRegistroSubmit);
                }

                // Terminal
                if (DOM.terminalSelect) {
                    DOM.terminalSelect.addEventListener('change', (e) => {
                        const tid = e.target.value;
                        localStorage.setItem('lastTerminalId_extintor', tid);
                        loadBusesParaFormulario(tid);
                    });
                }

                // Búsqueda de bus
                if (DOM.numeroInternoInput) {
                    DOM.numeroInternoInput.addEventListener('input', (e) =>
                        findBusAndFill(e.target.value, 'numero_interno'));
                }

                if (DOM.ppuInput) {
                    DOM.ppuInput.addEventListener('input', (e) =>
                        findBusAndFill(e.target.value, 'ppu'));
                }

                // Historial Bus
                if (DOM.historialBusBtn) {
                    DOM.historialBusBtn.addEventListener('click', () => {
                        const ppuHidden = DOM.ppuHiddenInput;
                        if (ppuHidden && ppuHidden.value) {
                            openHistorialModal(ppuHidden.value);
                        }
                    });
                }

                // Crear nueva inspección / Usar datos anteriores
                if (DOM.createNewInspectionBtn) {
                    DOM.createNewInspectionBtn.addEventListener('click', () => {
                        if (DOM.busAlreadyChecked) {
                            DOM.busAlreadyChecked.classList.add('hidden');
                        }
                    });
                }

                if (DOM.usePreviousDataBtn) {
                    DOM.usePreviousDataBtn.addEventListener('click', fillFormWithPreviousData);
                }

                // Estado extintor (tiene/no tiene)
                if (DOM.extintorEstadoRadios) {
                    DOM.extintorEstadoRadios.forEach(radio => {
                        radio.addEventListener('change', handleExtintorEstadoChange);
                    });
                }

                // Upload imagen
                if (DOM.fotoExtintor) {
                    DOM.fotoExtintor.addEventListener('change', handleImageUpload);
                }

                if (DOM.removeImageBtn) {
                    DOM.removeImageBtn.addEventListener('click', removeUploadedImage);
                }

                // Filtros Lista
                if (DOM.advancedFiltersToggle) {
                    DOM.advancedFiltersToggle.addEventListener('click', toggleAdvancedFilters);
                }

                if (DOM.applyFiltersListaButton) {
                    DOM.applyFiltersListaButton.addEventListener('click', handleApplyFiltersLista);
                }

                // Exportar lista
                if (DOM.exportListaButton) {
                    DOM.exportListaButton.addEventListener('click', exportarListaExcel);
                }

                // Paginación lista
                if (DOM.paginationPrev) {
                    DOM.paginationPrev.addEventListener('click', () => {
                        if (listaCurrentPage > 1) {
                            loadInspecciones(getCurrentFiltersLista(), listaCurrentPage - 1);
                        }
                    });
                }

                if (DOM.paginationNext) {
                    DOM.paginationNext.addEventListener('click', () => {
                        if (listaCurrentPage < listaTotalPages) {
                            loadInspecciones(getCurrentFiltersLista(), listaCurrentPage + 1);
                        }
                    });
                }

                // Filtro flota
                if (DOM.flotaFilterTerminal) {
                    DOM.flotaFilterTerminal.addEventListener('change', handleApplyFiltersFlota);
                }

                // Paginación flota
                if (DOM.flotaPaginationPrev) {
                    DOM.flotaPaginationPrev.addEventListener('click', () => {
                        if (flotaCurrentPage > 1) {
                            loadFlotaStatus(getCurrentFiltersFlota(), flotaCurrentPage - 1);
                        }
                    });
                }

                if (DOM.flotaPaginationNext) {
                    DOM.flotaPaginationNext.addEventListener('click', () => {
                        if (flotaCurrentPage < flotaTotalPages) {
                            loadFlotaStatus(getCurrentFiltersFlota(), flotaCurrentPage + 1);
                        }
                    });
                }

                // Dashboard
                if (DOM.dashboardRefreshBtn) {
                    DOM.dashboardRefreshBtn.addEventListener('click', loadDashboardData);
                }

                if (DOM.dashboardFilterPeriodo) {
                    DOM.dashboardFilterPeriodo.addEventListener('change', loadDashboardData);
                }

                if (DOM.dashboardFilterTerminal) {
                    DOM.dashboardFilterTerminal.addEventListener('change', loadDashboardData);
                }

                // Reportes
                if (DOM.reporteTipoSelect) {
                    DOM.reporteTipoSelect.addEventListener('change', () => {
                        const showFechas = DOM.reporteTipoSelect.value === 'inspecciones_recientes';
                        if (DOM.fechaReporteContainer) {
                            DOM.fechaReporteContainer.classList.toggle('hidden', !showFechas);
                        }
                    });
                }

                if (DOM.generarReporteBtn) {
                    DOM.generarReporteBtn.addEventListener('click', generarReporte);
                }

                if (DOM.exportarReporteBtn) {
                    DOM.exportarReporteBtn.addEventListener('click', exportarReporteExcel);
                }

                if (DOM.imprimirReporteBtn) {
                    DOM.imprimirReporteBtn.addEventListener('click', imprimirReporte);
                }

                // Análisis
                if (DOM.analisisPeriodo) {
                    DOM.analisisPeriodo.addEventListener('change', () => {
                        const isPeriodoPersonalizado = DOM.analisisPeriodo.value === 'personalizado';
                        if (DOM.fechaInicioContainer && DOM.fechaFinContainer) {
                            DOM.fechaInicioContainer.classList.toggle('hidden', !isPeriodoPersonalizado);
                            DOM.fechaFinContainer.classList.toggle('hidden', !isPeriodoPersonalizado);
                        }
                    });
                }

                // Alertas
                if (DOM.alertasFilterApply) {
                    DOM.alertasFilterApply.addEventListener('click', () => {
                        loadAlertas(getCurrentFiltersAlertas(), 1);
                    });
                }

                // Paginación alertas
                if (DOM.alertasPrevPage) {
                    DOM.alertasPrevPage.addEventListener('click', () => {
                        if (alertasCurrentPage > 1) {
                            loadAlertas(getCurrentFiltersAlertas(), alertasCurrentPage - 1);
                        }
                    });
                }

                if (DOM.alertasNextPage) {
                    DOM.alertasNextPage.addEventListener('click', () => {
                        if (alertasCurrentPage < alertasTotalPages) {
                            loadAlertas(getCurrentFiltersAlertas(), alertasCurrentPage + 1);
                        }
                    });
                }

                // Exportar alertas
                if (DOM.alertasExport) {
                    DOM.alertasExport.addEventListener('click', () => {
                        showNotification('Exportación de alertas en desarrollo', 'info');
                    });
                }

                // Configuración
                if (DOM.alertasConfigForm) {
                    DOM.alertasConfigForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        showNotification('Configuración guardada correctamente', 'success');
                    });
                }

                if (DOM.savePreferences) {
                    DOM.savePreferences.addEventListener('click', () => {
                        showNotification('Preferencias guardadas correctamente', 'success');
                    });
                }

                if (DOM.resetPreferences) {
                    DOM.resetPreferences.addEventListener('click', () => {
                        showNotification('Preferencias restablecidas', 'info');
                    });
                }

                // Modales
                if (DOM.closeModalButton && DOM.detalleModal) {
                    DOM.closeModalButton.addEventListener('click', () => {
                        closeModal(DOM.detalleModal);
                    });
                }

                if (DOM.closeModalButtonBottom && DOM.detalleModal) {
                    DOM.closeModalButtonBottom.addEventListener('click', () => {
                        closeModal(DOM.detalleModal);
                    });
                }

                if (DOM.detalleModal) {
                    DOM.detalleModal.addEventListener('click', (event) => {
                        if (event.target === DOM.detalleModal) {
                            closeModal(DOM.detalleModal);
                        }
                    });
                }

                if (DOM.printModalButton) {
                    DOM.printModalButton.addEventListener('click', () => {
                        window.print();
                    });
                }

                // Modal notificación tiempo real
                if (DOM.closeNotificationButton && DOM.realtimeNotificationModal) {
                    DOM.closeNotificationButton.addEventListener('click', () => {
                        closeModal(DOM.realtimeNotificationModal);
                    });
                }

                if (DOM.notificationDismiss && DOM.realtimeNotificationModal) {
                    DOM.notificationDismiss.addEventListener('click', () => {
                        closeModal(DOM.realtimeNotificationModal);
                    });
                }

                if (DOM.notificationView && DOM.realtimeNotificationModal) {
                    DOM.notificationView.addEventListener('click', () => {
                        closeModal(DOM.realtimeNotificationModal);
                        if (DOM.notificationBus) {
                            const busPPU = DOM.notificationBus.textContent;
                            if (busPPU) {
                                openHistorialModal(busPPU);
                            }
                        }
                    });
                }

                // Modal info popup
                if (DOM.closeInfoPopup && DOM.infoPopupModal) {
                    DOM.closeInfoPopup.addEventListener('click', () => {
                        DOM.infoPopupModal.classList.add('hidden');
                    });
                }

                if (DOM.infoPopupModal) {
                    DOM.infoPopupModal.addEventListener('click', (e) => {
                        if (e.target === DOM.infoPopupModal) {
                            DOM.infoPopupModal.classList.add('hidden');
                        }
                    });
                }

                // Modal cambio estado
                if (DOM.closeChangeStatusButton && DOM.changeStatusModal) {
                    DOM.closeChangeStatusButton.addEventListener('click', () => {
                        closeModal(DOM.changeStatusModal);
                    });
                }

                if (DOM.cancelChangeStatus && DOM.changeStatusModal) {
                    DOM.cancelChangeStatus.addEventListener('click', () => {
                        closeModal(DOM.changeStatusModal);
                    });
                }

                // Notificaciones/alertas header
                if (DOM.notificationsMenuButton && DOM.notificationsDropdown) {
                    DOM.notificationsMenuButton.addEventListener('click', () => {
                        DOM.notificationsDropdown.classList.toggle('hidden');
                    });

                    // Cerrar al hacer clic fuera
                    document.addEventListener('click', (e) => {
                        if (!DOM.notificationsMenuButton.contains(e.target) &&
                            !DOM.notificationsDropdown.contains(e.target)) {
                            DOM.notificationsDropdown.classList.add('hidden');
                        }
                    });
                }

                // Acciones rápidas
                if (DOM.quickActionsButton && DOM.quickActionsDropdown) {
                    DOM.quickActionsButton.addEventListener('click', () => {
                        DOM.quickActionsDropdown.classList.toggle('hidden');
                    });

                    // Cerrar al hacer clic fuera
                    document.addEventListener('click', (e) => {
                        if (!DOM.quickActionsButton.contains(e.target) &&
                            !DOM.quickActionsDropdown.contains(e.target)) {
                            DOM.quickActionsDropdown.classList.add('hidden');
                        }
                    });

                    // Acciones del dropdown
                    const quickActions = DOM.quickActionsDropdown.querySelectorAll('[data-action]');
                    quickActions.forEach(action => {
                        action.addEventListener('click', (e) => {
                            e.preventDefault();
                            DOM.quickActionsDropdown.classList.add('hidden');

                            switch (action.dataset.action) {
                                case 'nueva-inspeccion':
                                    showView('registrar');
                                    break;
                                case 'generar-reporte':
                                    showView('reportes');
                                    break;
                                case 'ver-alertas':
                                    showView('alertas');
                                    break;
                                case 'exportar-excel':
                                    if (currentView === 'lista') {
                                        exportarListaExcel();
                                    } else {
                                        showView('lista');
                                        setTimeout(() => {
                                            showNotification('Para exportar, primero filtre los datos y luego use el botón "Exportar"', 'info');
                                        }, 500);
                                    }
                                    break;
                            }
                        });
                    });
                }

                // Móvil: botón flotante para nueva inspección
                if (DOM.mobileQuickAdd) {
                    DOM.mobileQuickAdd.addEventListener('click', () => {
                        showView('registrar');
                    });
                }

                // Listener para enlaces goto-register (para alertas)
                document.body.addEventListener('click', (e) => {
                    const gotoRegisterBtn = e.target.closest('.goto-register-button');
                    if (gotoRegisterBtn) {
                        e.preventDefault();
                        const view = gotoRegisterBtn.dataset.view;
                        const ppu = gotoRegisterBtn.dataset.ppu;

                        showView(view);

                        // Auto-llenar si hay ppu
                        if (ppu && DOM.ppuInput) {
                            setTimeout(() => {
                                DOM.ppuInput.value = ppu;
                                findBusAndFill(ppu, 'ppu');
                            }, 300);
                        }
                    }
                });

                // Listener delegado para detalles e info popups
                document.body.addEventListener('click', (event) => {
                // Ver historial (desde lista)
                const viewHistButton = event.target.closest('.view-details-button');
                if (viewHistButton) {
                    const ppu = viewHistButton.getAttribute('data-ppu');
                    if (ppu) {
                        openHistorialModal(ppu);
                        return; // Detener si fue botón de historial
                    }
                }

                // Ver detalles (desde flota) - ¡CORREGIDO!
                const flotaDetailsButton = event.target.closest('.flota-details-button');
                if (flotaDetailsButton) {
                    const index = flotaDetailsButton.getAttribute('data-index');
                    // Convertir índice a número y validar
                    const dataIndex = parseInt(index, 10); 
                    if (!isNaN(dataIndex) && flotaData && flotaData[dataIndex]) {
                        openFlotaDetalleModal(flotaData[dataIndex]); // Llamar a la función correcta
                        return; // Detener si fue botón de detalles de flota
                    } else {
                        console.error(`Error: No se encontraron datos para el índice ${index} en flotaData.`);
                        showNotification('Error al cargar detalles del bus.', 'error');
                    }
                }

                // Info popups (Lógica existente)
                const infoIcon = event.target.closest('.info-icon');
                if (infoIcon) {
                    const itemId = infoIcon.parentElement.getAttribute('data-info-id');
                    if (itemId) {
                        showInfoPopup(itemId);
                    }
                }

                // Botón para ir a registrar (Lógica existente)
                const gotoRegisterBtn = event.target.closest('.goto-register-button');
                if (gotoRegisterBtn) {
                    event.preventDefault();
                    const view = gotoRegisterBtn.dataset.view;
                    const ppu = gotoRegisterBtn.dataset.ppu;

                    showView(view);

                    // Auto-llenar si hay ppu
                    if (ppu && DOM.ppuInput) {
                        setTimeout(() => {
                            DOM.ppuInput.value = ppu;
                            findBusAndFill(ppu, 'ppu');
                        }, 300);
                    }
                }
            });

            }

            // Inicio de la aplicación
        </script>

        <script>
                        /**
             * Obtiene los filtros seleccionados en la sección de Análisis Avanzado.
             * Calcula las fechas de inicio y fin si se selecciona un período predefinido.
             * @returns {Object} Objeto con los filtros: { periodo, terminalId, fechaInicio, fechaFin }
             */
             function getCurrentFiltersAnalisis() {
                const periodo = DOM.analisisPeriodo?.value || 'ultimo-mes';
                const terminalId = DOM.analisisTerminal?.value || '';
                let fechaInicio = DOM.analisisFechaInicio?.value || null;
                let fechaFin = DOM.analisisFechaFin?.value || null;

                // Calcula fechas si no es personalizado
                if (periodo !== 'personalizado') {
                    const hoy = luxon.DateTime.now();
                    switch (periodo) {
                        case 'ultimo-mes':
                            fechaInicio = hoy.minus({ months: 1 }).startOf('day').toISODate();
                            fechaFin = hoy.endOf('day').toISODate();
                            break;
                        case 'ultimo-trimestre':
                            fechaInicio = hoy.minus({ months: 3 }).startOf('day').toISODate();
                            fechaFin = hoy.endOf('day').toISODate();
                            break;
                        case 'ultimo-semestre':
                            fechaInicio = hoy.minus({ months: 6 }).startOf('day').toISODate();
                            fechaFin = hoy.endOf('day').toISODate();
                            break;
                        case 'ultimo-ano':
                            fechaInicio = hoy.minus({ years: 1 }).startOf('day').toISODate();
                            fechaFin = hoy.endOf('day').toISODate();
                            break;
                    }
                    // Actualizar campos de fecha en UI para reflejar el período
                    if (DOM.analisisFechaInicio) DOM.analisisFechaInicio.value = fechaInicio;
                    if (DOM.analisisFechaFin) DOM.analisisFechaFin.value = fechaFin;

                } else {
                    // Si es personalizado pero no hay fechas, usar último mes por defecto
                    if (!fechaInicio || !fechaFin) {
                        const hoy = luxon.DateTime.now();
                        fechaInicio = fechaInicio || hoy.minus({ months: 1 }).startOf('day').toISODate();
                        fechaFin = fechaFin || hoy.endOf('day').toISODate();
                        if (DOM.analisisFechaInicio) DOM.analisisFechaInicio.value = fechaInicio;
                        if (DOM.analisisFechaFin) DOM.analisisFechaFin.value = fechaFin;
                    }
                }

                // Asegurarse de que las fechas tengan el formato correcto para Supabase (YYYY-MM-DD)
                // y añadir la hora para cubrir el día completo si es necesario.
                const fechaInicioISO = fechaInicio ? luxon.DateTime.fromISO(fechaInicio).startOf('day').toISO() : null;
                const fechaFinISO = fechaFin ? luxon.DateTime.fromISO(fechaFin).endOf('day').toISO() : null;


                return { periodo, terminalId, fechaInicio: fechaInicioISO, fechaFin: fechaFinISO };
            }

            /**
             * Función principal que se ejecuta al hacer clic en "Generar Análisis".
             * Obtiene filtros, consulta datos reales de Supabase y actualiza la UI.
             */
            async function generarAnalisisAvanzado() {
                console.log("Generando análisis con datos REALES...");

                if (!DOM.analisisFiltrarBtn || !supabaseClient) {
                    showNotification('Error: No se puede generar el análisis. Faltan componentes.', 'error');
                    return;
                }

                showNotification('Generando análisis...', 'info');
                DOM.analisisFiltrarBtn.disabled = true;
                DOM.analisisFiltrarBtn.innerHTML = '<div class="loading-spinner mr-2" style="width: 1rem; height: 1rem; border-width: 2px; display: inline-block;"></div> Generando...';
                if (DOM.exportAnalisisTerminal) DOM.exportAnalisisTerminal.disabled = true;

                if (DOM.analisisTerminalBody) DOM.analisisTerminalBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Generando datos...</td></tr>';
                resetAnalisisCharts();

                try {
                    const filters = getCurrentFiltersAnalisis();
                    console.log("Filtros aplicados para Supabase:", filters);

                    // --- OBTENER DATOS REALES DE SUPABASE ---
                    const [complianceData, tendenciaData, necesidadesData, vencimientosData, terminalAnalysisData] = await Promise.all([
                        fetchComplianceData(filters.fechaInicio, filters.fechaFin, filters.terminalId),
                        fetchTendenciaInspecciones(filters.fechaInicio, filters.fechaFin, filters.terminalId),
                        fetchNecesidadesTipo(filters.fechaInicio, filters.fechaFin, filters.terminalId),
                        fetchVencimientosProyectados(filters.terminalId), // Vencimientos pueden no depender de fecha de inspección
                        fetchAnalisisPorTerminal(filters.fechaInicio, filters.fechaFin, filters.terminalId)
                    ]);

                    console.log("Datos REALES obtenidos:", { complianceData, tendenciaData, necesidadesData, vencimientosData, terminalAnalysisData });

                    // --- ACTUALIZAR UI CON DATOS REALES ---
                    updateComplianceGauge(complianceData);
                    updateTendenciaChart(tendenciaData);
                    updateNecesidadesChart(necesidadesData);
                    updateVencimientosChart(vencimientosData);
                    populateAnalisisTerminalTable(terminalAnalysisData);

                    showNotification('Análisis generado con éxito.', 'success');
                    if (DOM.exportAnalisisTerminal) DOM.exportAnalisisTerminal.disabled = false;

                } catch (error) {
                    console.error("Error al generar análisis avanzado:", error);
                    showNotification(`Error al generar análisis: ${error.message}`, 'error');
                    if (DOM.analisisTerminalBody) DOM.analisisTerminalBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Error al cargar datos: ${error.message}</td></tr>`;
                } finally {
                    DOM.analisisFiltrarBtn.disabled = false;
                    DOM.analisisFiltrarBtn.textContent = 'Generar Análisis';
                }
            }

            /**
             * Resetea los gráficos de la sección de análisis a un estado inicial o de carga.
             */
            function resetAnalisisCharts() {
                // Gauge Cumplimiento
                if (chartInstances.complianceGauge) {
                    chartInstances.complianceGauge.updateSeries([0]);
                    chartInstances.complianceGauge.updateOptions({ colors: ['#9ca3af'] }); // Color gris por defecto
                } else if (DOM.gaugeCompliance) {
                    const options = {
                        chart: { type: 'radialBar', height: '100%' }, series: [0],
                        plotOptions: { radialBar: { hollow: { size: '65%' }, dataLabels: { show: false } } },
                        labels: ['Cumplimiento'], colors: ['#9ca3af'], stroke: { lineCap: "round" },
                    };
                    chartInstances.complianceGauge = new ApexCharts(DOM.gaugeCompliance, options);
                    chartInstances.complianceGauge.render();
                }
                if (DOM.complianceValue) DOM.complianceValue.textContent = '--%';

                // Tendencia Inspecciones (Chart.js)
                if (chartInstances.inspeccionTendencia) {
                    chartInstances.inspeccionTendencia.data.labels = [];
                    chartInstances.inspeccionTendencia.data.datasets[0].data = [];
                    chartInstances.inspeccionTendencia.update();
                } else if (DOM.inspeccionTendenciaChart) {
                    const ctx = DOM.inspeccionTendenciaChart.getContext('2d');
                    chartInstances.inspeccionTendencia = new Chart(ctx, {
                        type: 'line', data: { labels: [], datasets: [{ label: 'Inspecciones', data: [] }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                    });
                }

                // Necesidades por Tipo (Chart.js)
                if (chartInstances.necesidadesTipo) {
                    chartInstances.necesidadesTipo.data.labels = ['Compra', 'Mantención'];
                    chartInstances.necesidadesTipo.data.datasets[0].data = [0, 0];
                    chartInstances.necesidadesTipo.update();
                } else if (DOM.necesidadesTipoChart) {
                    const ctx = DOM.necesidadesTipoChart.getContext('2d');
                    chartInstances.necesidadesTipo = new Chart(ctx, {
                        type: 'pie', data: { labels: ['Compra', 'Mantención'], datasets: [{ data: [0, 0] }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                    });
                }

                // Vencimientos Proyectados (Chart.js)
                if (chartInstances.vencimientosProyectados) {
                    chartInstances.vencimientosProyectados.data.labels = [];
                    chartInstances.vencimientosProyectados.data.datasets[0].data = [];
                    chartInstances.vencimientosProyectados.update();
                } else if (DOM.vencimientosProyectadosChart) {
                    const ctx = DOM.vencimientosProyectadosChart.getContext('2d');
                    chartInstances.vencimientosProyectados = new Chart(ctx, {
                        type: 'bar', data: { labels: [], datasets: [{ label: 'Vencimientos', data: [] }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                    });
                }
            }

            // --- FUNCIONES fetch... CON LÓGICA SUPABASE (REALES) ---

            /**
             * Obtiene datos de cumplimiento (OK vs Total) desde Supabase.
             * @param {string} fechaInicio - Fecha inicio ISO
             * @param {string} fechaFin - Fecha fin ISO
             * @param {string} terminalId - ID del terminal (opcional)
             * @returns {Promise<Object>} - { ok, total }
             */
            async function fetchComplianceData(fechaInicio, fechaFin, terminalId) {
                console.log(`fetchComplianceData: ${fechaInicio}, ${fechaFin}, ${terminalId}`);
                if (!supabaseClient) throw new Error("Supabase no inicializado");

                // Usaremos la vista que ya calcula el estado
                let query = supabaseClient
                    .from('CatastroExtintor_vista_necesidades')
                    .select('requiere_compra, requiere_mantencion', { count: 'exact' });

                // Aplicar filtros de fecha (sobre fecha_inspeccion)
                if (fechaInicio) query = query.gte('fecha_inspeccion', fechaInicio);
                if (fechaFin) query = query.lte('fecha_inspeccion', fechaFin);

                // Aplicar filtro de terminal
                if (terminalId) query = query.eq('terminal_id', terminalId);

                const { data, error, count } = await query;

                if (error) {
                    console.error("Error en fetchComplianceData:", error);
                    throw error;
                }

                const total = count || 0;
                // OK = No requiere compra NI mantención
                const ok = data ? data.filter(item => !item.requiere_compra && !item.requiere_mantencion).length : 0;

                return { ok, total };
            }

            /**
             * Obtiene datos para el gráfico de tendencia de inspecciones.
             * @param {string} fechaInicio - Fecha inicio ISO
             * @param {string} fechaFin - Fecha fin ISO
             * @param {string} terminalId - ID del terminal (opcional)
             * @returns {Promise<Object>} - { labels, data }
             */
            async function fetchTendenciaInspecciones(fechaInicio, fechaFin, terminalId) {
                console.log(`fetchTendenciaInspecciones: ${fechaInicio}, ${fechaFin}, ${terminalId}`);
                if (!supabaseClient) throw new Error("Supabase no inicializado");

                // Determinar el intervalo (día, semana, mes) basado en el rango de fechas
                const start = luxon.DateTime.fromISO(fechaInicio);
                const end = luxon.DateTime.fromISO(fechaFin);
                const diffDays = end.diff(start, 'days').days;

                let groupByFormat, timeUnit;
                if (diffDays <= 31) { // Agrupar por día si es un mes o menos
                    groupByFormat = 'YYYY-MM-DD';
                    timeUnit = 'day';
                } else if (diffDays <= 180) { // Agrupar por semana si es hasta 6 meses
                    groupByFormat = 'YYYY-WW'; // WW es semana del año
                    timeUnit = 'week';
                } else { // Agrupar por mes para rangos más largos
                    groupByFormat = 'YYYY-MM';
                    timeUnit = 'month';
                }

                // Consulta para contar inspecciones agrupadas por el formato de fecha
                // Nota: Supabase no tiene date_trunc directo en JS client, se hace post-procesamiento
                let query = supabaseClient
                    .from('CatastroExtintor_inspecciones')
                    .select('fecha_inspeccion, bus:CatastroExtintor_buses!inner(terminal_id)')
                    .order('fecha_inspeccion');

                if (fechaInicio) query = query.gte('fecha_inspeccion', fechaInicio);
                if (fechaFin) query = query.lte('fecha_inspeccion', fechaFin);
                if (terminalId) query = query.eq('bus.terminal_id', terminalId);

                const { data, error } = await query;

                if (error) {
                    console.error("Error en fetchTendenciaInspecciones:", error);
                    throw error;
                }

                // Agrupar resultados en JavaScript
                const counts = {};
                data.forEach(item => {
                    const date = luxon.DateTime.fromISO(item.fecha_inspeccion);
                    let key;
                    if (timeUnit === 'day') key = date.toISODate();
                    else if (timeUnit === 'week') key = `${date.year}-W${String(date.weekNumber).padStart(2, '0')}`;
                    else key = `${date.year}-${String(date.month).padStart(2, '0')}`; // YYYY-MM

                    counts[key] = (counts[key] || 0) + 1;
                });

                // Ordenar keys (fechas/semanas/meses)
                const sortedKeys = Object.keys(counts).sort();

                // Formatear etiquetas para el gráfico
                const labels = sortedKeys.map(key => {
                    if (timeUnit === 'day') return luxon.DateTime.fromISO(key).toFormat('dd/MM');
                    if (timeUnit === 'week') return key; // Mantener YYYY-Www
                    if (timeUnit === 'month') return luxon.DateTime.fromISO(key + '-01').toFormat('MMM yyyy');
                    return key;
                });
                const chartData = sortedKeys.map(key => counts[key]);

                return { labels, data: chartData };
            }


            /**
             * Obtiene datos para el gráfico de necesidades (Compra vs Mantención).
             * @param {string} fechaInicio - Fecha inicio ISO
             * @param {string} fechaFin - Fecha fin ISO
             * @param {string} terminalId - ID del terminal (opcional)
             * @returns {Promise<Object>} - { compra, mantencion }
             */
            async function fetchNecesidadesTipo(fechaInicio, fechaFin, terminalId) {
                console.log(`fetchNecesidadesTipo: ${fechaInicio}, ${fechaFin}, ${terminalId}`);
                if (!supabaseClient) throw new Error("Supabase no inicializado");

                // Usar la vista que ya calcula las necesidades
                let query = supabaseClient
                    .from('CatastroExtintor_vista_necesidades')
                    .select('requiere_compra, requiere_mantencion');

                if (fechaInicio) query = query.gte('fecha_inspeccion', fechaInicio);
                if (fechaFin) query = query.lte('fecha_inspeccion', fechaFin);
                if (terminalId) query = query.eq('terminal_id', terminalId);

                // Solo contar los que tienen alguna necesidad
                query = query.or('requiere_compra.eq.true,requiere_mantencion.eq.true');

                const { data, error } = await query;

                if (error) {
                    console.error("Error en fetchNecesidadesTipo:", error);
                    throw error;
                }

                const compra = data ? data.filter(item => item.requiere_compra).length : 0;
                // Mantención = requiere mantención PERO NO requiere compra
                const mantencion = data ? data.filter(item => item.requiere_mantencion && !item.requiere_compra).length : 0;

                return { compra, mantencion };
            }

            /**
             * Obtiene datos para el gráfico de vencimientos proyectados.
             * @param {string} terminalId - ID del terminal (opcional)
             * @returns {Promise<Object>} - { labels, data }
             */
            async function fetchVencimientosProyectados(terminalId) {
                console.log(`fetchVencimientosProyectados: ${terminalId}`);
                if (!supabaseClient) throw new Error("Supabase no inicializado");

                // Obtener los próximos 6 meses
                const labels = [];
                const hoy = luxon.DateTime.now();
                for (let i = 0; i < 6; i++) {
                    labels.push(hoy.plus({ months: i }).toFormat('MMM yyyy'));
                }

                // Consultar extintores con fecha de vencimiento
                let query = supabaseClient
                    .from('CatastroExtintor_inspecciones')
                    .select('vencimiento_mes, vencimiento_ano, bus:CatastroExtintor_buses!inner(terminal_id)')
                    .eq('extintor_estado', 'Tiene')
                    .not('vencimiento_mes', 'is', null)
                    .not('vencimiento_ano', 'is', null);

                if (terminalId) query = query.eq('bus.terminal_id', terminalId);

                // Filtrar por vencimientos futuros (hasta 6 meses en el futuro)
                const limitDate = hoy.plus({ months: 6 }).endOf('month');
                query = query.gte('vencimiento_ano', hoy.year); // Año actual o futuro
                // Podríamos hacer un filtro más complejo aquí si Supabase lo permitiera fácilmente
                // Por ahora, filtramos en JS

                const { data, error } = await query;

                if (error) {
                    console.error("Error en fetchVencimientosProyectados:", error);
                    throw error;
                }

                // Contar vencimientos por mes
                const counts = {};
                labels.forEach(label => counts[label] = 0); // Inicializar contadores

                data.forEach(item => {
                    const venceDate = luxon.DateTime.fromObject({ year: item.vencimiento_ano, month: item.vencimiento_mes });
                    if (venceDate >= hoy && venceDate <= limitDate) {
                        const monthLabel = venceDate.toFormat('MMM yyyy');
                        if (counts.hasOwnProperty(monthLabel)) {
                            counts[monthLabel]++;
                        }
                    }
                });

                const chartData = labels.map(label => counts[label]);

                return { labels, data: chartData };
            }

            /**
             * Obtiene datos para la tabla de análisis por terminal.
             * @param {string} fechaInicio - Fecha inicio ISO
             * @param {string} fechaFin - Fecha fin ISO
             * @param {string} terminalId - ID del terminal (opcional, si no se provee, agrupa todos)
             * @returns {Promise<Array>} - Array de objetos { nombre, totalBuses, extintoresOk, mantencion, compra, cumplimiento }
             */
            async function fetchAnalisisPorTerminal(fechaInicio, fechaFin, terminalId) {
                console.log(`fetchAnalisisPorTerminal: ${fechaInicio}, ${fechaFin}, ${terminalId}`);
                if (!supabaseClient) throw new Error("Supabase no inicializado");

                // Usar la vista que calcula el estado
                let query = supabaseClient
                    .from('CatastroExtintor_vista_necesidades')
                    .select('terminal_id, terminal_nombre, requiere_compra, requiere_mantencion');

                if (fechaInicio) query = query.gte('fecha_inspeccion', fechaInicio);
                if (fechaFin) query = query.lte('fecha_inspeccion', fechaFin);
                if (terminalId) query = query.eq('terminal_id', terminalId);

                const { data, error } = await query;

                if (error) {
                    console.error("Error en fetchAnalisisPorTerminal:", error);
                    throw error;
                }

                // Agrupar por terminal
                const terminalStats = {};

                data.forEach(item => {
                    const termId = item.terminal_id;
                    const termNombre = item.terminal_nombre || `Terminal ID ${termId}` || 'Desconocido';

                    if (!terminalStats[termId]) {
                        terminalStats[termId] = {
                            nombre: termNombre,
                            totalBuses: 0,
                            extintoresOk: 0,
                            mantencion: 0,
                            compra: 0
                        };
                    }

                    terminalStats[termId].totalBuses++;

                    if (item.requiere_compra) {
                        terminalStats[termId].compra++;
                    } else if (item.requiere_mantencion) {
                        terminalStats[termId].mantencion++;
                    } else {
                        terminalStats[termId].extintoresOk++;
                    }
                });

                // Calcular cumplimiento y formatear salida
                const result = Object.values(terminalStats).map(stats => {
                    const cumplimiento = stats.totalBuses > 0
                        ? Math.round((stats.extintoresOk / stats.totalBuses) * 100)
                        : 0;
                    return { ...stats, cumplimiento };
                }).sort((a, b) => a.nombre.localeCompare(b.nombre)); // Ordenar por nombre de terminal

                return result;
            }

            // --- FUNCIONES update... Y populate... (REALES) ---

            function updateComplianceGauge(data) {
                if (!data || !DOM.gaugeCompliance || !DOM.complianceValue) return;
                // Asegurarse que data.ok y data.total son números
                const okCount = typeof data.ok === 'number' ? data.ok : 0;
                const totalCount = typeof data.total === 'number' ? data.total : 0;

                const complianceRate = totalCount > 0 ? Math.round((okCount / totalCount) * 100) : 0;

                let color;
                if (complianceRate >= 80) {
                    color = getComputedStyle(document.documentElement).getPropertyValue('--color-success').trim() || '#10b981';
                } else if (complianceRate >= 50) {
                    color = getComputedStyle(document.documentElement).getPropertyValue('--color-warning').trim() || '#f59e0b';
                } else {
                    color = getComputedStyle(document.documentElement).getPropertyValue('--color-danger').trim() || '#ef4444';
                }

                if (chartInstances.complianceGauge) {
                    chartInstances.complianceGauge.updateSeries([complianceRate]);
                    chartInstances.complianceGauge.updateOptions({ colors: [color] });
                } else {
                    const options = {
                        chart: { type: 'radialBar', height: '100%' }, series: [complianceRate],
                        plotOptions: { radialBar: { hollow: { size: '65%' }, dataLabels: { show: false } } },
                        labels: ['Cumplimiento'], colors: [color], stroke: { lineCap: "round" },
                    };
                    chartInstances.complianceGauge = new ApexCharts(DOM.gaugeCompliance, options);
                    chartInstances.complianceGauge.render();
                }
                DOM.complianceValue.textContent = `${complianceRate}%`;
                DOM.complianceValue.style.color = color;
                console.log(`Actualizando Gauge Cumplimiento REAL: ${complianceRate}%`);
            }

            function updateTendenciaChart(data) {
                if (!data || !DOM.inspeccionTendenciaChart) return;
                const ctx = DOM.inspeccionTendenciaChart.getContext('2d');
                const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim() || '#2563eb';
                const primaryColorLight = `${primaryColor}33`; // ~20% opacity

                if (chartInstances.inspeccionTendencia) {
                    chartInstances.inspeccionTendencia.data.labels = data.labels;
                    chartInstances.inspeccionTendencia.data.datasets[0].data = data.data;
                    chartInstances.inspeccionTendencia.data.datasets[0].borderColor = primaryColor;
                    chartInstances.inspeccionTendencia.data.datasets[0].backgroundColor = primaryColorLight;
                    chartInstances.inspeccionTendencia.data.datasets[0].pointBackgroundColor = primaryColor;
                    chartInstances.inspeccionTendencia.update();
                } else {
                    chartInstances.inspeccionTendencia = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                label: 'Inspecciones',
                                data: data.data,
                                borderColor: primaryColor,
                                backgroundColor: primaryColorLight,
                                fill: true,
                                tension: 0.3, // Curva suave
                                pointRadius: 3,
                                pointBackgroundColor: primaryColor,
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, // Asegura números enteros en el eje Y
                            plugins: { legend: { display: false } } // Oculta la leyenda
                        }
                    });
                }
                console.log("Actualizando Gráfico Tendencia Inspecciones");
            }

            function updateNecesidadesChart(data) {
                if (!data || !DOM.necesidadesTipoChart) return;
                const ctx = DOM.necesidadesTipoChart.getContext('2d');
                const chartData = [data.compra, data.mantencion];
                const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--color-danger').trim() || '#ef4444';
                const warningColor = getComputedStyle(document.documentElement).getPropertyValue('--color-warning').trim() || '#f59e0b';

                if (chartInstances.necesidadesTipo) {
                    chartInstances.necesidadesTipo.data.datasets[0].data = chartData;
                    chartInstances.necesidadesTipo.data.datasets[0].backgroundColor = [dangerColor, warningColor];
                    chartInstances.necesidadesTipo.update();
                } else {
                    chartInstances.necesidadesTipo = new Chart(ctx, {
                        type: 'pie', // O 'doughnut' si prefieres con hueco
                        data: {
                            labels: ['Compra', 'Mantención'],
                            datasets: [{
                                data: chartData,
                                backgroundColor: [dangerColor, warningColor],
                                hoverOffset: 4 // Efecto al pasar el mouse
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom', // Leyenda abajo
                                    labels: { padding: 15 }
                                }
                            }
                        }
                    });
                }
                console.log("Actualizando Gráfico Necesidades por Tipo");
            }

            function updateVencimientosChart(data) {
                if (!data || !DOM.vencimientosProyectadosChart) return;
                const ctx = DOM.vencimientosProyectadosChart.getContext('2d');
                const secondaryColor = getComputedStyle(document.documentElement).getPropertyValue('--color-secondary').trim() || '#6366f1';

                if (chartInstances.vencimientosProyectados) {
                    chartInstances.vencimientosProyectados.data.labels = data.labels;
                    chartInstances.vencimientosProyectados.data.datasets[0].data = data.data;
                    chartInstances.vencimientosProyectados.data.datasets[0].backgroundColor = secondaryColor;
                    chartInstances.vencimientosProyectados.update();
                } else {
                    chartInstances.vencimientosProyectados = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                label: 'Vencimientos',
                                data: data.data,
                                backgroundColor: secondaryColor,
                                borderRadius: 4, // Bordes redondeados
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, // Eje Y empieza en 0 y con enteros
                            plugins: { legend: { display: false } } // Oculta leyenda
                        }
                    });
                }
                console.log("Actualizando Gráfico Vencimientos Proyectados");
            }

            function populateAnalisisTerminalTable(data) {
                if (!data || !DOM.analisisTerminalBody) return;

                if (data.length === 0) {
                    DOM.analisisTerminalBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No hay datos para los filtros seleccionados.</td></tr>';
                    return;
                }

                DOM.analisisTerminalBody.innerHTML = ''; // Limpiar tabla
                data.forEach(terminal => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700'; // Efecto hover

                    // Determinar color para cumplimiento
                    let complianceClass = '';
                    if (terminal.cumplimiento >= 80) {
                        complianceClass = 'text-green-600 dark:text-green-400';
                    } else if (terminal.cumplimiento >= 50) {
                        complianceClass = 'text-amber-600 dark:text-amber-400';
                    } else {
                        complianceClass = 'text-red-600 dark:text-red-400';
                    }

                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${terminal.nombre}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${terminal.totalBuses}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-green-600 dark:text-green-400">${terminal.extintoresOk}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-amber-600 dark:text-amber-400">${terminal.mantencion}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-red-600 dark:text-red-400">${terminal.compra}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center font-medium ${complianceClass}">${terminal.cumplimiento}%</td>
                    `;
                    DOM.analisisTerminalBody.appendChild(tr);
                });
                console.log("Actualizando Tabla Análisis por Terminal");
            }

        </script>
</body>

</html>
